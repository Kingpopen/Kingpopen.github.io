<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>hexo å›¾ç‰‡åŠ è½½ä¸èƒ½æ­£å¸¸æ˜¾ç¤º</title>
      <link href="/2022/05/27/hexo-tu-pian-jia-zai-bu-neng-zheng-chang-xian-shi/"/>
      <url>/2022/05/27/hexo-tu-pian-jia-zai-bu-neng-zheng-chang-xian-shi/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>æœ€è¿‘åœ¨ä½¿ç”¨hexo + materyä¸»é¢˜æ¥æ­å»ºè‡ªå·±çš„åšå®¢ï¼Œè®°å½•ä¸€ä¸‹å‡ºç°çš„é—®é¢˜ã€‚</p><p>hexoçš„materyä¸»é¢˜é“¾æ¥ï¼š<a href="https://github.com/blinkfox/hexo-theme-matery">https://github.com/blinkfox/hexo-theme-matery</a></p><p>é‡Œé¢æœ‰ç›¸åº”çš„ä¸­æ–‡ä½¿ç”¨æ•™ç¨‹ï¼Œè¿˜æ˜¯æ¯”è¾ƒè¯¦ç»†çš„ã€‚</p><p>æˆ‘çš„hexoç‰ˆæœ¬æ˜¯6.0.0</p></blockquote><h3 id="ä¸€ã€é—®é¢˜æè¿°"><a href="#ä¸€ã€é—®é¢˜æè¿°" class="headerlink" title="ä¸€ã€é—®é¢˜æè¿°"></a>ä¸€ã€é—®é¢˜æè¿°</h3><blockquote><p>æˆ‘åœ¨ç”¨Typoraå†™ç›¸å…³åšå®¢çš„mdæ–‡ä»¶æ—¶ï¼Œéœ€è¦æ’å…¥ç›¸å…³çš„å›¾ç‰‡ï¼Œæˆ‘æŒ‰ç…§ç½‘ä¸Šçš„æ–¹æ³•éƒ½æ˜¯ï¼š</p><ul><li>åœ¨æ ¹ç›®å½•ä¸‹çš„_config.yamlæ–‡ä»¶ä¸­å°†â€post_asset_folderâ€è®¾ä¸º:true</li><li>npmå®‰è£…è½¬åŒ–å›¾ç‰‡è·¯å¾„çš„å·¥å…·åŒ…ï¼šnpm install hexo-asset-image â€“save</li><li>Typoraä¸­ä½¿ç”¨ï¼[]ï¼ˆï¼‰ä¼ å…¥å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶å</li></ul></blockquote><p>æˆ‘æŒ‰ç…§ä¸Šè¿°æ­¥éª¤å°è¯•ä¹‹åå‘ç°å›¾ç‰‡è¿˜æ˜¯ä¸èƒ½å¤Ÿæ­£å¸¸çš„æ˜¾ç¤ºå‡ºæ¥ï¼Œæˆ‘çš„Typoraæ˜¯æŒ‰ç…§è§„èŒƒå†™çš„å›¾ç‰‡åï¼Œä½†æ˜¯åšå®¢å°±æ˜¯ä¸èƒ½å±•ç¤ºå›¾ç‰‡:</p><img src="2.png" alt="å›¾1 Typoraä»£ç å›¾" style="zoom:50%;"><img src="1.png" alt="å›¾2 bugå›¾" style="zoom:67%;"><h3 id="äºŒã€é—®é¢˜åŸå› "><a href="#äºŒã€é—®é¢˜åŸå› " class="headerlink" title="äºŒã€é—®é¢˜åŸå› "></a>äºŒã€é—®é¢˜åŸå› </h3><ul><li><p>æŒ‰F12æŸ¥çœ‹å½“å‰ç½‘é¡µçš„ img æ ‡ç­¾çš„é‡Œé¢çš„urlæ˜¯ä»€ä¹ˆï¼Ÿ</p><blockquote><p>æˆ‘å‘ç°urlè§£ææˆäº†ï¼š/kingpopen.github.io/2022/05/27/new-blog/pic.jpg</p><p><strong>éš¾æ€ª</strong>ä¸èƒ½æ­£å¸¸çš„å±•ç¤ºå›¾ç‰‡~</p><p>è¯´æ˜hexo-asset-imageè¿™ä¸ªå·¥å…·åŒ…åœ¨å¸®åŠ©æˆ‘è§£ætyporaä¸­å†™çš„å›¾ç‰‡è·¯å¾„çš„æ—¶å€™å‡ºäº†é—®é¢˜ã€‚</p></blockquote><img src="3.png" alt="å›¾3 F12çš„imgæ ‡ç­¾å›¾" style="zoom:100%;"></li><li><p>æŸ¥çœ‹hexo-assert-imageä¸­åˆ°åº•å†™äº†äº›ä»€ä¹ˆï¼Ÿ</p><blockquote><p>hexo-assert-imageå°±æ”¾åœ¨:æ ¹ç›®å½•\node_modules\hexo-asset-image é‡Œé¢</p><p>æ‰“å¼€å…¶ä¸­çš„index.jsæ–‡ä»¶ï¼Œå‘ç°å†™äº†ä¸€å †ä»£ç ï¼Œæ¯”è¾ƒå…³é”®çš„ä»£ç æ˜¯ï¼š</p></blockquote><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>root <span class="token operator">+</span> link <span class="token operator">+</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>å¯ä»¥å‘ç°æœ€åçš„imgçš„srcè·¯å¾„æ˜¯ç”±confg.root, link, src, è¿™ä¸‰éƒ¨åˆ†ç»„æˆï¼Œæˆ‘å°†è¿™ä¸‰éƒ¨åˆ†æ‰“å°è¾“å‡ºï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ï¼š</p></blockquote><img src="4.png" alt="å›¾4 æ‰“å°è¾“å‡ºå›¾" style="zoom:50%;"><blockquote><p>åŸæ¥å°±æ˜¯è¿™å‡ æ ·ä¸œè¥¿ç»„æˆæˆ‘æœ€åçš„src~</p><p>çœ‹æ¥é—®é¢˜å°±æ˜¯å‡ºåœ¨äº†hexo-asset-imageåŒ…çš„index.jsæ–‡ä»¶é‡Œé¢ï¼Œå®ƒè§£ææ–¹å¼æœ‰ä¸€äº›é—®é¢˜ã€‚</p></blockquote></li><li><p>æœ€åæŸ¥äº†ä¸€äº›åšå®¢ï¼Œå‘ç°å¤§å®¶å®‰è£…çš„hexo-asset-imgç‰ˆæœ¬ä¸»è¦æ˜¯ä¸‹é¢è¿™ä¸¤ä¸ªï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// é«˜ç‰ˆæœ¬çš„hexo ä¸è¦å®‰è£…ä¸‹é¢è¿™ä¸¤ç±»åŒ…</span><span class="token number">1.</span> npm install https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>CodeFalling<span class="token operator">/</span>hexo<span class="token operator">-</span>asset<span class="token operator">-</span>image <span class="token operator">--</span>save<span class="token number">2.</span> npm install https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>7ym0n<span class="token operator">/</span>hexo<span class="token operator">-</span>asset<span class="token operator">-</span>image <span class="token operator">--</span>save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>æˆ‘çœ‹åˆ°è¿™ä¸¤ä¸ªç‰ˆæœ¬çš„å‘è¡Œæ—¶é—´éƒ½æ˜¯æ¯”è¾ƒæ—©ï¼Œå¤§æ¦‚2018å¹´å·¦å³ã€‚ç°åœ¨æˆ‘ä½¿ç”¨çš„hexoç‰ˆæœ¬æ˜¯6.0.0çš„ï¼Œä¼°è®¡æ˜¯å› ä¸ºhexoçš„ç‰ˆæœ¬æ›´æ–°äº†ï¼Œä½†æ˜¯hexo-asset-imageçš„ç‰ˆæœ¬æ²¡æœ‰è¿›è¡Œç»´æŠ¤ï¼Œå¯¼è‡´äº†é”™è¯¯çš„å‡ºç°ã€‚</p></blockquote></li></ul><h3 id="ä¸‰ã€è§£å†³æ–¹æ³•"><a href="#ä¸‰ã€è§£å†³æ–¹æ³•" class="headerlink" title="ä¸‰ã€è§£å†³æ–¹æ³•"></a>ä¸‰ã€è§£å†³æ–¹æ³•</h3><blockquote><p>æœ€åæ‰¾åˆ°ä¸€ç¯‡åšå®¢ï¼Œè¿™ä¸ªè€å“¥è‡ªå·±æ”¹è¿›äº†hexo-asset-imgï¼Œå¹¶ä¸”å¼€æºäº†ï¼Œæˆ‘å®‰è£…ä»–è‡ªå·±æ”¹çš„hexo-asset-imgç‰ˆæœ¬ï¼Œå°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p></blockquote><p>â€‹ <strong>æ³¨æ„ä¸€ä¸‹ä¹‹å‰çš„åŒ…å«ï¼šhexo-asset-image, è¿™ä¸ªè€å“¥çš„åŒ…å«:hexo-asset-img</strong></p><blockquote><p>åšå®¢ï¼š<a href="https://cloud.tencent.com/developer/article/1970544">https://cloud.tencent.com/developer/article/1970544</a></p><p>githubï¼š<a href="https://github.com/yiyungent/hexo-asset-img">https://github.com/yiyungent/hexo-asset-img</a></p></blockquote><ul><li>æ–¹æ³•ä¸€ï¼šé‡æ–°å®‰è£…æ­£ç¡®çš„hexo-asset-imgç‰ˆæœ¬ï¼ˆæ¨èï¼‰</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// å…ˆå¸è½½ä¹‹å‰çš„hexo-asset-image ç‰ˆæœ¬</span>npm uninstall hexo<span class="token operator">-</span>asset<span class="token operator">-</span>image<span class="token comment">// å†é€‰æ‹©æ­£ç¡®çš„ç‰ˆæœ¬å®‰è£…</span>npm install hexo<span class="token operator">-</span>asset<span class="token operator">-</span>img<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>æ–¹æ³•äºŒï¼šç›´æ¥ä¿®æ”¹hexo-asset-imageä¸­çš„index.jsæ–‡ä»¶</p><blockquote><p>å› ä¸ºæœ‰çš„æ—¶å€™githubçš„ç½‘é€Ÿæ¯”è¾ƒæ…¢ï¼Œnpm installå®‰è£…å¯èƒ½å®‰è£…ä¸æˆåŠŸï¼Œå°±ç›´æ¥å°†ï¼š<a href="https://github.com/yiyungent/hexo-asset-img">https://github.com/yiyungent/hexo-asset-img</a> ä¸­çš„index.jsæ–‡ä»¶çš„å†…å®¹æ‹·è´ï¼Œç„¶åæ›¿æ¢è‡ªå·±é¡¹ç›®ä¸­hexo-asset-imageä¸­çš„index.jsçš„å†…å®¹å°±å¥½äº†ã€‚</p></blockquote></li></ul><p>è‡³æ­¤ï¼Œè¯¥é—®é¢˜å°±æˆåŠŸè§£å†³äº†ï¼Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="5.png" alt="å›¾5 æ•ˆæœå›¾" style="zoom:;"><p><strong>æ³¨ï¼šå¦‚æœå­˜æ”¾å›¾ç‰‡çš„æ–‡ä»¶å¤¹åç§°æ˜¯ä¸­æ–‡ï¼ŒTyporaä¸­çš„ï¼[]ï¼ˆï¼‰ä¸­å›¾ç‰‡å›¾ç‰‡è·¯å¾„å°±ä¸è¦åŠ æ–‡ä»¶å¤¹åäº†ï¼Œç›´æ¥ä½¿ç”¨å›¾ç‰‡åç§°ï¼Œä¸ç„¶è¿˜æ˜¯ä¼šå‡ºç°ä¸èƒ½æ˜¾ç¤ºçš„é—®é¢˜ï¼</strong></p><h3 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h3><blockquote><p>â€‹        è¿™æ˜¯æˆ‘è‡ªå·±ç¬¬ä¸€æ¬¡ä½¿ç”¨githubæ¥æ­å»ºåšå®¢ï¼Œå…¶ä¸­ä¹Ÿé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œå°±å±è¿™ä¸ªé—®é¢˜èŠ±çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œå¥½åœ¨æœ€åæˆåŠŸè§£å†³äº†ã€‚å¦‚æœæœ‰å…¶ä»–æœ‹å‹é‡åˆ°è¿™ç±»é—®é¢˜ï¼Œå¸Œæœ›å¯¹ä½ ä»¬æœ‰æ‰€å¸®åŠ©! ğŸ˜„</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> bug </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬ä¸€ç¯‡åšå®¢</title>
      <link href="/2022/05/27/di-yi-pian-bo-ke/"/>
      <url>/2022/05/27/di-yi-pian-bo-ke/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ä¹‹å‰éƒ½æ˜¯åœ¨CSDNå’ŒçŸ¥ä¹ä¸Šå†™åšå®¢ï¼Œç°åœ¨å¼€å§‹è‡ªå·±ä½¿ç”¨githubæ¥æ­å»ºä¸€ä¸ªåšå®¢ç½‘ç«™ï¼Œ<br>è¿™æ˜¯æˆ‘ä½¿ç”¨hexoæ­å»ºçš„åšå®¢å¼€å§‹å†™çš„ä¸€ä¸ªåšå®¢ï¼<br>å…¨æ–°çš„å¼€å§‹~</p><p>ğŸ¤ª</p></blockquote><p><img src="1.jpg"></p>]]></content>
      
      
      
        <tags>
            
            <tag> è®°å½• </tag>
            
            <tag> ç”Ÿæ´» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benchmark-masterï¼ˆåï¼‰ï¼šbox_headçš„lossæ–‡ä»¶</title>
      <link href="/2021/08/03/maskrcnn-benchmark-master-shi-box-head-de-loss-wen-jian/"/>
      <url>/2021/08/03/maskrcnn-benchmark-master-shi-box-head-de-loss-wen-jian/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ä¸Šä¸€ç¯‡åšå®¢å·²ç»ä»‹ç»å®Œbox_headçš„inferenceæ–‡ä»¶ï¼Œæˆ‘ä»¬çŸ¥é“äº†box_headåœ¨inferenceé˜¶æ®µæ˜¯å¦‚ä½•è¿›è¡Œç­›é€‰box(Proposals)ï¼Œæœ€åå¾—åˆ°è¾“å‡ºçš„instancesç»“æœï¼Œæœ¬ç¯‡åšå®¢å°†ä»‹ç»åœ¨box_headé˜¶æ®µçš„lossæ˜¯å¦‚ä½•è¿›è¡Œè®¡ç®—çš„ï¼Œæœ‰äº†å‰é¢RPNçš„lossæ–‡ä»¶ä»‹ç»ï¼Œbox_headçš„lossæ–‡ä»¶ä»‹ç»å°†ä¼šç®€å•å¾ˆå¤šï¼Œå®ƒæ¶‰åŠåˆ°çš„å‡½æ•°å’ŒRPNçš„lossæ–‡ä»¶åŸºæœ¬æ˜¯ç±»ä¼¼çš„ã€‚</p></blockquote><h3 id="ä¸€ã€make-roi-box-loss-evaluator-å‡½æ•°"><a href="#ä¸€ã€make-roi-box-loss-evaluator-å‡½æ•°" class="headerlink" title="ä¸€ã€make_roi_box_loss_evaluator()å‡½æ•°"></a>ä¸€ã€make_roi_box_loss_evaluator()å‡½æ•°</h3><blockquote><p>box_headçš„è®¡ç®—lossç›¸å…³æ“ä½œåœ¨your_project/maskrcnn_benchmark/modeling/roi_heads/box_head/loss.pyæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹make_roi_box_loss_evaluator()è¿™ä¸ªå‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">make_roi_box_loss_evaluator</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># åŒ¹é…å™¨ ç”¨äºç»™RPNè¾“å‡ºç»™ROI_headéƒ¨åˆ†çš„Proposalsåˆ†é…çœŸå®çš„æ ‡ç­¾</span>    matcher <span class="token operator">=</span> Matcher<span class="token punctuation">(</span>        cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>FG_IOU_THRESHOLD<span class="token punctuation">,</span>        cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>BG_IOU_THRESHOLD<span class="token punctuation">,</span>        allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token comment"># boxçš„ç¼–è§£ç å™¨</span>    bbox_reg_weights <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>BBOX_REG_WEIGHTS    box_coder <span class="token operator">=</span> BoxCoder<span class="token punctuation">(</span>weights<span class="token operator">=</span>bbox_reg_weights<span class="token punctuation">)</span>    <span class="token comment"># åœ¨box_headé¢„æµ‹å¾—åˆ°çš„Proposalsä¸­ç­›é€‰æ­£è´Ÿæ ·æœ¬ç”¨äºè®­ç»ƒ</span>    fg_bg_sampler <span class="token operator">=</span> BalancedPositiveNegativeSampler<span class="token punctuation">(</span>        cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>BATCH_SIZE_PER_IMAGE<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>POSITIVE_FRACTION    <span class="token punctuation">)</span>    <span class="token comment"># è¿™ä¸ªä¸ç®¡å®ƒï¼</span>    cls_agnostic_bbox_reg <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>CLS_AGNOSTIC_BBOX_REG    <span class="token comment"># æŸå¤±çš„è®¡ç®—  ç”¨äºè®¡ç®—æ•´ä¸ªbox_headéƒ¨åˆ†çš„loss</span>    loss_evaluator <span class="token operator">=</span> FastRCNNLossComputation<span class="token punctuation">(</span>        matcher<span class="token punctuation">,</span>        fg_bg_sampler<span class="token punctuation">,</span>        box_coder<span class="token punctuation">,</span>        cls_agnostic_bbox_reg    <span class="token punctuation">)</span>     <span class="token keyword">return</span> loss_evaluator<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è¿™éƒ¨åˆ†ä»£ç æ˜¯ä¸æ˜¯è·Ÿ<strong>RPNä¸­lossæ–‡ä»¶</strong>å¾ˆç›¸ä¼¼ï¼Œä¸èƒ½è¯´ç›¸ä¼¼ï¼Œç®€ç›´ä¸€æ¨¡ä¸€æ ·~ï¼Œå› ä¸ºRPNçš„è¾“å‡ºæ˜¯Proposalsï¼Œè¿™äº›Proposalsæ˜¯ä½œä¸ºROI_headsçš„ä¸€ä¸ªè¾“å…¥ï¼Œä½†æ˜¯åœ¨è®­ç»ƒé˜¶æ®µï¼Œbox_headéƒ¨åˆ†å°†å¯¹è¿™äº›Proposalsé€‰ä¸€éƒ¨åˆ†ç”¨ä½œè®­ç»ƒï¼Œä½œä¸ºbox_headçš„è¾“å…¥ã€‚</p><p>ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ªå‡½æ•°ä¸»è¦ç”±ä¸‰ä¸ªç±»çš„å¯¹è±¡æ„æˆï¼Œè¿™ä¸‰ä¸ªç±»åˆ†åˆ«æ˜¯ï¼š</p><p><strong>Matcherç±»</strong>ï¼šè¿™ä¸ªç±»ä¸»è¦æ˜¯ç»™RPNè¾“å‡ºçš„Proposalsåˆ†é…å¯¹åº”ç±»åˆ«æ ‡ç­¾çš„ã€‚<br><strong>BalancedPositiveNegativeSamplerç±»</strong>ï¼šç”¨äºç­›é€‰ä¸Šè¿°çš„å“ªäº›Proposalså¯ä»¥å½“ä½œæ­£è´Ÿæ ·æœ¬ç”¨äºè®¡ç®—lossçš„è¿‡ç¨‹ã€‚<br><strong>FastRCNNLossComputation</strong>ï¼šç”¨äºç»™ç­›é€‰ï¼ˆå’Œinferenceé˜¶æ®µç­›é€‰æœºåˆ¶ä¸ä¸€æ ·ï¼‰è¿‡åå¾—åˆ°çš„Proposalsè®¡ç®—å…¶å¯¹åº”çš„lossã€‚</p><p>å› ä¸º<strong>Matchç±»</strong>å’Œ<strong>BalancedPositiveNegativeSamplerç±»</strong>å·²ç»åœ¨ï¼š</p><p>maskrcnn-benchmark-masterï¼ˆå…­ï¼‰ï¼šRPNçš„lossæ–‡ä»¶</p><p>ä»‹ç»è¿‡äº†ï¼Œæ‰€ä»¥æœ¬ç¯‡åªç€é‡ä»‹ç»<strong>FastRCNNLossComputationç±»</strong>ã€‚</p></blockquote><h3 id="äºŒã€FastRCNNLossComputation"><a href="#äºŒã€FastRCNNLossComputation" class="headerlink" title="äºŒã€FastRCNNLossComputation"></a>äºŒã€FastRCNNLossComputation</h3><blockquote><p>åœ¨FastRCNNLossComputationç±»ä¸­ä¸»è¦åŒ…å«æœ‰äº”ä¸ªå‡½æ•°ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š<strong>init</strong>()å‡½æ•°ã€match_targets_to_proposals()å‡½æ•°ã€prepare_targets()å‡½æ•°ã€subsample()å‡½æ•°ã€<strong>call</strong>()å‡½æ•°ï¼Œå®ƒä»¬ä¹‹é—´çš„ç®€å•è°ƒç”¨å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></blockquote><p><img src="1.jpg" alt="å›¾1 è°ƒç”¨å…³ç³»å›¾"></p><h4 id="1ã€init-å‡½æ•°"><a href="#1ã€init-å‡½æ•°" class="headerlink" title="1ã€init()å‡½æ•°"></a>1ã€<strong>init</strong>()å‡½æ•°</h4><blockquote><p>æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹__init__()å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">FastRCNNLossComputation</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Computes the loss for Faster R-CNN.    Also supports FPN    å¯¹Faster-RCNNéƒ¨åˆ†çš„lossè¿›è¡Œè®¡ç®—    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>        self<span class="token punctuation">,</span>        proposal_matcher<span class="token punctuation">,</span>        fg_bg_sampler<span class="token punctuation">,</span>        box_coder<span class="token punctuation">,</span>        cls_agnostic_bbox_reg<span class="token operator">=</span><span class="token boolean">False</span>    <span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            proposal_matcher (Matcher)            fg_bg_sampler (BalancedPositiveNegativeSampler)            box_coder (BoxCoder)        """</span>        <span class="token comment"># å®šä¹‰ç”¨äºProposalsæ ‡ç­¾åŒ¹é…çš„ åŒ¹é…å™¨</span>        self<span class="token punctuation">.</span>proposal_matcher <span class="token operator">=</span> proposal_matcher        <span class="token comment"># å®šä¹‰ç”¨äºæ­£è´Ÿæ ·æœ¬ç­›é€‰çš„ ç­›é€‰å™¨</span>        self<span class="token punctuation">.</span>fg_bg_sampler <span class="token operator">=</span> fg_bg_sampler        <span class="token comment"># å®šä¹‰boxçš„ç¼–è§£ç å™¨</span>        self<span class="token punctuation">.</span>box_coder <span class="token operator">=</span> box_coder        self<span class="token punctuation">.</span>cls_agnostic_bbox_reg <span class="token operator">=</span> cls_agnostic_bbox_reg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2ã€match-targets-to-proposals-å‡½æ•°"><a href="#2ã€match-targets-to-proposals-å‡½æ•°" class="headerlink" title="2ã€match_targets_to_proposals()å‡½æ•°"></a>2ã€match_targets_to_proposals()å‡½æ•°</h4><blockquote><p><strong>init</strong>()å‡½æ•°ä¸»è¦æ˜¯å®šä¹‰ç›¸å…³çš„ç±»å˜é‡ï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½ä»‹ç»çš„ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹match_targets_to_proposals()å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">match_targets_to_proposals</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposal<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># gt å’Œ RPNè¾“å‡ºçš„Proposalsä¹‹é—´çš„ IOUçŸ©é˜µ</span>    match_quality_matrix <span class="token operator">=</span> boxlist_iou<span class="token punctuation">(</span>target<span class="token punctuation">,</span> proposal<span class="token punctuation">)</span>     <span class="token comment"># é¢„æµ‹è¾¹æ¡†å’Œå¯¹åº”çš„gtçš„ç´¢å¼•ï¼Œ èƒŒæ™¯è¾¹æ¡†ä¸º-2 ï¼Œ æ¨¡ç³Šè¾¹æ¡†ä¸º-1 </span>    <span class="token comment"># eg:matched_idxs[4] = 6 :è¡¨ç¤ºç¬¬5ä¸ªé¢„æµ‹è¾¹æ¡†æ‰€åˆ†é…çš„GTçš„idä¸º6</span>    matched_idxs <span class="token operator">=</span> self<span class="token punctuation">.</span>proposal_matcher<span class="token punctuation">(</span>match_quality_matrix<span class="token punctuation">)</span>    <span class="token comment"># Fast RCNN only need "labels" field for selecting the targetsã€</span>    <span class="token comment"># è·å¾— GT çš„ç±»åˆ«æ ‡ç­¾</span>    target <span class="token operator">=</span> target<span class="token punctuation">.</span>copy_with_fields<span class="token punctuation">(</span><span class="token string">"labels"</span><span class="token punctuation">)</span>    <span class="token comment"># get the targets corresponding GT for each proposal</span>    <span class="token comment"># NB: need to clamp the indices because we can have a single</span>    <span class="token comment"># GT in the image, and matched_idxs can be -2, which goes</span>    <span class="token comment"># out of bounds</span>     <span class="token comment"># å°†æ‰€æœ‰çš„èƒŒæ™¯è¾¹æ¡†å’Œæ¨¡ç³Šè¾¹æ¡†çš„æ ‡ç­¾éƒ½å¯¹åº”æˆç¬¬ä¸€ä¸ªgtçš„æ ‡ç­¾</span>    <span class="token comment"># å…¶å®å°±æ˜¯å°†targetä¸­çš„box å’ŒlabelæŒ‰ç…§Proposalsçš„å¯¹åº”é¡ºåºé‡æ–°æ’åºçš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œ</span>    <span class="token comment"># å°†targetä¸­boxé¡ºåºå’Œmatched_idxsä¸­çš„GTçš„idé¡ºåºä¿æŒä¸€è‡´</span>    matched_targets <span class="token operator">=</span> target<span class="token punctuation">[</span>matched_idxs<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment"># å°†å¯¹åº”çš„åˆ—è¡¨ç´¢å¼•æ·»åŠ è‡³gtåˆ—è¡¨ä¸­</span>    matched_targets<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">"matched_idxs"</span><span class="token punctuation">,</span> matched_idxs<span class="token punctuation">)</span>    <span class="token keyword">return</span> matched_targets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3ã€prepare-targets-å‡½æ•°"><a href="#3ã€prepare-targets-å‡½æ•°" class="headerlink" title="3ã€prepare_targets()å‡½æ•°"></a>3ã€prepare_targets()å‡½æ•°</h4><blockquote><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹å‡ºmatch_targets_to_proposals()å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªBoxListå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­çš„boxæ˜¯Proposalsæ‰€å¯¹åº”çš„GTçš„boxï¼Œlabelsæ˜¯Proposalsæ‰€å¯¹åº”GTçš„labelã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€çœ‹çœ‹prepare_targets()å‡½æ•°:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å‡†å¤‡ç±»åˆ«æ ‡ç­¾å’Œboxåç§»é‡æ ‡ç­¾</span>    <span class="token keyword">def</span> <span class="token function">prepare_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># ç±»åˆ«æ ‡ç­¾åˆ—è¡¨</span>        labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token comment"># å›å½’boxæ ‡ç­¾åˆ—è¡¨</span>        regression_targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token comment"># åˆ†åˆ«å¯¹æ¯ä¸€å¼ å›¾ç‰‡è¿›è¡Œæ“ä½œ</span>        <span class="token keyword">for</span> proposals_per_image<span class="token punctuation">,</span> targets_per_image <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>            matched_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>match_targets_to_proposals<span class="token punctuation">(</span>                proposals_per_image<span class="token punctuation">,</span> targets_per_image            <span class="token punctuation">)</span>            matched_idxs <span class="token operator">=</span> matched_targets<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"matched_idxs"</span><span class="token punctuation">)</span>            <span class="token comment"># è·å–æ¯ä¸€ä¸ªtargetæ‰€å¯¹åº”çš„labelæ ‡ç­¾</span>            labels_per_image <span class="token operator">=</span> matched_targets<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"labels"</span><span class="token punctuation">)</span>            labels_per_image <span class="token operator">=</span> labels_per_image<span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>             <span class="token comment"># Label background (below the low threshold)</span>            <span class="token comment"># èƒŒæ™¯æ ‡ç­¾</span>            bg_inds <span class="token operator">=</span> matched_idxs <span class="token operator">==</span> Matcher<span class="token punctuation">.</span>BELOW_LOW_THRESHOLD            labels_per_image<span class="token punctuation">[</span>bg_inds<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>             <span class="token comment"># Label ignore proposals (between low and high thresholds)</span>            <span class="token comment"># è¢«å¿½è§†çš„æ ·æœ¬</span>            ignore_inds <span class="token operator">=</span> matched_idxs <span class="token operator">==</span> Matcher<span class="token punctuation">.</span>BETWEEN_THRESHOLDS            labels_per_image<span class="token punctuation">[</span>ignore_inds<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token comment"># -1 is ignored by sampler</span>             <span class="token comment"># compute regression targets</span>            <span class="token comment"># è®¡ç®—åç§»é‡target  å› ä¸ºç½‘ç»œé¢„æµ‹çš„ç»“æœæ˜¯åç§»é‡ï¼Œæ‰€ä»¥éœ€è¦ç”Ÿæˆåç§»é‡æ ‡ç­¾</span>            regression_targets_per_image <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>                matched_targets<span class="token punctuation">.</span>bbox<span class="token punctuation">,</span> proposals_per_image<span class="token punctuation">.</span>bbox            <span class="token punctuation">)</span>            <span class="token comment"># å¯¹ç”Ÿæˆå¥½çš„ç±»åˆ«æ ‡ç­¾å’Œåç§»é‡æ ‡ç­¾è¿›è¡Œä¿å­˜</span>            labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_per_image<span class="token punctuation">)</span>            regression_targets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>regression_targets_per_image<span class="token punctuation">)</span>         <span class="token keyword">return</span> labels<span class="token punctuation">,</span> regression_targets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4ã€subsample-å‡½æ•°"><a href="#4ã€subsample-å‡½æ•°" class="headerlink" title="4ã€subsample()å‡½æ•°"></a>4ã€subsample()å‡½æ•°</h4><blockquote><p>ä¸Šé¢çš„prepare_targets()å‡½æ•°å°±æ˜¯è¿”å›ä¸ºProposalsåŒ¹é…å¥½çš„ç±»åˆ«æ ‡ç­¾å’Œboxåç§»é‡æ ‡ç­¾ï¼Œæ¥ä¸‹æ¥å°†é€šè¿‡subsampleï¼ˆï¼‰è¿›è¡Œæ­£è´Ÿæ ·æœ¬çš„ç­›é€‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç›¸å…³ä»£ç ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">subsample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    This method performs the positive/negative sampling, and return    the sampled proposals.    Note: this function keeps a state.    Arguments:        proposals (list[BoxList])        targets (list[BoxList])    """</span>    <span class="token comment"># è·å–Proposalsåˆ†é…å¥½çš„æ ‡ç­¾</span>    labels<span class="token punctuation">,</span> regression_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>prepare_targets<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>    <span class="token comment"># è·å–è¢«åˆ†é…ä¸ºæ­£è´Ÿæ ·æœ¬çš„ç´¢å¼•  ç”±BalancedPositiveNegativeSamplerç±»è¿›è¡Œåˆ†é…</span>    sampled_pos_inds<span class="token punctuation">,</span> sampled_neg_inds <span class="token operator">=</span> self<span class="token punctuation">.</span>fg_bg_sampler<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>     proposals <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>proposals<span class="token punctuation">)</span>    <span class="token comment"># add corresponding label and regression_targets information to the bounding boxes</span>    <span class="token keyword">for</span> labels_per_image<span class="token punctuation">,</span> regression_targets_per_image<span class="token punctuation">,</span> proposals_per_image <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>        labels<span class="token punctuation">,</span> regression_targets<span class="token punctuation">,</span> proposals    <span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># ç»™BoxListç±»å‹çš„Proposalsæ·»åŠ æ ‡ç­¾ä¿¡æ¯</span>        proposals_per_image<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">"labels"</span><span class="token punctuation">,</span> labels_per_image<span class="token punctuation">)</span>        proposals_per_image<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span>            <span class="token string">"regression_targets"</span><span class="token punctuation">,</span> regression_targets_per_image        <span class="token punctuation">)</span>     <span class="token comment"># distributed sampled proposals, that were obtained on all feature maps</span>    <span class="token comment"># concatenated via the fg_bg_sampler, into individual feature map levels</span>    <span class="token comment"># å¯¹BoxListç±»å‹çš„Proposalsè¿›è¡Œæ­£è´Ÿæ ·æœ¬ç­›é€‰ï¼ˆå¯¹åº”çš„æ ‡ç­¾ä¹Ÿä¼šä¸€å¹¶è¢«ç­›é€‰å‡ºæ¥ï¼‰</span>    <span class="token keyword">for</span> img_idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>pos_inds_img<span class="token punctuation">,</span> neg_inds_img<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>        <span class="token builtin">zip</span><span class="token punctuation">(</span>sampled_pos_inds<span class="token punctuation">,</span> sampled_neg_inds<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">:</span>        img_sampled_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>pos_inds_img <span class="token operator">|</span> neg_inds_img<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        proposals_per_image <span class="token operator">=</span> proposals<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span><span class="token punctuation">[</span>img_sampled_inds<span class="token punctuation">]</span>        proposals<span class="token punctuation">[</span>img_idx<span class="token punctuation">]</span> <span class="token operator">=</span> proposals_per_image    <span class="token comment"># å¾—åˆ°ç­›é€‰ä¹‹åçš„Proposalsï¼ˆBoxListå¯¹è±¡ å…¶ä¸­åŒ…å«æœ‰labelä¿¡æ¯ï¼‰</span>    self<span class="token punctuation">.</span>_proposals <span class="token operator">=</span> proposals    <span class="token keyword">return</span> proposals<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5ã€call-å‡½æ•°"><a href="#5ã€call-å‡½æ•°" class="headerlink" title="5ã€call()å‡½æ•°"></a>5ã€<strong>call</strong>()å‡½æ•°</h4><blockquote><p>é€šè¿‡subsampleï¼ˆï¼‰ç­›é€‰å¾—åˆ°å¯ä»¥ç”¨äºè®­ç»ƒé˜¶æ®µçš„Proposalsä¹‹åï¼ˆæ³¨æ„è¿™äº›Proposalséƒ½æ˜¯ä»RPNè¾“å‡ºçš„Proposalsä¸­è¿›è¡Œç­›é€‰çš„ï¼‰ï¼Œå°±è¦è¿›è¡Œæœ€ålossè®¡ç®—å·¥ä½œäº†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹__call__()å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> class_logits<span class="token punctuation">,</span> box_regression<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Computes the loss for Faster R-CNN.    This requires that the subsample method has been called beforehand.    Arguments:        class_logits (list[Tensor])        box_regression (list[Tensor])    Returns:        classification_loss (Tensor)        box_loss (Tensor)    """</span>    <span class="token comment"># é¢„æµ‹çš„Proposalsç±»åˆ«</span>    class_logits <span class="token operator">=</span> cat<span class="token punctuation">(</span>class_logits<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment"># é¢„æµ‹çš„Proposals boxåç§»é‡</span>    box_regression <span class="token operator">=</span> cat<span class="token punctuation">(</span>box_regression<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    device <span class="token operator">=</span> class_logits<span class="token punctuation">.</span>device     <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"_proposals"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">"subsample needs to be called before"</span><span class="token punctuation">)</span>    <span class="token comment"># è·å–ç”¨äºbox headè®­ç»ƒé˜¶æ®µè¾“å…¥çš„Proposalså’Œå®ƒå¯¹åº”çš„æ ‡ç­¾</span>    proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>_proposals    <span class="token comment"># è·å–proposalså¯¹åº”çš„çœŸå®ç±»åˆ«æ ‡ç­¾</span>    labels <span class="token operator">=</span> cat<span class="token punctuation">(</span><span class="token punctuation">[</span>proposal<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"labels"</span><span class="token punctuation">)</span> <span class="token keyword">for</span> proposal <span class="token keyword">in</span> proposals<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment"># è·å–proposalså¯¹åº”çš„çœŸå®box åç§»é‡</span>    regression_targets <span class="token operator">=</span> cat<span class="token punctuation">(</span>        <span class="token punctuation">[</span>proposal<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"regression_targets"</span><span class="token punctuation">)</span> <span class="token keyword">for</span> proposal <span class="token keyword">in</span> proposals<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span>    <span class="token punctuation">)</span>    <span class="token comment"># è®¡ç®—ç±»åˆ«åˆ†ç±»loss</span>    classification_loss <span class="token operator">=</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>class_logits<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>     <span class="token comment"># get indices that correspond to the regression targets for</span>    <span class="token comment"># the corresponding ground truth labels, to be used with</span>    <span class="token comment"># advanced indexing</span>    <span class="token comment"># ä¸å¯¹è´Ÿæ ·æœ¬çš„boxè¿›è¡Œå›å½’lossè®¡ç®—  æ‰€ä»¥é€‰å‡ºæ­£æ ·æœ¬çš„ç´¢å¼•</span>    sampled_pos_inds_subset <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>labels <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    labels_pos <span class="token operator">=</span> labels<span class="token punctuation">[</span>sampled_pos_inds_subset<span class="token punctuation">]</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>cls_agnostic_bbox_reg<span class="token punctuation">:</span>        map_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        map_inds <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> labels_pos<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>            <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>    <span class="token comment"># è®¡ç®—box åç§»é‡çš„å›å½’loss</span>    box_loss <span class="token operator">=</span> smooth_l1_loss<span class="token punctuation">(</span>        box_regression<span class="token punctuation">[</span>sampled_pos_inds_subset<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">,</span> map_inds<span class="token punctuation">]</span><span class="token punctuation">,</span>        regression_targets<span class="token punctuation">[</span>sampled_pos_inds_subset<span class="token punctuation">]</span><span class="token punctuation">,</span>        size_average<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>        beta<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    box_loss <span class="token operator">=</span> box_loss <span class="token operator">/</span> labels<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token keyword">return</span> classification_loss<span class="token punctuation">,</span> box_loss<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è‡³æ­¤box_headçš„lossæ–‡ä»¶å°±ç®—ä»‹ç»å®Œäº†ï¼Œæ€»ç»“ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ï¼š</p><ol><li>ç»™æ¯ä¸ªProposalsåŒ¹é…å¯¹åº”çš„ç±»åˆ«æ ‡ç­¾å’Œboxæ ‡ç­¾ï¼Œè¿›è€Œè®¡ç®—å‡ºboxåç§»é‡çš„å›å½’æ ‡ç­¾ã€‚</li><li>åœ¨å¯¹è¿™äº›åŒ¹é…å¥½æ ‡ç­¾çš„Proposalsç­›é€‰æ­£è´Ÿæ ·æœ¬ã€‚ï¼ˆåªæœ‰æå‰åŒ¹é…å¥½æ ‡ç­¾æ‰çŸ¥é“å“ªäº›æ˜¯æ­£ç±»å“ªäº›æ˜¯è´Ÿç±»å˜›ï¼‰</li><li>é€šè¿‡ç½‘ç»œå¯¹Proposalsçš„æœ€åçš„åˆ†ç±»ç»“æœå’Œboxåç§»é‡çš„å›å½’ç»“æœï¼Œç»“åˆåŒ¹é…å¥½çš„æ ‡ç­¾è®¡ç®—lossã€‚</li></ol><p>åŒæ—¶box_headéƒ¨åˆ†ç®—æ˜¯å·²ç»ä»‹ç»å®Œäº†ï¼Œä¸‹ä¸€æ¬¡å°†å±•å¼€mask_headçš„ä»‹ç»ï¼Œå¾…ç»­~</p><p><strong>ç å­—ä¸æ˜“  æœªç»è®¸å¯  è¯·å‹¿éšæ„è½¬è½½!</strong></p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benchmark-masterï¼ˆä¹ï¼‰ï¼šbox_headçš„inferenceæ–‡ä»¶</title>
      <link href="/2021/08/03/maskrcnn-benchmark-master-jiu-box-head-de-inference-wen-jian/"/>
      <url>/2021/08/03/maskrcnn-benchmark-master-jiu-box-head-de-inference-wen-jian/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ä¸Šä¸€ä¸ªåšå®¢å·²ç»ä»‹ç»äº†box_headçš„æ•´ä¸ªç½‘ç»œç»“æ„éƒ¨åˆ†ï¼Œåœ¨å¯¹box_headè¿›è¡Œinferenceè¿‡ç¨‹å°±éœ€è¦ä¸€ä¸ªåå¤„ç†ç±»ï¼Œæ¥ä¸‹æ¥è¿™ç¯‡åšå®¢å°†ä»‹ç»inferenceæ–‡ä»¶ä¸­çš„make_roi_box_post_processor()å‡½æ•°å’ŒPostProcessorç±»ã€‚</p><p>PostProcessorç±»:å› ä¸ºè¾“å…¥ROI_headsæ¨¡å—çš„Proposalsæ•°ç›®æœ¬èº«å°±å¾ˆå¤šï¼Œç„¶ååœ¨ç½‘ç»œåˆ†ç±»è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬ä¼šç»™æ¯ä¸ªProposalç”Ÿæˆå¯¹åº”ç±»åˆ«ä¸ªboxï¼Œå› æ­¤æœ€åç”Ÿæˆçš„boxä¼šéå¸¸çš„å¤šï¼Œæ‰€ä»¥éœ€è¦PostProcessorç±»æ¥æŒ‘é€‰å¹¶å†³å®šæœ€åè¾“å‡ºå“ªäº›boxå’Œç±»åˆ«ã€‚</p><p>ä¸¾ä¸ªæ —å­ï¼šæ€»å…±æ˜¯è¿›è¡Œ10åˆ†ç±»ï¼Œè¾“å…¥ROI_headæ¨¡å—çš„Proposalsæ•°ç›®ä¸º100ä¸ªï¼Œå°±æ„å‘³ç€è¦ç»™æ¯ä¸ªProposalsçš„boxç”Ÿæˆ10ç§åç§»é‡ï¼ˆæ¯ä¸ªç±»è¢«ä¸€ç§ï¼‰ï¼Œé‚£ä¸ªæœ€åè¾“å‡ºçš„boxæœ‰100*10=1000ä¸ªï¼Œä½†æ˜¯æ¨¡å‹ä¸å¯èƒ½æœ€ååœ¨ä¸€å¼ å›¾ç‰‡æ¡†å‡º1000ä¸ªæ¡†ä½œä¸ºè¾“å‡ºï¼Œæ‰€ä»¥éœ€è¦PostProcessorç±»æ¥å¯¹è¿™äº›boxè¿›è¡Œç­›é€‰ã€‚</p></blockquote><h3 id="ä¸€ã€-make-roi-box-post-processor-å‡½æ•°"><a href="#ä¸€ã€-make-roi-box-post-processor-å‡½æ•°" class="headerlink" title="ä¸€ã€ make_roi_box_post_processor()å‡½æ•°"></a>ä¸€ã€ make_roi_box_post_processor()å‡½æ•°</h3><blockquote><p>é¦–å…ˆçœ‹åˆ°make_roi_box_post_processor()å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯è·å¾—ä¸€ä¸ªPostProcessorç±»å¯¹è±¡ï¼Œå¹¶è¿”å›ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç›¸å…³ä»£ç ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">make_roi_box_post_processor</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>    use_fpn <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>USE_FPN     <span class="token comment"># å’Œboxç¼–è§£ç ç›¸å…³çš„å‚æ•°</span>    bbox_reg_weights <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>BBOX_REG_WEIGHTS    box_coder <span class="token operator">=</span> BoxCoder<span class="token punctuation">(</span>weights<span class="token operator">=</span>bbox_reg_weights<span class="token punctuation">)</span>     <span class="token comment"># è®¾ç½®å¾—åˆ†é˜ˆå€¼ ä½œä¸ºå“ªäº›boxæ˜¯å¦è¾“å‡ºçš„ä¾æ®</span>    score_thresh <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>SCORE_THRESH    <span class="token comment"># NMSçš„é˜ˆå€¼ï¼ˆç”¨äºå»é™¤æ‰ä¸€éƒ¨åˆ†boxï¼‰</span>    nms_thresh <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>NMS    <span class="token comment"># æ¯å¼ å›¾ç‰‡çš„æ£€æµ‹çš„æœ€å¤§instanceæ•°ç›®</span>    detections_per_img <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_HEADS<span class="token punctuation">.</span>DETECTIONS_PER_IMG    cls_agnostic_bbox_reg <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>CLS_AGNOSTIC_BBOX_REG    bbox_aug_enabled <span class="token operator">=</span> cfg<span class="token punctuation">.</span>TEST<span class="token punctuation">.</span>BBOX_AUG<span class="token punctuation">.</span>ENABLED     <span class="token comment"># ç”ŸæˆPostProcessorç±»å¯¹è±¡</span>    postprocessor <span class="token operator">=</span> PostProcessor<span class="token punctuation">(</span>        score_thresh<span class="token punctuation">,</span>        nms_thresh<span class="token punctuation">,</span>        detections_per_img<span class="token punctuation">,</span>        box_coder<span class="token punctuation">,</span>        cls_agnostic_bbox_reg<span class="token punctuation">,</span>        bbox_aug_enabled    <span class="token punctuation">)</span>    <span class="token comment"># è¿”å›PostProcessorç±»å¯¹è±¡</span>    <span class="token keyword">return</span> postprocessor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="äºŒã€PostProcessorç±»"><a href="#äºŒã€PostProcessorç±»" class="headerlink" title="äºŒã€PostProcessorç±»"></a>äºŒã€PostProcessorç±»</h3><blockquote><p>æ¥ä¸‹æ¥ä»‹ç»PostProcessorç±»ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹ç±»çš„__init__ï¼ˆï¼‰å‡½æ•°:</p></blockquote><h4 id="1ã€init-å‡½æ•°"><a href="#1ã€init-å‡½æ•°" class="headerlink" title="1ã€init()å‡½æ•°"></a>1ã€<strong>init</strong>()å‡½æ•°</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># inferenceè¿‡ç¨‹ç”¨åˆ°çš„ç±»</span><span class="token keyword">class</span> <span class="token class-name">PostProcessor</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    From a set of classification scores, box regression and proposals,    computes the post-processed boxes, and applies NMS to obtain the    final results    ä»ä¸€ç³»åˆ—çš„ç±»åˆ«åˆ†ç±»å¾—åˆ†ï¼Œè¾¹æ¡†å›å½’ä»¥åŠproposalsä¸­ï¼Œè®¡ç®—post-processed boxes,    ä»¥åŠåº”ç”¨NMSå¾—åˆ°æœ€åçš„ç»“æœã€‚    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>        self<span class="token punctuation">,</span>        score_thresh<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span>        nms<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>        detections_per_img<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>        box_coder<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>        cls_agnostic_bbox_reg<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>        bbox_aug_enabled<span class="token operator">=</span><span class="token boolean">False</span>    <span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            score_thresh (float)            nms (float)            detections_per_img (int)            box_coder (BoxCoder)        """</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>PostProcessor<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># ç±»åˆ«å¾—åˆ†é˜ˆå€¼</span>        self<span class="token punctuation">.</span>score_thresh <span class="token operator">=</span> score_thresh        <span class="token comment"># nmsé˜ˆå€¼</span>        self<span class="token punctuation">.</span>nms <span class="token operator">=</span> nms        <span class="token comment"># ä¸€å¼ å›¾ç‰‡æœ€åæ£€æµ‹ç»“æœæœ€å¤§è¾“å‡ºboxæ•°ç›®</span>        self<span class="token punctuation">.</span>detections_per_img <span class="token operator">=</span> detections_per_img        <span class="token keyword">if</span> box_coder <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            box_coder <span class="token operator">=</span> BoxCoder<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10.</span><span class="token punctuation">,</span> <span class="token number">10.</span><span class="token punctuation">,</span> <span class="token number">5.</span><span class="token punctuation">,</span> <span class="token number">5.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># boxç¼–è§£ç å™¨</span>        self<span class="token punctuation">.</span>box_coder <span class="token operator">=</span> box_coder        self<span class="token punctuation">.</span>cls_agnostic_bbox_reg <span class="token operator">=</span> cls_agnostic_bbox_reg        self<span class="token punctuation">.</span>bbox_aug_enabled <span class="token operator">=</span> bbox_aug_enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2ã€forward-å‡½æ•°"><a href="#2ã€forward-å‡½æ•°" class="headerlink" title="2ã€forward()å‡½æ•°"></a>2ã€forward()å‡½æ•°</h4><blockquote><p>æ¥ä¸‹æ¥çœ‹çœ‹forward()å‡½æ•°:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> boxes<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Arguments:        x (tuple[tensor, tensor, tensor]): x contains the class logits           and the box_regression from the model.        boxes (list[BoxList]): bounding boxes that are used as            reference, one for each image    Returns:        results (list[BoxList]): one BoxList for each image, containing            the extra fields labels and scores    """</span>    <span class="token comment"># å¾—åˆ°box_headç»“æ„ä¸ºæ¯ä¸ªproposalsè¾“å‡ºçš„ç±»åˆ«åˆ†ç±»ç»“æœå’Œboxåç§»é‡</span>    class_logits<span class="token punctuation">,</span> box_regression <span class="token operator">=</span> x    <span class="token comment"># è¿›è¡Œä¸€ä¸ªsoftmaxæ“ä½œ</span>    class_prob <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>class_logits<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>     <span class="token comment"># TODO think about a representation of batch of boxes</span>    <span class="token comment"># è·å–æ¯å¼ å›¾ç‰‡çš„size</span>    image_shapes <span class="token operator">=</span> <span class="token punctuation">[</span>box<span class="token punctuation">.</span>size <span class="token keyword">for</span> box <span class="token keyword">in</span> boxes<span class="token punctuation">]</span>    <span class="token comment"># è·å–æ¯ä¸€å¼ å›¾ç‰‡çš„Proposalsæ•°ç›®</span>    boxes_per_image <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span> <span class="token keyword">for</span> box <span class="token keyword">in</span> boxes<span class="token punctuation">]</span>    concat_boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">.</span>bbox <span class="token keyword">for</span> a <span class="token keyword">in</span> boxes<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>     <span class="token comment"># è¿™ä¸ªåœ°æ–¹å…ˆä¸ç”¨ç®¡å®ƒ</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>cls_agnostic_bbox_reg<span class="token punctuation">:</span>        box_regression <span class="token operator">=</span> box_regression<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>    <span class="token comment"># ç»™æ¯ä¸ªProposalåŠ ä¸Šåç§»é‡ï¼Œå¾—åˆ°ç½‘ç»œå¾®è°ƒä¹‹åçš„Proposals</span>    proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>        box_regression<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token builtin">sum</span><span class="token punctuation">(</span>boxes_per_image<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> concat_boxes    <span class="token punctuation">)</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>cls_agnostic_bbox_reg<span class="token punctuation">:</span>        proposals <span class="token operator">=</span> proposals<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> class_prob<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># è·å–åˆ†ç±»ç±»åˆ«æ•°ï¼ˆåŒ…å«äº†èƒŒæ™¯ç±»åˆ«ï¼‰</span>    num_classes <span class="token operator">=</span> class_prob<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token comment"># æŒ‰ç…§æ¯å¼ å›¾ç‰‡çš„Proposalsæ•°è¿›è¡Œåˆ‡åˆ†</span>    <span class="token comment"># å¾—åˆ°çš„proposalså˜é‡ç»´åº¦å°±æ˜¯ï¼ˆbatch size, æ¯å¼ å›¾ç‰‡çš„Proposalsæ•°ï¼‰</span>    proposals <span class="token operator">=</span> proposals<span class="token punctuation">.</span>split<span class="token punctuation">(</span>boxes_per_image<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    class_prob <span class="token operator">=</span> class_prob<span class="token punctuation">.</span>split<span class="token punctuation">(</span>boxes_per_image<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>     results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># åˆ†åˆ«å¯¹æ¯ä¸€å¼ å›¾ç‰‡è¿›è¡Œæ“ä½œ å› ä¸ºå›¾ç‰‡éƒ½æ˜¯æŒ‰ç…§batch sizeä¼ å…¥çš„</span>    <span class="token keyword">for</span> prob<span class="token punctuation">,</span> boxes_per_img<span class="token punctuation">,</span> image_shape <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>        class_prob<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> image_shapes    <span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># å°†æ¯ä¸ªåŠ ä¸Šåç§»é‡ï¼ˆå¾®è°ƒï¼‰ä¹‹åçš„Proposals æŒ‰ç…§BoxListçš„ç±»å‹è¿›è¡Œä¿å­˜</span>        <span class="token comment"># æ¯ä¸ªboxlistå¯¹è±¡éƒ½åŒ…å«æœ‰ä¸€å¼ å›¾ç‰‡ä¸­è¿›è¡ŒROI_headç»“æ„å¾®è°ƒè¿‡åå¾—åˆ°çš„Proposals</span>        boxlist <span class="token operator">=</span> self<span class="token punctuation">.</span>prepare_boxlist<span class="token punctuation">(</span>boxes_per_img<span class="token punctuation">,</span> prob<span class="token punctuation">,</span> image_shape<span class="token punctuation">)</span>        boxlist <span class="token operator">=</span> boxlist<span class="token punctuation">.</span>clip_to_image<span class="token punctuation">(</span>remove_empty<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>bbox_aug_enabled<span class="token punctuation">:</span>              <span class="token comment"># If bbox aug is enabled, we will do it later</span>            <span class="token comment"># æœ€åå¯¹è¿™äº›å¾®è°ƒä¹‹åçš„Proposalsè¿›è¡Œç­›é€‰</span>            boxlist <span class="token operator">=</span> self<span class="token punctuation">.</span>filter_results<span class="token punctuation">(</span>boxlist<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>        results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>boxlist<span class="token punctuation">)</span>    <span class="token keyword">return</span> results<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3ã€prepare-boxlist-å‡½æ•°"><a href="#3ã€prepare-boxlist-å‡½æ•°" class="headerlink" title="3ã€prepare_boxlist()å‡½æ•°"></a>3ã€prepare_boxlist()å‡½æ•°</h4><blockquote><p>forward()å‡½æ•°ä¸­è¿˜æ¶‰åŠåˆ°äº†prepare_boxlist()å‡½æ•°å’Œfilter_results()å‡½æ•°ï¼Œå…¶å®filter_results()å‡½æ•°æ‰æ˜¯çœŸæ­£è¿›è¡Œç­›é€‰çš„å‡½æ•°ï¼Œä¸‹é¢é¦–å…ˆä»‹ç»prepare_boxlist()å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># è¿™ä¸ªå‡½æ•°å°±æ˜¯å¯¹ä¸€å¼ å›¾ç‰‡å¾®è°ƒä¹‹åå¾—åˆ°çš„proposalï¼ˆboxï¼‰ä¿¡æ¯ </span><span class="token comment"># ç±»åˆ«åˆ†ç±»çš„scoresä¿¡æ¯ å›¾ç‰‡çš„sizeä¿¡æ¯éƒ½æ˜¯æ•´åˆåˆ°ä¸€ä¸ªBoxListå¯¹è±¡ä¸­å»</span><span class="token keyword">def</span> <span class="token function">prepare_boxlist</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> boxes<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> image_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Returns BoxList from `boxes` and adds probability scores information    as an extra field    `boxes` has shape (#detections, 4 * #classes), where each row represents    a list of predicted bounding boxes for each of the object classes in the    dataset (including the background class). The detections in each row    originate from the same object proposal.    `scores` has shape (#detection, #classes), where each row represents a list    of object detection confidence scores for each of the object classes in the    dataset (including the background class). `scores[i, j]`` corresponds to the    box at `boxes[i, j * 4:(j + 1) * 4]`.    """</span>    boxes <span class="token operator">=</span> boxes<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    scores <span class="token operator">=</span> scores<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    boxlist <span class="token operator">=</span> BoxList<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> image_shape<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"xyxy"</span><span class="token punctuation">)</span>    boxlist<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">"scores"</span><span class="token punctuation">,</span> scores<span class="token punctuation">)</span>    <span class="token keyword">return</span> boxlist<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4ã€filter-results-å‡½æ•°"><a href="#4ã€filter-results-å‡½æ•°" class="headerlink" title="4ã€filter_results()å‡½æ•°"></a>4ã€filter_results()å‡½æ•°</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">filter_results</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> boxlist<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Returns bounding-box detection results by thresholding on scores and    applying non-maximum suppression (NMS).    """</span>    <span class="token comment"># unwrap the boxlist to avoid additional overhead.</span>    <span class="token comment"># if we had multi-class NMS, we could perform this directly on the boxlist</span>    <span class="token comment"># å°†BoxListå¯¹è±¡ä¸­çš„box(Proposals)å–å‡ºæ¥  shape is(Proposalsæ•°, ç±»åˆ«æ•°*4)</span>    boxes <span class="token operator">=</span> boxlist<span class="token punctuation">.</span>bbox<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token comment"># å°†BoxListå¯¹è±¡ä¸­çš„ç±»åˆ«ç½®ä¿¡åº¦å¾—åˆ†å–å‡ºæ¥   shape is(Proposalsæ•°, ç±»åˆ«æ•°)</span>    scores <span class="token operator">=</span> boxlist<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"scores"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>     device <span class="token operator">=</span> scores<span class="token punctuation">.</span>device    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># Apply threshold on detection probabilities and apply NMS</span>    <span class="token comment"># Skip j = 0, because it's the background class</span>    <span class="token comment"># åˆ¤æ–­å“ªäº›å¾—åˆ†å¤§äºé˜ˆå€¼</span>    inds_all <span class="token operator">=</span> scores <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>score_thresh    <span class="token comment"># é€šè¿‡éå†ç±»åˆ«è¿›è¡Œç­›é€‰  index=0ä¸ºèƒŒæ™¯æ‰€ä»¥è·³è¿‡  ä»index=1å¼€å§‹</span>    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># è·å–å¾—åˆ†ï¼ˆç±»åˆ«ç½®ä¿¡åº¦ï¼‰å¤§äºé˜ˆå€¼çš„ç´¢å¼•</span>        inds <span class="token operator">=</span> inds_all<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> j<span class="token punctuation">]</span><span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># è·å–å½“å‰ç±»åˆ«å¾—åˆ†å¤§äºé˜ˆå€¼çš„ç´¢å¼•</span>        scores_j <span class="token operator">=</span> scores<span class="token punctuation">[</span>inds<span class="token punctuation">,</span> j<span class="token punctuation">]</span>        <span class="token comment"># è·å–ä¸Šé¢è·å–çš„ç´¢å¼•  æ‰€å¯¹åº”çš„boxä¿¡æ¯</span>        boxes_j <span class="token operator">=</span> boxes<span class="token punctuation">[</span>inds<span class="token punctuation">,</span> j <span class="token operator">*</span> <span class="token number">4</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span>        <span class="token comment"># å°†è¯¥ç±»åˆ«ï¼ˆç¬¬jç±»åˆ«ï¼‰çš„ç±»åˆ«å¾—åˆ†ä½äºé˜ˆå€¼çš„boxä¿¡æ¯ï¼Œå›¾ç‰‡ä¿¡æ¯éƒ½ä¿å­˜åœ¨                </span>        <span class="token comment"># boxlist_for_classå¯¹è±¡ä¸­</span>        boxlist_for_class <span class="token operator">=</span> BoxList<span class="token punctuation">(</span>boxes_j<span class="token punctuation">,</span> boxlist<span class="token punctuation">.</span>size<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"xyxy"</span><span class="token punctuation">)</span>        <span class="token comment"># ç»™boxlist_for_classæ·»åŠ å¤§äºé˜ˆå€¼çš„è¯¥ç±»åˆ«å¾—åˆ†ä¿¡æ¯</span>        boxlist_for_class<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">"scores"</span><span class="token punctuation">,</span> scores_j<span class="token punctuation">)</span>        <span class="token comment"># boxlist_for_classè¿›è¡ŒNMSæ“ä½œ  æ“ä½œä¹‹åå‰©ä½™çš„boxéƒ½åœ¨boxlist_for_classä¸­</span>        boxlist_for_class <span class="token operator">=</span> boxlist_nms<span class="token punctuation">(</span>            boxlist_for_class<span class="token punctuation">,</span> self<span class="token punctuation">.</span>nms        <span class="token punctuation">)</span>        <span class="token comment"># ç»™å‰©ä½™ä¸‹æ¥çš„boxæ·»åŠ ç¬¬jä¸ªç±»åˆ«æ ‡ç­¾</span>        num_labels <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>boxlist_for_class<span class="token punctuation">)</span>        boxlist_for_class<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span>            <span class="token string">"labels"</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>num_labels<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>        <span class="token punctuation">)</span>        <span class="token comment"># è¿›è¡Œä¿å­˜</span>        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>boxlist_for_class<span class="token punctuation">)</span>     result <span class="token operator">=</span> cat_boxlist<span class="token punctuation">(</span>result<span class="token punctuation">)</span>    number_of_detections <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>     <span class="token comment"># Limit to max_per_image detections **over all classes**</span>    <span class="token comment"># å¦‚æœæ£€æµ‹å¾—åˆ°çš„æ€»çš„intancesæ•°ç›®ï¼ˆProposalsï¼‰è¦å¤§äºå‚æ•°è®¾å®šçš„æœ€å¤§é™åˆ¶æ•°ç›®</span>    <span class="token comment"># é€šè¿‡ç½®ä¿¡åº¦æ’åºå»é™¤æ‰ä¸€éƒ¨åˆ†</span>    <span class="token keyword">if</span> number_of_detections <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>detections_per_img <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>        cls_scores <span class="token operator">=</span> result<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"scores"</span><span class="token punctuation">)</span>        image_thresh<span class="token punctuation">,</span> _ <span class="token operator">=</span> torch<span class="token punctuation">.</span>kthvalue<span class="token punctuation">(</span>            cls_scores<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> number_of_detections <span class="token operator">-</span> self<span class="token punctuation">.</span>detections_per_img <span class="token operator">+</span> <span class="token number">1</span>        <span class="token punctuation">)</span>        keep <span class="token operator">=</span> cls_scores <span class="token operator">&gt;=</span> image_thresh<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>        keep <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>keep<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        result <span class="token operator">=</span> result<span class="token punctuation">[</span>keep<span class="token punctuation">]</span>    <span class="token keyword">return</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å…¶å®å…³é”®çš„æ€è·¯å°±æ˜¯æŒ‰ç…§æ¯ä¸ªç±»å–å‡ºæ»¡è¶³å¾—åˆ†é˜ˆå€¼è¦æ±‚çš„Proposalsï¼Œç„¶ååˆ†åˆ«å¯¹æ¯ä¸ªç±»é€‰å‡ºçš„Proposalsè¿›è¡ŒNMSæ“ä½œï¼ˆ<strong>æ³¨æ„ï¼šä¸æ˜¯å¯¹æ‰€æœ‰ç±»åˆ«é€‰å‡ºçš„Proposalsï¼Œä¸€èµ·åšNMSæ“ä½œã€‚</strong>ï¼‰ã€‚ä¸‹é¢ç”¨å›¾ä¾‹è¿›è¡Œç®€å•çš„è¯´æ˜ï¼š</p></blockquote><p><img src="1.jpg" alt="å›¾1 åå¤„ç†ç¤ºæ„å›¾"></p><blockquote><p>è‡³æ­¤ï¼Œbox_headçš„inferenceæ–‡ä»¶å·²ç»ä»‹ç»å®Œäº†è¯¥æ–‡ä»¶ä¸»è¦æ˜¯ç”¨äºinferenceè¿‡ç¨‹ï¼Œè®­ç»ƒè¿‡ç¨‹å¹¶æœªç”¨åˆ°è¯¥æ–‡ä»¶ã€‚é€šè¿‡æ–‡ä»¶ä¸­çš„make_roi_box_post_processor()å‡½æ•°ç”ŸæˆPostProcessorç±»å¯¹è±¡ï¼Œå¯¹box_headéƒ¨åˆ†é¢„æµ‹å¥½çš„Proposalsè¿›è¡Œåå¤„ç†æ“ä½œï¼Œé€‰å‡ºæœ€åä½œä¸ºè¾“å‡ºçš„instancesã€‚</p></blockquote><blockquote><p>ä¸‹ä¸€ç¯‡å°†ä»‹ç»ç”¨äºbox_headè®­ç»ƒé˜¶æ®µçš„lossæ–‡ä»¶ï¼š</p><p><a href="https://kingpopen.github.io/2021/08/03/maskrcnn-benchmark-master-shi-box-head-de-loss-wen-jian/">maskrcnn-benchmark-masterï¼ˆåï¼‰ï¼šbox_headçš„lossæ–‡ä»¶ </a></p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benchmark-masterï¼ˆå…«ï¼‰ï¼šbuild_roi_box_head()å‡½æ•°</title>
      <link href="/2021/08/02/maskrcnn-benchmark-master-ba-build-roi-box-head-han-shu/"/>
      <url>/2021/08/02/maskrcnn-benchmark-master-ba-build-roi-box-head-han-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>æœ¬ç¯‡å°†ä»‹ç»build_roi_box_head()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯åœ¨<strong>your_project/maskrcnn_benchmark/modeling/roi_heads/box_head/box_head.py</strong>æ–‡ä»¶ä¸­</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_roi_box_head</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Constructs a new box head.    By default, uses ROIBoxHead, but if it turns out not to be enough, just register a new class    and make it a parameter in the config    """</span>    <span class="token comment"># ä¸»è¦è¿”å›ä¸€ä¸ªROIBoxHeadç±»å¯¹è±¡</span>    <span class="token keyword">return</span> ROIBoxHead<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸€ã€ROIBoxHeadç±»"><a href="#ä¸€ã€ROIBoxHeadç±»" class="headerlink" title="ä¸€ã€ROIBoxHeadç±»"></a>ä¸€ã€ROIBoxHeadç±»</h3><blockquote><p>ä»ä»£ç å¯çŸ¥ï¼Œbuild_roi_box_head()ä¸»è¦æ˜¯è¿”å›ä¸€ä¸ªROIBoxHeadç±»å¯¹è±¡ï¼Œçœ‹æ¥æˆ‘ä»¬ä¸»è¦éœ€è¦äº†è§£çš„ç›®æ ‡å°±æ˜¯è¿™ä¸ªROIBoxHeadç±»äº†ï¼Œè¿™ä¸ªç±»ä¹Ÿæ˜¯åœ¨your_project/maskrcnn_benchmark/modeling/roi_heads/box_head/box_head.pyæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹__init__()å‡½æ•°:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ROIBoxHead</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Generic Box Head class.    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>ROIBoxHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># ROIå±‚ä¸­çš„ç‰¹å¾æå–å™¨ï¼ˆå…ˆè¿›è¡ŒROI Alignï¼Œåç»­æœ‰æ²¡æœ‰ç‰¹å¾æå–æ“ä½œçœ‹å…·ä½“headçš„æ–¹æ³•ï¼‰</span>        <span class="token comment"># å› ä¸ºRPNæå–çš„Proposalså¤§å°éƒ½ä¸å¤ªä¸€æ ·ï¼Œä¸ºäº†ä½¿å¾—è¿™äº›Proposalsçš„å›¾ç‰‡ç‰¹å¾å¤§å°ä¸€æ ·ï¼Œ</span>        <span class="token comment"># éœ€è¦è¿›è¡ŒROI Alignæ“ä½œå¾—åˆ°å¤§å°ä¸€æ ·çš„ç‰¹å¾ã€‚</span>        self<span class="token punctuation">.</span>feature_extractor <span class="token operator">=</span> make_roi_box_feature_extractor<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span>         <span class="token comment"># ROIå±‚ä¸­çš„è¾¹æ¡†é¢„æµ‹ç±»ï¼ˆç”¨äºç±»åˆ«çš„åˆ†ç±»å’Œboxçš„å›å½’~ï¼‰</span>        self<span class="token punctuation">.</span>predictor <span class="token operator">=</span> make_roi_box_predictor<span class="token punctuation">(</span>            cfg<span class="token punctuation">,</span> self<span class="token punctuation">.</span>feature_extractor<span class="token punctuation">.</span>out_channels<span class="token punctuation">)</span>         <span class="token comment"># ä¸‹é¢è¿™ä¸¤ä¸ªå’ŒRPNä¸­çš„å¾ˆç›¸åƒ</span>        <span class="token comment"># ROIå±‚ä¸­çš„åå¤„ç†ç±»ï¼ˆinferenceè¿‡ç¨‹ è¿›è¡ŒNMSæ“ä½œå’Œboxè§£ç ç­‰æ“ä½œï¼‰</span>        self<span class="token punctuation">.</span>post_processor <span class="token operator">=</span> make_roi_box_post_processor<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>        <span class="token comment"># è®­ç»ƒè¿‡ç¨‹è®¡ç®—loss</span>        self<span class="token punctuation">.</span>loss_evaluator <span class="token operator">=</span> make_roi_box_loss_evaluator<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ¥ç€æˆ‘ä»¬çœ‹ä¸€ä¸‹è¯¥ç±»çš„forward()å‡½æ•°ï¼Œäº†è§£è¯¥ç±»çš„ä¸€ä¸ªå¤„ç†æµç¨‹ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Arguments:        features (list[Tensor]): feature-maps from possibly several levels        proposals (list[BoxList]): proposal boxes        targets (list[BoxList], optional): the ground-truth targets.    Returns:        x (Tensor): the result of the feature extractor        proposals (list[BoxList]): during training, the subsampled proposals            are returned. During testing, the predicted boxlists are returned        losses (dict[Tensor]): During training, returns the losses for the            head. During testing, returns an empty dict.        xæ˜¯ç‰¹å¾æå–å™¨æå–çš„ç‰¹å¾        proposalsåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š              1ã€åœ¨è®­ç»ƒé˜¶æ®µï¼Œè¿™æ˜¯é‡‡æ ·å¥½ç”¨äºè®­ç»ƒçš„Proposals              2ã€åœ¨æµ‹è¯•é˜¶æ®µï¼Œè¿™æ˜¯é¢„æµ‹å¥½çš„boxlists        lossä¹Ÿåˆ†ä¸¤ç§æƒ…å†µï¼š                1ã€åœ¨è®­ç»ƒé˜¶æ®µï¼Œè¿™æ˜¯box_headçš„æ¨¡å—çš„losså€¼ã€‚              2ã€åœ¨æµ‹è¯•é˜¶æ®µï¼Œè¿™æ˜¯ä¸€ä¸ªç©ºçš„å­—å…¸ã€‚    """</span>     <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>        <span class="token comment"># Faster R-CNN subsamples during training the proposals with a fixed</span>        <span class="token comment"># positive / negative ratio</span>        <span class="token comment"># ç­›é€‰ç”¨äºè®­ç»ƒé˜¶æ®µè®¡ç®—lossçš„Proposals</span>        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_evaluator<span class="token punctuation">.</span>subsample<span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>     <span class="token comment"># extract features that will be fed to the final classifier. The</span>    <span class="token comment"># feature_extractor generally corresponds to the pooler + heads</span>    <span class="token comment"># feature_extractoræ˜¯ç”¨æ¥æå–ç‰¹å¾ä¼ è¾“ç»™æœ€ç»ˆçš„åˆ†ç±»å™¨</span>    <span class="token comment"># feature_extractoræ˜¯ç”±pooler å±‚ + heads ç»„æˆçš„</span>    x <span class="token operator">=</span> self<span class="token punctuation">.</span>feature_extractor<span class="token punctuation">(</span>features<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span>    <span class="token comment"># final classifier that converts the features into predictions</span>    <span class="token comment"># åˆ†ç±»å™¨è¿›è¡Œæœ€åçš„é¢„æµ‹</span>    class_logits<span class="token punctuation">,</span> box_regression <span class="token operator">=</span> self<span class="token punctuation">.</span>predictor<span class="token punctuation">(</span>x<span class="token punctuation">)</span>     <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>        <span class="token comment"># å¦‚æœä¸æ˜¯è®­ç»ƒé˜¶æ®µï¼Œåˆ™è¦å¯¹é¢„æµ‹çš„ç»“æœè¿›è¡Œåå¤„ç†  æœ€åè¾“å‡ºæ£€æµ‹ç»“æœ</span>        result <span class="token operator">=</span> self<span class="token punctuation">.</span>post_processor<span class="token punctuation">(</span><span class="token punctuation">(</span>class_logits<span class="token punctuation">,</span> box_regression<span class="token punctuation">)</span><span class="token punctuation">,</span> proposals<span class="token punctuation">)</span>        <span class="token keyword">return</span> x<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment"># è®¡ç®—boxçš„å›å½’losså’Œç±»åˆ«çš„åˆ†ç±»loss</span>    loss_classifier<span class="token punctuation">,</span> loss_box_reg <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_evaluator<span class="token punctuation">(</span>        <span class="token punctuation">[</span>class_logits<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>box_regression<span class="token punctuation">]</span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>        x<span class="token punctuation">,</span>        proposals<span class="token punctuation">,</span>        <span class="token builtin">dict</span><span class="token punctuation">(</span>loss_classifier<span class="token operator">=</span>loss_classifier<span class="token punctuation">,</span> loss_box_reg<span class="token operator">=</span>loss_box_reg<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ç”±ROIBoxHeadç±»å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸»è¦æ¶‰åŠäº†å››ä¸ªå‡½æ•°:</p><ol><li><strong>make_roi_box_feature_extractor()</strong>:åŒ…å«æœ‰ROI Alignæ“ä½œï¼Œç”¨æ¥æå–sizeä¸€è‡´çš„ç‰¹å¾ã€‚</li><li><strong>make_roi_box_predictor()</strong>:feature_extractoræå–çš„ç‰¹å¾è¿›è¡Œç±»åˆ«åˆ†ç±»å’Œboxçš„å›å½’ã€‚</li><li><strong>make_roi_box_post_processor()</strong>:å¦‚æœæ˜¯inferenceè¿‡ç¨‹ï¼Œé€šè¿‡è¯¥å‡½æ•°å¯¹é¢„æµ‹çš„ç»“æœè¿›è¡Œç­›é€‰ï¼Œè¾“å‡ºæœ€ç»ˆçš„æ£€æµ‹ç»“æœï¼ˆRPNçš„RPNPostProcessorç±»æ˜¯ä¸æ˜¯å¾ˆç›¸ä¼¼~ï¼‰</li><li><strong>make_roi_box_loss_evaluator()</strong>:å¦‚æœæ˜¯è®­ç»ƒè¿‡ç¨‹ï¼Œé€šè¿‡è¯¥å‡½æ•°å¯¹é¢„æµ‹çš„ç»“æœç­›é€‰å‡ºæ­£è´Ÿæ ·æœ¬ç”¨äºè®¡ç®—box_headæ¨¡å—çš„lossã€‚</li></ol><p>æ¥ä¸‹æ¥æˆ‘å°†ä¸€ä¸€ä»‹ç»ï¼ˆæ•´ä½“ç»“æ„ç®€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼‰ï¼š</p></blockquote><p><img src="1.jpg" alt="å›¾1 ROI headç»“æ„å›¾"></p><h3 id="äºŒã€make-roi-box-feature-extractor"><a href="#äºŒã€make-roi-box-feature-extractor" class="headerlink" title="äºŒã€make_roi_box_feature_extractor()"></a>äºŒã€make_roi_box_feature_extractor()</h3><blockquote><p>è¯¥å‡½æ•°åœ¨<strong>your_project/maskrcnn_benchmark/modeling/roi_heads/box_head/roi_box_feature_extractors.py</strong>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç›¸å…³ä»£ç ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">make_roi_box_feature_extractor</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># ä½¿ç”¨æ³¨å†Œå™¨è·å–è¯¥ROI_BOX_FEATURE_EXTRACTORSæ¨¡å—çš„å¯¹è±¡</span>    <span class="token comment"># å¯¹åº”çš„ROI_BOX_FEATURE_EXTRACTORSæ¨¡å—éƒ½å®šä¹‰åœ¨è¯¥å‡½æ•°ä¸Šé¢</span>    func <span class="token operator">=</span> registry<span class="token punctuation">.</span>ROI_BOX_FEATURE_EXTRACTORS<span class="token punctuation">[</span>        cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_BOX_HEAD<span class="token punctuation">.</span>FEATURE_EXTRACTOR    <span class="token punctuation">]</span>    <span class="token keyword">return</span> func<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä½¿ç”¨æ³¨å†Œå™¨æ¥è·å–å‚æ•°ä¸­å®šä¹‰çš„feature_extractorï¼Œæˆ‘ä»¬åœ¨è¯¥æ–‡ä»¶ä¸­æ‰¾åˆ°äº†ä¸‰ç§feature_extractor,å®ƒä»¬åˆ†åˆ«æ˜¯ï¼šResNet50Conv5ROIFeatureExtractorã€FPN2MLPFeatureExtractorã€FPNXconv1fcFeatureExtractorã€‚å¦‚æœä½ è‡ªå·±æƒ³è¦é‡æ–°å®šä¹‰ä¸€ä¸ªï¼Œä½ ä¹Ÿå¯ä»¥æŒ‰ç…§è¿™äº›ç±»çš„ç»“æ„ï¼Œé‡æ–°å†™ä¸€ä¸ªfeature extractorï¼Œå¹¶ç»™è¯¥ç±»æ³¨å†Œå¯¹åº”çš„åç§°ï¼Œåœ¨å‚æ•°æ–‡ä»¶å¯¹åº”ä½ç½®ä½¿ç”¨è¯¥åç§°ã€‚æˆ‘æ¥ä¸‹æ¥å¯¹ç¨å¾®ç®€å•ä¸€äº›çš„FPN2MLPFeatureExtractorç±»çš„ä»£ç åšä¸€ä¸ªä»‹ç»ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åœ¨æ³¨å†Œå™¨ä¸­è¿›è¡Œæ³¨å†Œ</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>ROI_BOX_FEATURE_EXTRACTORS<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"FPN2MLPFeatureExtractor"</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">FPN2MLPFeatureExtractor</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Heads for FPN for classification    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>FPN2MLPFeatureExtractor<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment"># Proposalsç»è¿‡ROI Alignä¹‹åå¾—åˆ°sizeå¤§å°</span>        resolution <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_BOX_HEAD<span class="token punctuation">.</span>POOLER_RESOLUTION        scales <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_BOX_HEAD<span class="token punctuation">.</span>POOLER_SCALES        sampling_ratio <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_BOX_HEAD<span class="token punctuation">.</span>POOLER_SAMPLING_RATIO        <span class="token comment"># è¿›è¡ŒROI Alignæ“ä½œ</span>        pooler <span class="token operator">=</span> Pooler<span class="token punctuation">(</span>            output_size<span class="token operator">=</span><span class="token punctuation">(</span>resolution<span class="token punctuation">,</span> resolution<span class="token punctuation">)</span><span class="token punctuation">,</span>            scales<span class="token operator">=</span>scales<span class="token punctuation">,</span>            sampling_ratio<span class="token operator">=</span>sampling_ratio<span class="token punctuation">,</span>        <span class="token punctuation">)</span>        <span class="token comment"># ROI Alignä¹‹åå¾—åˆ°çš„ç»´åº¦</span>        input_size <span class="token operator">=</span> in_channels <span class="token operator">*</span> resolution <span class="token operator">**</span> <span class="token number">2</span>        <span class="token comment"># å…¨è¿æ¥å±‚çš„è¾“å‡ºç»´åº¦</span>        representation_size <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_BOX_HEAD<span class="token punctuation">.</span>MLP_HEAD_DIM        use_gn <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_BOX_HEAD<span class="token punctuation">.</span>USE_GN        <span class="token comment"># å®šä¹‰ROI Alignçš„ç±»å˜é‡</span>        self<span class="token punctuation">.</span>pooler <span class="token operator">=</span> pooler        <span class="token comment"># å®šä¹‰å…¨è¿æ¥å±‚çš„ç±»å˜é‡</span>        self<span class="token punctuation">.</span>fc6 <span class="token operator">=</span> make_fc<span class="token punctuation">(</span>input_size<span class="token punctuation">,</span> representation_size<span class="token punctuation">,</span> use_gn<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>fc7 <span class="token operator">=</span> make_fc<span class="token punctuation">(</span>representation_size<span class="token punctuation">,</span> representation_size<span class="token punctuation">,</span> use_gn<span class="token punctuation">)</span>        <span class="token comment"># æå–ç‰¹å¾ä¹‹åå¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºç»´åº¦</span>        self<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> representation_size     <span class="token comment"># è¿›è¡Œæå–ç‰¹å¾æ“ä½œ</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># ROI Alignæ“ä½œ</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pooler<span class="token punctuation">(</span>x<span class="token punctuation">,</span> proposals<span class="token punctuation">)</span>        <span class="token comment"># è¿›è¡Œå±•å¹³ ä½œä¸ºå…¨è¿æ¥å±‚çš„è¾“å‡º</span>        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># è¿›è¡Œå…¨è¿æ¥å±‚æ“ä½œ</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc6<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc7<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># è¿”å›æå–çš„ç‰¹å¾</span>        <span class="token keyword">return</span> x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ€»çš„æ¥çœ‹feature_extractorçš„ç›¸å…³ä»£ç ç›¸å¯¹è¿˜æ˜¯æ¯”è¾ƒå¥½æ‡‚çš„ã€‚</p></blockquote><h3 id="ä¸‰ã€-make-roi-box-predictor"><a href="#ä¸‰ã€-make-roi-box-predictor" class="headerlink" title="ä¸‰ã€ make_roi_box_predictor()"></a>ä¸‰ã€ make_roi_box_predictor()</h3><blockquote><p>æ¥ä¸‹æ¥çœ‹ç”¨ä½œç±»åˆ«åˆ†ç±»åˆ¤æ–­å’Œboxå›å½’çš„roi_box_predictor()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨<strong>your_project/maskrcnn_benchmark/modeling/roi_heads/box_head/roi_box_predictors.py</strong>æ–‡ä»¶ä¸­ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">make_roi_box_predictor</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>    func <span class="token operator">=</span> registry<span class="token punctuation">.</span>ROI_BOX_PREDICTOR<span class="token punctuation">[</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_BOX_HEAD<span class="token punctuation">.</span>PREDICTOR<span class="token punctuation">]</span>    <span class="token keyword">return</span> func<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>å¯ä»¥çœ‹å‡ºè¿™ä¸ªå‡½æ•°å’Œmake_roi_box_feature_extractorï¼ˆï¼‰å‡½æ•°åŸºæœ¬ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡æ³¨å†Œå™¨è·å–ç›¸å…³æ‰€éœ€çš„å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨åˆ°è¯¥å‡½æ•°ä¸Šæ–¹è¢«æ³¨å†Œçš„2ä¸ªpredictorç±»ä¸Šï¼šFastRCNNPredictorç±»å’ŒFPNPredictorç±»ï¼Œä¸‹é¢å°±ä»¥FastRCNNPredictorç±»çš„ä»£ç ä¸ºä¾‹ï¼Œåšç®€è¦çš„ä»‹ç»ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å¯¹ç‰¹å¾å…ˆè¿›è¡Œæ± åŒ–ï¼Œå†ä½¿ç”¨è¾¹æ¡†åˆ†ç±»å™¨è¿›è¡Œåˆ†ç±»å’Œè¾¹æ¡†å›å½’å™¨è¿›è¡Œå›å½’</span><span class="token comment"># é¦–å…ˆåœ¨æ³¨å†Œå™¨ROI_BOX_PREDICTORä¸Šæ³¨å†Œè¯¥ç±»</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>ROI_BOX_PREDICTOR<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"FastRCNNPredictor"</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">FastRCNNPredictor</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>FastRCNNPredictor<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">assert</span> in_channels <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>        <span class="token comment"># è¾“å…¥ç»´åº¦</span>        num_inputs <span class="token operator">=</span> in_channels         <span class="token comment"># åˆ†ç±»çš„ç±»åˆ«æ•°= ç±»åˆ«æ•° + 1ï¼ˆèƒŒæ™¯ï¼‰</span>        num_classes <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_BOX_HEAD<span class="token punctuation">.</span>NUM_CLASSES        <span class="token comment"># è¿›è¡Œå…¨å±€å¹³å‡æ± åŒ–</span>        self<span class="token punctuation">.</span>avgpool <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># å…¨è¿æ¥å±‚ç”¨äºåˆ†ç±»</span>        self<span class="token punctuation">.</span>cls_score <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>        num_bbox_reg_classes <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">if</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>CLS_AGNOSTIC_BBOX_REG <span class="token keyword">else</span> num_classes        <span class="token comment"># å…¨è¿æ¥å±‚ç”¨äºboxçš„åæ ‡å›å½’</span>        self<span class="token punctuation">.</span>bbox_pred <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_inputs<span class="token punctuation">,</span> num_bbox_reg_classes <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>        <span class="token comment"># ç±»åˆ«åˆ†ç±»å‚æ•°åˆå§‹åŒ–</span>        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cls_score<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cls_score<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment"># boxå›å½’å‚æ•°åˆå§‹åŒ–</span>        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>     <span class="token comment"># æ‰§è¡Œè¿‡ç¨‹</span>    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># å¹³å‡æ± åŒ–</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>avgpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token comment"># å±•å¹³</span>        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># ä½¿ç”¨å…¨è¿æ¥å±‚è¿›è¡Œåˆ†ç±»</span>        cls_logit <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_score<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token comment"># ä½¿ç”¨å…¨è¿æ¥å±‚è¿›è¡Œboxå›å½’</span>        bbox_pred <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">(</span>x<span class="token punctuation">)</span>        <span class="token comment"># è¿”å›ç»“æœ</span>        <span class="token keyword">return</span> cls_logit<span class="token punctuation">,</span> bbox_pred<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ€»çš„æ¥çœ‹roi_box_predictorç›¸å…³ä»£ç ä¹Ÿæ˜¯æ¯”è¾ƒå¥½æ‡‚çš„ï¼Œå°±æ˜¯æ­£å¸¸pytorchå†™çš„ç½‘ç»œç»“æ„ä»£ç ã€‚</p></blockquote><blockquote><p>æ¥ä¸‹æ¥å°†ä¼šä»‹ç» make_roi_box_post_processor()å‡½æ•°ï¼Œå®ƒæ˜¯åœ¨box_headçš„inference.pyæ–‡ä»¶ä¸­ï¼Œä»¥åŠmake_roi_box_loss_evaluator()å‡½æ•°ï¼Œå®ƒæ˜¯åœ¨box_headçš„loss.pyä¸­ï¼Œç”±äºè¿™ä¸¤ä¸ªéƒ¨åˆ†çš„å†…å®¹æœ‰äº›å¤šï¼Œæ‰€ä»¥å†³å®šæ”¾åˆ°ä¸‹ä¸ªåšå®¢è¿›è¡Œä»‹ç»ï¼š</p><p><a href="https://kingpopen.github.io/2021/08/03/maskrcnn-benchmark-master-jiu-box-head-de-inference-wen-jian/">maskrcnn-benchmark-masterï¼ˆä¹ï¼‰ï¼šbox_headçš„inferenceæ–‡ä»¶</a></p><p><a href="https://kingpopen.github.io/2021/08/03/maskrcnn-benchmark-master-shi-box-head-de-loss-wen-jian/">maskrcnn-benchmark-masterï¼ˆåï¼‰ï¼šbox_headçš„lossæ–‡ä»¶</a></p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benchmark-masterï¼ˆä¸ƒï¼‰ï¼šbuild_roi_heads()å‡½æ•°</title>
      <link href="/2021/08/02/maskrcnn-benchmark-master-qi-build-roi-heads-han-shu/"/>
      <url>/2021/08/02/maskrcnn-benchmark-master-qi-build-roi-heads-han-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>æˆªè‡³ä¸Šä¸€ç¯‡åšå®¢ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»å®ŒRPNçš„æ•´ä¸ªæµç¨‹ï¼ŒRPNçš„ä½œç”¨æ˜¯æå–Proposalsä¼ å…¥ROI_headséƒ¨åˆ†ï¼Œç„¶è€ŒROIæœ‰å“ªäº›headså‘¢ï¼Ÿæ ¹æ®ä¸åŒçš„ä»»åŠ¡ï¼Œä»£ç åˆ†ä¸ºäº†box_headï¼Œkeypoint_headï¼Œmask_headã€‚box_headï¼šè¿›è¡Œbounding boxçš„å›å½’ä»¥åŠç±»åˆ«çš„åˆ†ç±»ä»»åŠ¡ã€‚</p><p>keypoint_headï¼šè¿›è¡Œå…³é”®ç‚¹çš„æ£€æµ‹ã€‚ï¼ˆè¿™éƒ¨åˆ†ä»£ç æˆ‘å·²ç»ä»é¡¹ç›®ä¸­å»é™¤æ‰äº†ï¼‰</p><p>mask_headï¼šè¿›è¡Œmaskçš„åˆ†å‰²ä»»åŠ¡ã€‚</p></blockquote><h3 id="ä¸€ã€CombinedROIHeadsç±»"><a href="#ä¸€ã€CombinedROIHeadsç±»" class="headerlink" title="ä¸€ã€CombinedROIHeadsç±»"></a>ä¸€ã€CombinedROIHeadsç±»</h3><blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¼€å¯ROI_headsçš„ä»‹ç»ç¯‡ç« ï¼Œbuild_roi_heads()å‡½æ•°åœ¨your_project/maskrcnn_benchmark/modeling/roi_heads/roi_heads.pyæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ‰“å¼€è¿™ä¸ªæ–‡ä»¶,é¦–å…ˆå¼•å…¥çœ¼å¸˜çš„æ˜¯CombinedROIHeadsç±»ï¼Œé€šè¿‡è¿™ä¸ªç±»çš„åå­—ï¼Œæˆ‘ä»¬æ˜“å¯çŸ¥è¿™ä¸ªç±»çš„ä½œç”¨æ˜¯å°†box_headï¼Œkeypoint_headï¼Œmask_headè¿™å‡ ä¸ªæ¨¡å—éƒ½æ•´åˆåœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç›¸å…³ä»£ç ï¼ˆå…³äºkeypoint_headçš„ä»£ç æˆ‘å·²ç»åˆ æ‰äº†~ï¼‰ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">CombinedROIHeads</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>ModuleDict<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Combines a set of individual heads (for box prediction or masks) into a single    head.    åˆå¹¶è®¸å¤šä¸ªå•ç‹¬çš„headä¸ºä¸€ä¸ªç»Ÿä¸€çš„heads    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> heads<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>CombinedROIHeads<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>heads<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>cfg <span class="token operator">=</span> cfg<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># å¦‚æœboxå’Œmaskçš„headçš„ç‰¹å¾å…±äº«ï¼Œåˆ™å°†box headçš„features èµ‹å€¼ç»™mask head</span>        <span class="token keyword">if</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>MASK_ON <span class="token keyword">and</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_MASK_HEAD<span class="token punctuation">.</span>SHARE_BOX_FEATURE_EXTRACTOR<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>mask<span class="token punctuation">.</span>feature_extractor <span class="token operator">=</span> self<span class="token punctuation">.</span>box<span class="token punctuation">.</span>feature_extractor     <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        losses <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token comment"># TODO rename x to roi_box_features, </span>        <span class="token comment"># if it doesn't increase memory consumption</span>        <span class="token comment"># box headçš„loss</span>        <span class="token comment"># self.boxå°±æ˜¯ä¸€ä¸ªbox_headçš„å¯¹è±¡ï¼ˆåç»­çš„åšå®¢å†ä»‹ç»ï¼‰ </span>        <span class="token comment"># è¿”å›ç»“æœæ˜¯box_headéƒ¨åˆ†æå–çš„ç‰¹å¾ï¼Œdetectionsæ˜¯æ£€æµ‹çš„ç»“æœï¼Œloss_boxæ˜¯æŸå¤±å‡½æ•°</span>        x<span class="token punctuation">,</span> detections<span class="token punctuation">,</span> loss_box <span class="token operator">=</span> self<span class="token punctuation">.</span>box<span class="token punctuation">(</span>features<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss_box<span class="token punctuation">)</span>         <span class="token comment"># å¦‚æœå­˜åœ¨mask åˆ†æ”¯</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>MASK_ON<span class="token punctuation">:</span>            mask_features <span class="token operator">=</span> features            <span class="token comment"># optimization: during training, if we share the feature extractor between</span>            <span class="token comment"># the box and the mask heads, then we can reuse the features already computed</span>            <span class="token comment"># ä¼˜åŒ–ï¼šåœ¨è®­ç»ƒé˜¶æ®µï¼Œå¦‚æœæˆ‘ä»¬å…±äº«äº†box head å’Œ mask headçš„ç‰¹å¾æå–å™¨ï¼Œ </span>            <span class="token comment"># æˆ‘ä»¬å¯ä»¥é‡å¤ä½¿ç”¨box headæ‰€è®¡ç®—çš„featureç”¨äºmask head</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>                self<span class="token punctuation">.</span>training                <span class="token keyword">and</span> self<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>ROI_MASK_HEAD<span class="token punctuation">.</span>SHARE_BOX_FEATURE_EXTRACTOR            <span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token comment"># å¦‚æœmask_featureå…±äº«boxçš„ç‰¹å¾ </span>                <span class="token comment"># å°±å°†box_headéƒ¨åˆ†æå–çš„ç‰¹å¾èµ‹äºˆmask_features</span>                mask_features <span class="token operator">=</span> x            <span class="token comment"># During training, self.box() will return the unaltered proposals as "detections"</span>            <span class="token comment"># this makes the API consistent during training and testing</span>            <span class="token comment"># è®­ç»ƒé˜¶æ®µï¼Œ self.box() ä¼šè¿”å›æœªç»å˜æ¢çš„proposalsä½œä¸ºæ£€æµ‹ç»“æœ</span>            <span class="token comment"># å°†maskçš„çš„æ£€æµ‹ç»“æœåŠ å…¥detectionsä¸­ï¼Œå¹¶è®¡ç®—maskçš„lossè¿”å›ã€‚</span>            x<span class="token punctuation">,</span> detections<span class="token punctuation">,</span> loss_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>mask<span class="token punctuation">(</span>mask_features<span class="token punctuation">,</span> detections<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>            losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>loss_mask<span class="token punctuation">)</span>         <span class="token keyword">return</span> x<span class="token punctuation">,</span> detections<span class="token punctuation">,</span> losses  <span class="token comment"># ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºbox_headå’Œmask_headå’Œä¹‹å‰ä»‹ç»çš„rpn_headså¾ˆç›¸åƒï¼Œ</span><span class="token comment"># è¿”å›çš„ç»“æœéƒ½åŒ…å«æœ‰æ£€æµ‹çš„ç»“æœå’Œloss</span><span class="token comment"># rpn_headè¿”å›:Proposals(ç›¸å½“äºRPNæ£€æµ‹çš„bounding box å’Œç±»åˆ«ç»“æœ), rpn_loss</span><span class="token comment"># box_headè¿”å›:æå–çš„ç‰¹å¾x, æ£€æµ‹çš„bounding boxå’Œç±»åˆ«åˆ†ç±»ç»“æœdetections, box_loss</span><span class="token comment"># mask_headè¿”å›:æå–çš„ç‰¹å¾x, æ£€æµ‹çš„maskç»“æœå¹¶åŠ ä¸Šä¹‹å‰çš„box_headçš„æ£€æµ‹ç»“æœ, mask_loss</span><span class="token comment"># å› æ­¤æ¨æ–­box_headå¯¹è±¡å’Œmask_headå¯¹è±¡ä¸­åº”è¯¥ä¹Ÿæ˜¯åŒ…å«æœ‰ç›¸åº”çš„lossè®¡ç®—æ–‡ä»¶å’Œinferenceæ–‡ä»¶çš„</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="äºŒã€build-roi-heads-å‡½æ•°"><a href="#äºŒã€build-roi-heads-å‡½æ•°" class="headerlink" title="äºŒã€build_roi_heads()å‡½æ•°"></a>äºŒã€build_roi_heads()å‡½æ•°</h3><blockquote><p>æ¥ç€æˆ‘ä»¬çœ‹build_roi_heads()å‡½æ•°çš„ç›¸å…³ä»£ç :</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ›å»ºroi heads</span><span class="token keyword">def</span> <span class="token function">build_roi_heads</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># individually create the heads, that will be combined together</span>    <span class="token comment"># afterwards</span>    roi_heads <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RETINANET_ON<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>     <span class="token comment"># æ ¹æ®é…ç½®æ–‡ä»¶ä¾æ¬¡æ·»åŠ å„ä¸ªhead</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN_ONLY<span class="token punctuation">:</span>        <span class="token comment"># æ·»åŠ boxes head</span>        <span class="token comment"># é€šè¿‡build_roi_box_head()åˆ›å»ºroi_box_headåˆ†æ”¯</span>        roi_heads<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"box"</span><span class="token punctuation">,</span> build_roi_box_head<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>MASK_ON<span class="token punctuation">:</span>        <span class="token comment"># æ·»åŠ mask head</span>        <span class="token comment"># é€šè¿‡build_roi_mask_head()åˆ›å»ºroi_mask_headåˆ†æ”¯</span>        roi_heads<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"mask"</span><span class="token punctuation">,</span> build_roi_mask_head<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment"># combine individual heads in a single module</span>    <span class="token comment"># å°†ç‹¬ç«‹çš„åˆ†æ”¯è¿›è¡Œåˆå¹¶</span>    <span class="token keyword">if</span> roi_heads<span class="token punctuation">:</span>        roi_heads <span class="token operator">=</span> CombinedROIHeads<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> roi_heads<span class="token punctuation">)</span>     <span class="token keyword">return</span> roi_heads<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä»build_roi_headsä»£ç å¯ä»¥çœ‹å‡ºï¼Œå®ƒä¸»è¦æ˜¯é€šè¿‡build_roi_box_head()å‡½æ•°å’Œbuild_roi_mask_head()å‡½æ•°æ¥ç”Ÿæˆbox_headå’Œmask_headåˆ†æ”¯ï¼Œæœ€åé€šè¿‡CombinedROIHeadsç±»å°†è¿™ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œæ•´åˆï¼Œæ•´ä½“çš„ç»“æ„ç®€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><p><img src="1.jpg" alt="å›¾1 ROI headsç»“æ„å›¾"></p><blockquote><p>build_roi_box_headï¼ˆï¼‰å‡½æ•°å°†æ”¾åœ¨ä¸‹ä¸€ç¯‡åšå®¢ä»‹ç»:</p><p>maskrcnn-benchmark-masterï¼ˆå…«ï¼‰ï¼š<a href="https://kingpopen.github.io/2021/08/02/maskrcnn-benchmark-master-ba-build-roi-box-head-han-shu/">build_roi_box_head()å‡½æ•°</a></p><p>build_roi_mask_headï¼ˆï¼‰å‡½æ•°å¾…ç»­~</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benchmark-masterï¼ˆå…­ï¼‰ï¼šRPNçš„lossæ–‡ä»¶</title>
      <link href="/2021/08/01/maskrcnn-benchmark-master-liu-rpn-de-loss-wen-jian/"/>
      <url>/2021/08/01/maskrcnn-benchmark-master-liu-rpn-de-loss-wen-jian/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ä¸Šæ¬¡ä»‹ç»å®Œäº†RPNçš„inferenceæ–‡ä»¶ï¼Œè¿™æ¬¡æ¥ç€ä»‹ç»RPNçš„lossæ–‡ä»¶ï¼ŒRPNå¯ä»¥å½“ä½œä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—æ¥çœ‹å¾…ï¼Œå®ƒä½œç”¨å°±æ˜¯è¿›è¡Œç‰©ä½“çš„æ£€æµ‹ï¼ˆæ˜¯å¦ä¸ºéœ€è¦æ£€æµ‹çš„ç‰©ä½“  ä»¥åŠ åœ¨ä»€ä¹ˆä½ç½®ï¼‰ï¼Œæ‰€ä»¥RPNé˜¶æ®µæ˜¯æœ‰ä¸€ä¸ªå•ç‹¬çš„losséœ€è¦è®¡ç®—çš„ã€‚</p><p>æ³¨ï¼šè¿™é‡Œå¼ºè°ƒä¸¤ä¸ªæ¦‚å¿µ</p><ol><li>anchor  æ˜¯ç½‘ç»œé¢„å…ˆå›ºå®šå¥½ä½ç½®å’Œå¤§å°çš„bounding boxã€‚</li><li>proposalæ˜¯é€šè¿‡ç½‘ç»œé€šè¿‡å­¦ä¹ ç»™anchoråŠ ä¸Šä¸€å®šåç§»é‡å¾—åˆ°çš„bounding boxã€‚</li></ol><p><strong>åˆ†é…GTæ ‡ç­¾æ˜¯åœ¨anchorçš„åŸºç¡€ä¸Šè¿›è¡Œåˆ¤æ–­åˆ†é…çš„ï¼Œè€Œä¸æ˜¯åœ¨Proposalçš„åŸºç¡€ä¸Šè¿›è¡Œåˆ¤æ–­åˆ†é…çš„ã€‚</strong></p></blockquote><h3 id="ä¸€ã€make-rpn-loss-evaluator"><a href="#ä¸€ã€make-rpn-loss-evaluator" class="headerlink" title="ä¸€ã€make_rpn_loss_evaluator()"></a>ä¸€ã€make_rpn_loss_evaluator()</h3><blockquote><p>RPNçš„lossæ–‡ä»¶åœ¨your_project/maskrcnn_benchmark/modeling/rpn/loss.pyæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹åˆ°make_rpn_loss_evaluator()å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># RPNæ¨¡å—æ˜¯é€šè¿‡è°ƒç”¨è¿™ä¸ªå‡½æ•° ç”¨äº è®¡ç®—lossçš„</span><span class="token keyword">def</span> <span class="token function">make_rpn_loss_evaluator</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> box_coder<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># åŒ¹é…å™¨ ç”¨äºç»™Proposalsåˆ†é…çœŸå®çš„æ ‡ç­¾</span>    matcher <span class="token operator">=</span> Matcher<span class="token punctuation">(</span>        cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>FG_IOU_THRESHOLD<span class="token punctuation">,</span>        cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>BG_IOU_THRESHOLD<span class="token punctuation">,</span>        allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>     <span class="token comment"># æ­£è´Ÿæ ·æœ¬ç­›é€‰å™¨ï¼ˆåªæœ‰å‰æ™¯å’ŒèƒŒæ™¯ä¸¤ä¸ªç±»åˆ«ï¼‰ é€‰æ‹©ç”¨äºè®­ç»ƒçš„æ ·æœ¬</span>    fg_bg_sampler <span class="token operator">=</span> BalancedPositiveNegativeSampler<span class="token punctuation">(</span>        cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>BATCH_SIZE_PER_IMAGE<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>POSITIVE_FRACTION    <span class="token punctuation">)</span>     <span class="token comment"># æŸå¤±çš„è®¡ç®—å™¨  ç”¨äºè®¡ç®—RPNé˜¶æ®µçš„losså€¼</span>    loss_evaluator <span class="token operator">=</span> RPNLossComputation<span class="token punctuation">(</span>        matcher<span class="token punctuation">,</span>        fg_bg_sampler<span class="token punctuation">,</span>        box_coder<span class="token punctuation">,</span>        generate_rpn_labels    <span class="token punctuation">)</span>    <span class="token keyword">return</span> loss_evaluator<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ªå‡½æ•°ä¸»è¦ç”±ä¸‰ä¸ªç±»çš„å¯¹è±¡æ¥æ„æˆï¼Œè¿™ä¸‰ä¸ªç±»åˆ†åˆ«æ˜¯ï¼š</p><p>Matcherç±»ï¼šå› ä¸ºä¸Šä¸€ä¸ªåšå®¢ä»‹ç»çš„RPNPostProcessorç±»å®ƒåªç”Ÿæˆäº†Proposalsï¼Œä½†æ˜¯è¿™äº›Proposalsé¢„æµ‹å¾—å¯¹ä¸å¯¹æˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼Œæ‰€ä»¥éœ€è¦Matcherç±»æ¥ç»™anchorsåˆ†é…å®ƒå¯¹åº”çš„çœŸå®æ ‡ç­¾ï¼Œä»è€ŒçŸ¥é“è¿™äº›anchorsæ‰€å¯¹åº”çš„Proposalsé¢„æµ‹å¾—å¯¹ä¸å¯¹ã€‚</p><p>BalancedPositiveNegativeSamplerç±»ï¼šç”±äºanchorsçš„æ•°ç›®æ¯”è¾ƒå¤šï¼Œå¯èƒ½ä¼šæœ‰è®¸å¤šè¢«é¢„æµ‹ä¸ºè´Ÿæ ·æœ¬çš„æƒ…å†µï¼ˆæ¯•ç«Ÿæ­£æ ·æœ¬åœ¨ä¸€å¼ å›¾ä¸­æ˜¯å°‘éƒ¨åˆ†ï¼‰ï¼Œä¸ºäº†ä½¿å¾—æ­£è´Ÿæ ·æœ¬åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¿æŒå¹³è¡¡ï¼Œå› æ­¤éœ€è¦è¯¥ç±»æ¥è¿›è¡Œç­›é€‰ã€‚</p><p>RPNLossComputationï¼šç”¨äºç»™ç­›é€‰è¿‡åçš„anchorsï¼ˆåŠ ä¸Šboxçš„åç§»é‡å°±å¾—åˆ°Proposalsï¼‰è®¡ç®—å…¶å¯¹åº”çš„lossã€‚</p><p>ä¸‹é¢é’ˆå¯¹è¿™ä¸‰ä¸ªç±»æ¥è¿›è¡Œä¸€ä¸€ä»‹ç»ï¼š</p></blockquote><h3 id="äºŒã€Matcherç±»"><a href="#äºŒã€Matcherç±»" class="headerlink" title="äºŒã€Matcherç±»"></a>äºŒã€Matcherç±»</h3><blockquote><p>è¿™ç±»åœ¨<strong>your_project/maskrcnn_benchmark/modeling/matcher.py</strong>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹åˆ°åˆå§‹åŒ–å‡½æ•°__init__():</p></blockquote><h4 id="1ã€init-å‡½æ•°"><a href="#1ã€init-å‡½æ•°" class="headerlink" title="1ã€init()å‡½æ•°"></a>1ã€<strong>init</strong>()å‡½æ•°</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Matcher</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    This class assigns to each predicted "element" (e.g., a box) a ground-truth    element. Each predicted element will have exactly zero or one matches; each    ground-truth element may be assigned to zero or more predicted elements.    Matching is based on the MxN match_quality_matrix, that characterizes how well    each (ground-truth, predicted)-pair match. For example, if the elements are    boxes, the matrix may contain box IoU overlap values.    The matcher returns a tensor of size N containing the index of the ground-truth    element m that matches to prediction n. If there is no match, a negative value    is returned.    è¿™ä¸ªç±»æ˜¯ç”¨æ¥ç»™æ¯ä¸€ä¸ªé¢„æµ‹çš„å…ƒç´ ï¼ˆä¾‹å¦‚boxï¼Œmask ç­‰ç­‰ï¼‰åˆ†é…ä¸€ä¸ªGT    æ¯ä¸ªé¢„æµ‹çš„å…ƒç´ å°†æœ‰0ä¸ªæˆ–è€…1ä¸ªæ‰€åŒ¹é…ï¼ˆ0ä¸ªå°±æ˜¯ç›¸å½“äºæ˜¯èƒŒæ™¯ï¼‰    æ¯ä¸€ä¸ªGTå°†ä¼šè¢«å¯¹åº”åˆ°0ä¸ªæˆ–è€…å¤šä¸ªé¢„æµ‹çš„å…ƒç´     åŒ¹é…çš„æ–¹å¼æ˜¯é€šè¿‡M x N ç»´åº¦çš„çŸ©é˜µï¼Œå®ƒå°†predict element(Nä¸ªå…ƒç´ ) å’Œ GT(Mä¸ªå…ƒç´ )å¯¹åº”èµ·æ¥    å¦‚æœé¢„æµ‹çš„å…ƒç´ ä¸ºboxes ï¼Œè¿™ä¸ªçŸ©é˜µå°†ä¼šåŒ…å«boxçš„IOUå€¼    matcherçš„è¿”å›å€¼ä¸º...    """</span>    <span class="token comment"># ä½äºé˜ˆå€¼</span>    BELOW_LOW_THRESHOLD <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>    <span class="token comment"># æ¯”è¾ƒæ¨¡ç³Šçš„æ•°å€¼</span>    BETWEEN_THRESHOLDS <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> high_threshold<span class="token punctuation">,</span> low_threshold<span class="token punctuation">,</span> allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Args:            high_threshold (float): quality values greater than or equal to                this value are candidate matches.            low_threshold (float): a lower quality threshold used to stratify                matches into three levels:                1) matches &gt;= high_threshold                2) BETWEEN_THRESHOLDS matches in [low_threshold, high_threshold)                3) BELOW_LOW_THRESHOLD matches in [0, low_threshold)            allow_low_quality_matches (bool): if True, produce additional matches                for predictions that have only low-quality match candidates. See                set_low_quality_matches_ for more details.        å‚æ•°ï¼š            high_threshold:å¤§äºç­‰äºè¿™ä¸ªå€¼çš„è¢«è®¤ä¸ºæ˜¯å€™é€‰çš„match            low_threshold:            åˆ†ä¸‰ç§æƒ…å†µ            1) matches &gt;= high_threshold            2) BETWEEN_THRESHOLDS:matches between [low_threshold, high_threshold)  è¢«èµ‹å€¼ä¸º-2            3) BELOW_LOW_THRESHOLDï¼šmatches between [0, low_threshold)   è¢«èµ‹å€¼ä¸º-1        """</span>        <span class="token comment"># ä½é˜ˆå€¼å¿…é¡»å°äºé«˜é˜ˆå€¼</span>        <span class="token keyword">assert</span> low_threshold <span class="token operator">&lt;=</span> high_threshold        <span class="token comment"># ç»™ç›¸å…³å‚æ•°èµ‹äºˆåˆå§‹åŒ–å€¼</span>        self<span class="token punctuation">.</span>high_threshold <span class="token operator">=</span> high_threshold        self<span class="token punctuation">.</span>low_threshold <span class="token operator">=</span> low_threshold        self<span class="token punctuation">.</span>allow_low_quality_matches <span class="token operator">=</span> allow_low_quality_matches<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>init</strong>()å‡½æ•°ä¸­ä¸»è¦å°±æ˜¯åˆå§‹åŒ–ç›¸å…³çš„å‡ ä¸ªå‚æ•°ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ‰§è¡Œç›¸å…³æ“ä½œçš„call()å‡½æ•°:</p></blockquote><h4 id="2ã€call-å‡½æ•°"><a href="#2ã€call-å‡½æ•°" class="headerlink" title="2ã€call()å‡½æ•°"></a>2ã€<strong>call</strong>()å‡½æ•°</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> match_quality_matrix<span class="token punctuation">)</span><span class="token punctuation">:</span>       <span class="token triple-quoted-string string">"""       Args:           match_quality_matrix (Tensor[float]): an MxN tensor, containing the           pairwise quality between M ground-truth elements and N predicted elements.           match_quality_matrixæ˜¯ä¸€ä¸ªMxNç»´çš„çŸ©é˜µï¼Œå®ƒé‡Œé¢ä¿å­˜çš„å€¼ä¸»è¦æ˜¯Mä¸ªGTå…ƒç´ å’ŒNä¸ªPTå…ƒç´            ä¹‹é—´çš„åŒ¹é…å¯ä¿¡åº¦ã€‚ï¼ˆè¿™ä¸ªçŸ©é˜µä¸­çš„å€¼å°±æ˜¯GTå’ŒPTçš„IOUå€¼ï¼‰           å…¶å®å°±æ˜¯è®¡ç®—anchorså’ŒGTçš„iouå€¼ï¼Œä¹‹å‰ä¸€ç›´ä»¥ä¸ºæ˜¯è®¡ç®—Proposalså’ŒGTçš„iouå€¼                  Returns:           matches (Tensor[int64]): an N tensor where N[i] is a matched gt in           [0, M - 1] or a negative value indicating that prediction i could not           be matched.       è¿”å›å€¼ï¼š            Nç»´çš„tensor            N[i]çš„å€¼ä¸ºgtçš„ä¸‹æ ‡ï¼ŒèŒƒå›´ä¸º[0, M - 1],æˆ–è€…ä¸ºä¸€ä¸ªè´Ÿå€¼ï¼Œè¡¨ç¤ºè¯¥predictæ²¡æœ‰åŒ¹é…çš„GT            å¯ä»¥ç†è§£ä¸ºç»™PTï¼ˆpredict elementï¼‰éƒ½åˆ†é…äº†ä¸€ä¸ªå¯¹åº”çš„GTï¼Œå¦‚æœæœ‰PTæ²¡æœ‰è¢«åˆ†é…ï¼Œé‚£ä¹ˆ                è¯¥PTä½ç½®ä¸Šçš„indexå€¼ç”¨-1è¡¨ç¤º       """</span>       <span class="token comment"># ä¿è¯æ¯ä¸€å¼ å›¾ç‰‡é‡Œé¢éƒ½è‡³å°‘æœ‰ä¸€ä¸ªinstance</span>       <span class="token keyword">if</span> match_quality_matrix<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>           <span class="token comment"># empty targets or proposals not supported during training</span>           <span class="token keyword">if</span> match_quality_matrix<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>               <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>                   <span class="token string">"No ground-truth boxes available for one of the images "</span>                   <span class="token string">"during training"</span><span class="token punctuation">)</span>           <span class="token keyword">else</span><span class="token punctuation">:</span>               <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span>                   <span class="token string">"No proposal boxes available for one of the images "</span>                   <span class="token string">"during training"</span><span class="token punctuation">)</span>       <span class="token comment"># match_quality_matrix is M (gt) x N (predicted)</span>       <span class="token comment"># Max over gt elements (dim 0) to find best gt candidate for each prediction</span>       <span class="token comment"># ç»™æ¯ä¸€ä¸ªpredictå¯»æ‰¾å…¶åŒ¹é…å€¼æœ€å¤§çš„å€¼(ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«æ¯ä¸€ä¸ªproposalä¸GTçš„æœ€å¤§å€¼IOU) </span>       <span class="token comment">#    ä»¥åŠ å…¶ä¸‹æ ‡ï¼ˆä¸€ä¸ªåˆ—è¡¨ï¼Œæ¯ä¸€ä¸ªproposalæ‰€å¯¹åº”çš„GTä¸‹æ ‡ï¼‰</span>       matched_vals<span class="token punctuation">,</span> matches <span class="token operator">=</span> match_quality_matrix<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment"># å¦‚æœå…è®¸ä½äºé˜ˆå€¼çš„ä¹Ÿæ˜¯ä½œä¸ºå€™é€‰è€…ï¼Œåˆ™æ‰€æœ‰çš„matcheséƒ½æ˜¯</span>       <span class="token keyword">if</span> self<span class="token punctuation">.</span>allow_low_quality_matches<span class="token punctuation">:</span>           all_matches <span class="token operator">=</span> matches<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment"># Assign candidate matches with low quality to negative (unassigned) values</span>       <span class="token comment"># æ‰¾åˆ°å“ªäº›indexæ˜¯ä½äºé˜ˆå€¼çš„  å“ªäº›indexæ˜¯åœ¨é˜ˆå€¼ä¹‹é—´çš„</span>       below_low_threshold <span class="token operator">=</span> matched_vals <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>low_threshold       between_thresholds <span class="token operator">=</span> <span class="token punctuation">(</span>matched_vals <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>low_threshold<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>           matched_vals <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>high_threshold       <span class="token punctuation">)</span>       <span class="token comment"># ç»™ä½äºé˜ˆå€¼çš„IOUåˆ†é… ä½äºé˜ˆå€¼å¯¹åº”çš„å€¼</span>       matches<span class="token punctuation">[</span>below_low_threshold<span class="token punctuation">]</span> <span class="token operator">=</span> Matcher<span class="token punctuation">.</span>BELOW_LOW_THRESHOLD       <span class="token comment"># ç»™å¤„äºé˜ˆå€¼ä¹‹é—´IOUçš„åˆ†é… å¤„äºé˜ˆå€¼ä¹‹é—´çš„å€¼</span>       matches<span class="token punctuation">[</span>between_thresholds<span class="token punctuation">]</span> <span class="token operator">=</span> Matcher<span class="token punctuation">.</span>BETWEEN_THRESHOLDS       <span class="token keyword">if</span> self<span class="token punctuation">.</span>allow_low_quality_matches<span class="token punctuation">:</span>           self<span class="token punctuation">.</span>set_low_quality_matches_<span class="token punctuation">(</span>matches<span class="token punctuation">,</span> all_matches<span class="token punctuation">,</span> match_quality_matrix<span class="token punctuation">)</span>       <span class="token keyword">return</span> matches<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ•´ä½“çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä»æµç¨‹å›¾å¯ä»¥çœ‹å‡ºï¼ŒMatcherç±»çš„ä½œç”¨å°±æ˜¯ç»™æ¯ä¸€ä¸ªPTï¼ˆanchorsï¼‰æ‰¾åˆ°ä¸€ä¸ªå¯¹åº”çš„GTï¼ˆground trueå…ƒç´ ï¼‰,å¹¶è¿”å›å®ƒä»¬å¯¹åº”å…³ç³»çš„ä¸€ä¸ªåˆ—è¡¨ã€‚</p></blockquote><p><img src="1.jpg" alt="å›¾1 matcherè¿‡ç¨‹ç¤ºæ„å›¾"></p><h3 id="ä¸‰ã€BalancedPositiveNegativeSamplerç±»"><a href="#ä¸‰ã€BalancedPositiveNegativeSamplerç±»" class="headerlink" title="ä¸‰ã€BalancedPositiveNegativeSamplerç±»"></a>ä¸‰ã€BalancedPositiveNegativeSamplerç±»</h3><blockquote><p>æˆ‘ä»¬å·²ç»é€šè¿‡Matcherç±»ç»™æ¯ä¸€ä¸ªanchorsåˆ†é…äº†ç›¸åº”çš„GTï¼Œæ¥ç€æˆ‘ä»¬éœ€è¦é€šè¿‡BalancedPositiveNegativeSamplerç±»æ¥è°ƒèŠ‚æ­£è´Ÿæ ·æœ¬ç”¨äºè®­ç»ƒï¼Œè¿™ä¸ªç±»è¢«æ”¾åœ¨your_project/maskrcnn_benchmark/modeling/balanced_positive_negative_sampler.pyæ–‡ä»¶ä¸­:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># æ­£è´Ÿæ ·æœ¬çš„é€‰æ‹©å™¨ï¼ˆå› ä¸ºè¦æƒè¡¡å¥½æ­£è´Ÿæ ·æœ¬çš„æ¯”ä¾‹ï¼‰</span><span class="token keyword">class</span> <span class="token class-name">BalancedPositiveNegativeSampler</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    This class samples batches, ensuring that they contain a fixed proportion of positives    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size_per_image<span class="token punctuation">,</span> positive_fraction<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            batch_size_per_image (int): number of elements to be selected per image            positive_fraction (float): percentage of positive elements per batch        batch_size_per_imageï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®è¯¥å‚æ•°ï¼‰         æ˜¯æŒ‡æ¯å¼ å›¾ç‰‡æŒ‘é€‰ç”¨äºè®­ç»ƒçš„anchorsæ•°ç›®ï¼ˆå¦‚æœå®é™…æ•°ç›®å°äºè¿™ä¸ªå€¼ï¼Œé‚£ä»¥å®é™…æ•°ç›®ä¸ºå‡†ï¼‰        postive_fraction æ˜¯æŒ‡batch_size_per_imageä¸­æ­£æ ·æœ¬ä¸ªæ•°çš„æ¯”ä¾‹        """</span>         self<span class="token punctuation">.</span>batch_size_per_image <span class="token operator">=</span> batch_size_per_image        self<span class="token punctuation">.</span>positive_fraction <span class="token operator">=</span> positive_fraction     <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> matched_idxs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            matched idxs: list of tensors containing -1, 0 or positive values.                Each tensor corresponds to a specific image.                -1 values are ignored, 0 are considered as negatives and &gt; 0 as                positives.        matched_idxsä¸­åŒ…å«æ¯ä¸€ä¸ªanchorsçš„labelå€¼.  eg:[[1,4,5,0,-1,3,1...],[...],...]        (0ä¸ºèƒŒæ™¯ï¼Œ -1ä¸ºè¢«å¿½è§†çš„ç±»ï¼Œ positiveå€¼ä¸ºç›¸åº”çš„ç±»åˆ«å·)        Returns:            pos_idx (list[tensor])            neg_idx (list[tensor])        Returns two lists of binary masks for each image.        The first list contains the positive elements that were selected,        and the second list the negative example.0        """</span>        pos_idx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        neg_idx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token comment"># æ‰¹é‡å¤„ç†  è€ƒè™‘åˆ°batch sizeç»´åº¦çš„ç¼˜æ•…</span>        <span class="token keyword">for</span> matched_idxs_per_image <span class="token keyword">in</span> matched_idxs<span class="token punctuation">:</span>            <span class="token comment"># å¾—åˆ°æ­£æ ·æœ¬çš„anchors index</span>            positive <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>matched_idxs_per_image <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>            <span class="token comment"># å¾—åˆ°è´Ÿæ ·æœ¬çš„anchors index</span>            negative <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>matched_idxs_per_image <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>             <span class="token comment"># æ­£æ ·æœ¬çš„æ•°ç›®</span>            num_pos <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>batch_size_per_image <span class="token operator">*</span> self<span class="token punctuation">.</span>positive_fraction<span class="token punctuation">)</span>            <span class="token comment"># protect against not enough positive examples</span>            num_pos <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>positive<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num_pos<span class="token punctuation">)</span>            num_neg <span class="token operator">=</span> self<span class="token punctuation">.</span>batch_size_per_image <span class="token operator">-</span> num_pos            <span class="token comment"># protect against not enough negative examples</span>            num_neg <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>negative<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> num_neg<span class="token punctuation">)</span>             <span class="token comment"># randomly select positive and negative examples</span>            <span class="token comment"># ä»æ‰€æœ‰çš„æ­£æ ·æœ¬ä¸­éšæœºæŒ‘é€‰ä¸€å®šæ•°ç›®çš„æ­£æ ·æœ¬ å¾—åˆ°çš„æ˜¯ postiveåˆ—è¡¨ çš„index</span>            perm1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>positive<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>positive<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>num_pos<span class="token punctuation">]</span>            <span class="token comment"># ä»æ‰€æœ‰çš„è´Ÿæ ·æœ¬ä¸­éšæœºæŒ‘é€‰ä¸€å®šæ•°ç›®çš„è´Ÿæ ·æœ¬</span>            perm2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>randperm<span class="token punctuation">(</span>negative<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>negative<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>num_neg<span class="token punctuation">]</span>             <span class="token comment"># å¾—åˆ°ç”¨äºè®­ç»ƒæ­£æ ·æœ¬çš„ anchors index</span>            pos_idx_per_image <span class="token operator">=</span> positive<span class="token punctuation">[</span>perm1<span class="token punctuation">]</span>            <span class="token comment"># å¾—åˆ°ç”¨äºè®­ç»ƒè´Ÿæ ·æœ¬çš„ anchors index</span>            neg_idx_per_image <span class="token operator">=</span> negative<span class="token punctuation">[</span>perm2<span class="token punctuation">]</span>             <span class="token comment"># create binary mask from indices</span>            pos_idx_per_image_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>                matched_idxs_per_image<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">bool</span>            <span class="token punctuation">)</span>            neg_idx_per_image_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>                matched_idxs_per_image<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">bool</span>            <span class="token punctuation">)</span>            <span class="token comment"># å°†æ˜¯ç”¨æ¥è®­ç»ƒçš„æ­£æ ·æœ¬anchors è®¾ç½®ä¸º1</span>            pos_idx_per_image_mask<span class="token punctuation">[</span>pos_idx_per_image<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>            <span class="token comment"># å°†æ˜¯ç”¨æ¥è®­ç»ƒçš„è´Ÿæ ·æœ¬anchors è®¾ç½®ä¸º1</span>            neg_idx_per_image_mask<span class="token punctuation">[</span>neg_idx_per_image<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>             pos_idx<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pos_idx_per_image_mask<span class="token punctuation">)</span>            neg_idx<span class="token punctuation">.</span>append<span class="token punctuation">(</span>neg_idx_per_image_mask<span class="token punctuation">)</span>         <span class="token comment"># pos_idxåˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªåˆ—è¡¨ç»´åº¦å¯èƒ½ä¸å¤ªä¸€æ ·</span>        <span class="token comment"># ï¼ˆå†…éƒ¨æ¯ä¸€ä¸ªåˆ—è¡¨çš„ç»´åº¦å–å†³äºé¢„æµ‹è¿‡ç¨‹ä¸­çš„anchorsä¸ªæ•°ï¼Œåˆ—è¡¨çš„æ•°ç›®æ˜¯batch sizeæ•°ç›®ï¼‰</span>        <span class="token keyword">return</span> pos_idx<span class="token punctuation">,</span> neg_idx          <span class="token comment"># BalancedPositiveNegativeSamplerç±»å¯¹è±¡çš„__call__()å‡½æ•°è¿”å›å€¼æ˜¯ï¼šä½œä¸ºæ­£æ ·æœ¬çš„ </span>        <span class="token comment"># anchorså’Œä½œä¸ºè´Ÿæ ·æœ¬çš„anchors</span>        <span class="token comment"># ä¾‹å¦‚pos_idx = [[0,1,1,0,1...],...]</span>        <span class="token comment"># è¡¨ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡ä¸­å½“ä½œæ­£æ ·æœ¬çš„anchorsä¸‹æ ‡ä¸ºï¼š1,2,4,...</span>        <span class="token comment"># ä¾‹å¦‚neg_idx = [[1,0,0,0,0,1,...], ....]</span>        <span class="token comment"># è¡¨ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡ä¸­å½“ä½œè´Ÿæ ·æœ¬çš„anchorsä¸‹æ ‡ä¸ºï¼š0,5,...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å››ã€RPNLossComputation"><a href="#å››ã€RPNLossComputation" class="headerlink" title="å››ã€RPNLossComputation"></a>å››ã€RPNLossComputation</h3><blockquote><p>BalancedPositiveNegativeSamplerç±»ç›¸å¯¹æ¯”è¾ƒå¥½æ‡‚ä¸€äº›ï¼Œç›¸å…³æ³¨é‡Šå·²ç»éƒ½å†™åœ¨ä»£ç ä¸­äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»RPNLossComputationç±»ï¼Œå®ƒè°ƒç”¨äº†Matcherå’ŒBalancedPositiveNegativeSamplerè¿™ä¸¤ä¸ªç±»å¯¹è±¡ï¼ŒRPNLossComputationç±»åœ¨your_project/maskrcnn_benchmark/modeling/rpn/loss.pyæ–‡ä»¶ä¸­ã€‚</p><p>æ•´ä¸ªRPNLossComputationç±»ä¸­çš„è°ƒç”¨å…³ç³»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><p><img src="2.jpg" alt="å›¾2 è°ƒç”¨å…³ç³»å›¾"></p><h4 id="1ã€init-å‡½æ•°-1"><a href="#1ã€init-å‡½æ•°-1" class="headerlink" title="1ã€init()å‡½æ•°"></a>1ã€<strong>init</strong>()å‡½æ•°</h4><blockquote><p>æˆ‘ä»¬é¦–å…ˆçœ‹__init__()åˆå§‹åŒ–å‡½æ•°ï¼Œä¸»è¦æ˜¯åœ¨å®šä¹‰ç›¸å…³çš„ç±»å˜é‡ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposal_matcher<span class="token punctuation">,</span> fg_bg_sampler<span class="token punctuation">,</span> box_coder<span class="token punctuation">,</span>             generate_labels_func<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Arguments:        proposal_matcher (Matcher)        fg_bg_sampler (BalancedPositiveNegativeSampler)        box_coder (BoxCoder)    """</span>    <span class="token comment"># self.target_preparator = target_preparator</span>    <span class="token comment"># anchor åŒ¹é…å™¨ï¼Œç”¨äºåŒ¹é…anchorå’Œtarget</span>    <span class="token comment">#ï¼ˆå› ä¸ºæ¯ä¸€ä¸ªåƒç´ ç‚¹éƒ½åŒ…å«æœ‰9ä¸ªanchorï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªanchoråº”è¯¥å’Œå“ªä¸€ä¸ªtargetæ¥è®¡ç®—æŸä¼¤ï¼Œ</span>    <span class="token comment"># è¿™ä¸ªéœ€è¦é€šè¿‡proposal_matchæ¥è¿›è¡ŒåŒ¹é…ï¼‰</span>    self<span class="token punctuation">.</span>proposal_matcher <span class="token operator">=</span> proposal_matcher    <span class="token comment"># å‰æ™¯å’ŒèƒŒæ™¯çš„é‡‡é›†å™¨ï¼Œå› ä¸ºæ¯ä¸€ä¸ªåƒç´ ç‚¹éƒ½å¯¹åº”æœ‰9ä¸ªanchorï¼Œ</span>    <span class="token comment"># é‚£æ¯ä¸€ä¸ªanchoræ˜¯å½“ä½œæ­£æ ·æœ¬è¿˜æ˜¯è´Ÿæ ·æœ¬éœ€è¦è¿›è¡Œé€‰æ‹©åˆ¤æ–­</span>    self<span class="token punctuation">.</span>fg_bg_sampler <span class="token operator">=</span> fg_bg_sampler    <span class="token comment"># è¾¹æ¡†ç¼–ç å™¨ï¼Œç”¨äºå°†anchorè¿›è¡Œç¼–ç æˆ–è€…è§£ç ï¼Œç”¨äºè®¡ç®—æŸå¤±</span>    self<span class="token punctuation">.</span>box_coder <span class="token operator">=</span> box_coder    <span class="token comment"># åˆå§‹åŒ–éœ€è¦å¤åˆ¶çš„å±æ€§</span>    self<span class="token punctuation">.</span>copied_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    self<span class="token punctuation">.</span>generate_labels_func <span class="token operator">=</span> generate_labels_func    <span class="token comment"># æŒ‡å®šéœ€è¦æ”¾å¼ƒçš„anchorç±»å‹</span>    self<span class="token punctuation">.</span>discard_cases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'not_visibility'</span><span class="token punctuation">,</span> <span class="token string">'between_thresholds'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2ã€match-targets-to-anchors-å‡½æ•°"><a href="#2ã€match-targets-to-anchors-å‡½æ•°" class="headerlink" title="2ã€match_targets_to_anchors()å‡½æ•°"></a>2ã€match_targets_to_anchors()å‡½æ•°</h4><blockquote><p>æ ¹æ®ä¸Šå›¾ï¼Œæˆ‘ä»¬é¦–å…ˆä»‹ç»match_targets_to_anchors()å‡½æ•°å’Œgenerate_rpn_labels()å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ç»™anchorsåˆ†é…ç›¸åº”çš„æ ‡ç­¾</span>    <span class="token keyword">def</span> <span class="token function">match_targets_to_anchors</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchor<span class="token punctuation">,</span> target<span class="token punctuation">,</span> copied_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># è®¡ç®—anchorså’ŒGTä¹‹é—´çš„IOU</span>        <span class="token comment">#ï¼ˆç»´åº¦ä¸ºMxN  Mè¡¨ç¤ºGTçš„instanceæ•°  Nè¡¨ç¤ºå¾—åˆ°çš„anchorsæ•°ï¼‰</span>        match_quality_matrix <span class="token operator">=</span> boxlist_iou<span class="token punctuation">(</span>target<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>        <span class="token comment"># matched_idxsæ˜¯ä¸€ä¸ªåˆ—è¡¨ ç»´åº¦ä¸º(N,) é‡Œé¢çš„å€¼ä¸ºGTçš„instanceç´¢å¼•</span>        <span class="token comment"># æ²¡æœ‰åŒ¹é…ä¸Šçš„å€¼ä¸º-1 æˆ–-2  ä½äºé˜ˆå€¼çš„å€¼èµ‹äºˆ-1  å¤„åœ¨é˜ˆå€¼ä¹‹é—´çš„å€¼èµ‹äºˆ-2</span>        matched_idxs <span class="token operator">=</span> self<span class="token punctuation">.</span>proposal_matcher<span class="token punctuation">(</span>match_quality_matrix<span class="token punctuation">)</span>        <span class="token comment"># RPN doesn't need any fields from target</span>        <span class="token comment"># for creating the labels, so clear them all</span>        <span class="token comment"># æ‹·è´ä¸€ä¸ªBoxlistå¯¹è±¡  é‡Œé¢çš„bboxå˜é‡æ‹·è´æ¥è‡ªtargetå¯¹è±¡</span>        target <span class="token operator">=</span> target<span class="token punctuation">.</span>copy_with_fields<span class="token punctuation">(</span>copied_fields<span class="token punctuation">)</span>        <span class="token comment"># get the targets corresponding GT for each anchor</span>        <span class="token comment"># NB: need to clamp the indices because we can have a single</span>        <span class="token comment"># GT in the image, and matched_idxs can be -2, which goes</span>        <span class="token comment"># out of bounds</span>        <span class="token comment"># æ²¡æœ‰åŒ¹é…ä¸ŠGTçš„anchors éƒ½ç»™å®ƒä»¬èµ‹äºˆindexä¸º0çš„GT,</span>        <span class="token comment"># matched_targetsç›¸å½“äºå°±æ˜¯ä¸€ä¸ªå……å½“anchorsæ ‡ç­¾çš„BoxListå¯¹è±¡ï¼ˆæœ‰box æœ‰labelï¼‰</span>        matched_targets <span class="token operator">=</span> target<span class="token punctuation">[</span>matched_idxs<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>        matched_targets<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">"matched_idxs"</span><span class="token punctuation">,</span> matched_idxs<span class="token punctuation">)</span>        <span class="token keyword">return</span> matched_targets  <span class="token comment"># This function should be overwritten in RetinaNet</span><span class="token keyword">def</span> <span class="token function">generate_rpn_labels</span><span class="token punctuation">(</span>matched_targets<span class="token punctuation">)</span><span class="token punctuation">:</span>    matched_idxs <span class="token operator">=</span> matched_targets<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"matched_idxs"</span><span class="token punctuation">)</span>    <span class="token comment"># è·å¾—ä¸€ä¸ªboolå€¼å¾—mask  æœ‰åˆ†é…æ ‡ç­¾çš„anchorä¸ºTrue æ²¡æœ‰å¯¹åº”æ ‡ç­¾çš„anchorä¸ºFalse</span>    labels_per_image <span class="token operator">=</span> matched_idxs <span class="token operator">&gt;=</span> <span class="token number">0</span>    <span class="token keyword">return</span> labels_per_image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3ã€prepare-targets-å‡½æ•°"><a href="#3ã€prepare-targets-å‡½æ•°" class="headerlink" title="3ã€prepare_targets()å‡½æ•°"></a>3ã€prepare_targets()å‡½æ•°</h4><blockquote><p>äº†è§£äº†ç›¸å…³æµç¨‹ä¹‹åï¼Œç»“åˆç›¸å…³ä»£ç æ³¨é‡Šï¼Œé˜…è¯»ä¼šç›¸å¯¹ç®€å•äº›ï¼Œä¸‹é¢æ˜¯prepare_targets()å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">prepare_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>    labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    regression_targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> anchors_per_image<span class="token punctuation">,</span> targets_per_image <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>        matched_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>match_targets_to_anchors<span class="token punctuation">(</span>            anchors_per_image<span class="token punctuation">,</span> targets_per_image<span class="token punctuation">,</span> self<span class="token punctuation">.</span>copied_fields        <span class="token punctuation">)</span>        <span class="token comment"># å¾—åˆ°çš„matched_idxsä¸­æ˜¯æ¯ä¸€ä¸ªanchorsæ‰€åŒ¹é…å¥½çš„GTç´¢å¼•</span>        matched_idxs <span class="token operator">=</span> matched_targets<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"matched_idxs"</span><span class="token punctuation">)</span>        <span class="token comment"># å¾—åˆ°ä¸€ä¸ªåŒ¹é…å¥½çš„anchorsçš„maskï¼Œ</span>        <span class="token comment"># [False, True, True, True, ...]  è¡¨ç¤ºç¬¬2ï¼Œ3ï¼Œ4ä¸ªanchorséƒ½å·²ç»åŒ¹é…å¥½GT</span>        labels_per_image <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_labels_func<span class="token punctuation">(</span>matched_targets<span class="token punctuation">)</span>        <span class="token comment"># å°†False å’Œ Trueç”¨0 å’Œ 1è¡¨ç¤º</span>        labels_per_image <span class="token operator">=</span> labels_per_image<span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>         <span class="token comment"># Background (negative examples)</span>        <span class="token comment"># è·å–è´Ÿæ ·æœ¬(å…¶å®æ„Ÿè§‰è¿™ä¸€æ­¥æ˜¯å¤šä½™çš„  å› ä¸ºlabels_pre_imageç»è¿‡generate_labels_funcå·²ç»å®ç°äº†è¿™ä¸ªæ•ˆæœ)</span>        bg_indices <span class="token operator">=</span> matched_idxs <span class="token operator">==</span> Matcher<span class="token punctuation">.</span>BELOW_LOW_THRESHOLD        labels_per_image<span class="token punctuation">[</span>bg_indices<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>         <span class="token comment"># discard anchors that go out of the boundaries of the image</span>        <span class="token keyword">if</span> <span class="token string">"not_visibility"</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>discard_cases<span class="token punctuation">:</span>            labels_per_image<span class="token punctuation">[</span><span class="token operator">~</span>anchors_per_image<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"visibility"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>         <span class="token comment"># discard indices that are between thresholds</span>        <span class="token keyword">if</span> <span class="token string">"between_thresholds"</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>discard_cases<span class="token punctuation">:</span>            inds_to_discard <span class="token operator">=</span> matched_idxs <span class="token operator">==</span> Matcher<span class="token punctuation">.</span>BETWEEN_THRESHOLDS            labels_per_image<span class="token punctuation">[</span>inds_to_discard<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>         <span class="token comment"># compute regression targets\</span>        <span class="token comment"># è®¡ç®—boxçš„æ ‡ç­¾</span>        regression_targets_per_image <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>            matched_targets<span class="token punctuation">.</span>bbox<span class="token punctuation">,</span> anchors_per_image<span class="token punctuation">.</span>bbox        <span class="token punctuation">)</span>        <span class="token comment"># å°†ç±»åˆ«æ ‡ç­¾å’Œboxæ ‡ç­¾ç”¨åˆ—è¡¨ä¿å­˜</span>        labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>labels_per_image<span class="token punctuation">)</span>        regression_targets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>regression_targets_per_image<span class="token punctuation">)</span>     <span class="token keyword">return</span> labels<span class="token punctuation">,</span> regression_targets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4ã€call-å‡½æ•°"><a href="#4ã€call-å‡½æ•°" class="headerlink" title="4ã€call()å‡½æ•°"></a>4ã€call()å‡½æ•°</h4><blockquote><p>æœ€åæ˜¯call()å‡½æ•° :</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> box_regression<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Arguments:        anchors (list[list[BoxList]])        objectness (list[Tensor])        box_regression (list[Tensor])        targets (list[BoxList])    Returns:        objectness_loss (Tensor)        box_loss (Tensor)    """</span>    <span class="token comment"># è·å–anchors (BoxListçš„å¯¹è±¡åˆ—è¡¨)</span>    anchors <span class="token operator">=</span> <span class="token punctuation">[</span>cat_boxlist<span class="token punctuation">(</span>anchors_per_image<span class="token punctuation">)</span> <span class="token keyword">for</span> anchors_per_image <span class="token keyword">in</span> anchors<span class="token punctuation">]</span>    <span class="token comment"># ç»™anchorsåˆ†é…æ ‡ç­¾ï¼ˆGTï¼‰ è¿”å›çš„æ˜¯åˆ†é…å¥½çš„ç±»åˆ«æ ‡ç­¾å’Œboxæ ‡ç­¾</span>    labels<span class="token punctuation">,</span> regression_targets <span class="token operator">=</span> self<span class="token punctuation">.</span>prepare_targets<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>    <span class="token comment"># æŒ‰ä¸€å®šæ¯”ä¾‹é€‰å–æ­£è´Ÿæ ·æœ¬ç”¨äºè®­ç»ƒé˜¶æ®µè®¡ç®—loss</span>    sampled_pos_inds<span class="token punctuation">,</span> sampled_neg_inds <span class="token operator">=</span> self<span class="token punctuation">.</span>fg_bg_sampler<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>    sampled_pos_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>sampled_pos_inds<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    sampled_neg_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>nonzero<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>sampled_neg_inds<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>     sampled_inds <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>sampled_pos_inds<span class="token punctuation">,</span> sampled_neg_inds<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>     objectness<span class="token punctuation">,</span> box_regression <span class="token operator">=</span> \            concat_box_prediction_layers<span class="token punctuation">(</span>objectness<span class="token punctuation">,</span> box_regression<span class="token punctuation">)</span>     objectness <span class="token operator">=</span> objectness<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>      labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    regression_targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>regression_targets<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>     <span class="token comment"># è®¡ç®—anchorsçš„åç§»é‡å›å½’loss</span>    box_loss <span class="token operator">=</span> smooth_l1_loss<span class="token punctuation">(</span>        box_regression<span class="token punctuation">[</span>sampled_pos_inds<span class="token punctuation">]</span><span class="token punctuation">,</span>        regression_targets<span class="token punctuation">[</span>sampled_pos_inds<span class="token punctuation">]</span><span class="token punctuation">,</span>        beta<span class="token operator">=</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">,</span>        size_average<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>sampled_inds<span class="token punctuation">.</span>numel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># è®¡ç®—ç±»åˆ«çš„äº¤å‰ç†µloss</span>    objectness_loss <span class="token operator">=</span> F<span class="token punctuation">.</span>binary_cross_entropy_with_logits<span class="token punctuation">(</span>        objectness<span class="token punctuation">[</span>sampled_inds<span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">[</span>sampled_inds<span class="token punctuation">]</span>    <span class="token punctuation">)</span>    <span class="token comment"># è¿”å›ä¸¤ä¸ªloss</span>    <span class="token keyword">return</span> objectness_loss<span class="token punctuation">,</span> box_loss<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è‡³æ­¤ï¼ŒRPNéƒ¨åˆ†ç®—æ˜¯ä»‹ç»å®Œäº†ï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ol><li>RPNç»“æ„ï¼šç”¨æ¥è¾“å‡ºå¯¹åº”çš„anchorç±»åˆ«å’Œåæ ‡åç§»é‡ã€‚</li><li>inferenceæ–‡ä»¶ï¼šç­›é€‰ç”¨äºä¸‹ä¸€ä¸ªROI_headé˜¶æ®µçš„Proposalsã€‚</li><li>lossæ–‡ä»¶ï¼šé€‰æ‹©ç”¨äºRPNé˜¶æ®µè®¡ç®—lossçš„anchorsï¼Œå¹¶ç»™è¿™äº›anchorsåˆ†é…æ ‡ç­¾ï¼Œè®¡ç®—lossã€‚</li></ol><p>ï¼ˆlossæ–‡ä»¶ä¸­é€‰ç”¨çš„anchorså’Œinferenceæ–‡ä»¶ä¸­ç”ŸæˆProposalsçš„anchorså¹¶ä¸ç›¸åŒï¼Œå„è‡ªæœ‰å„è‡ªçš„ç­›é€‰æœºåˆ¶ã€‚ï¼‰</p><p>ä¸‹ä¸€ç¯‡å°†ä»‹ç»ROI_Headéƒ¨åˆ†ï¼š</p><p>maskrcnn-benchmark-masterï¼ˆä¸ƒï¼‰ï¼š<a href="https://kingpopen.github.io/2021/08/02/maskrcnn-benchmark-master-qi-build-roi-heads-han-shu/">build-roi-heads-å‡½æ•°</a></p><p><strong>ç å­—ä¸æ˜“ æœªç»è®¸å¯ è¯·å‹¿éšæ„è½¬è½½ï¼</strong></p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benchmark-masterï¼ˆäº”ï¼‰ï¼šRPNçš„inferenceæ–‡ä»¶</title>
      <link href="/2021/07/27/maskrcnn-benchmark-master-wu-rpn-de-inference-wen-jian/"/>
      <url>/2021/07/27/maskrcnn-benchmark-master-wu-rpn-de-inference-wen-jian/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ä¸Šæ¬¡æˆ‘ä»¬ä»‹ç»åˆ°äº†RPNç½‘ç»œçš„ç›®çš„æ˜¯è·å–Proposalsï¼Œä½†æ˜¯ä»…ä»…é€šè¿‡RPN_Headéƒ¨åˆ†å¾—åˆ°åªæ˜¯anchorsçš„äºŒåˆ†ç±»ç»“æœå’Œanchorsçš„boxå›å½’ç»“æœï¼Œæƒ³è¦å¾—åˆ°çœŸæ­£çš„Proposalsï¼Œæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡make_rpn_postprocessorï¼ˆï¼‰å‡½æ•°æ¥å¯¹RPN_Headçš„è¾“å‡ºä½œè¿›ä¸€æ­¥çš„æ“ä½œï¼Œè€Œè¿™ä¸ªè¿›ä¸€æ­¥æ“ä½œéƒ½æ˜¯é€šè¿‡your_project/maskrcnn_benchmark/modeling/rpn/inference.pyä¸­çš„RPNPostProcessorç±»æ¥å®Œæˆçš„ï¼ˆmake_rpn_postprocessorï¼ˆï¼‰å‡½æ•°ä¹Ÿåœ¨è¯¥æ–‡ä»¶ä¸­ã€‚ï¼‰ï¼Œç®€å•çš„ç¤ºæ„å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><p><img src="1.jpg" alt="å›¾1 RPNç»“æ„å›¾"></p><h3 id="ä¸€ã€RPNPOSTProcessç±»"><a href="#ä¸€ã€RPNPOSTProcessç±»" class="headerlink" title="ä¸€ã€RPNPOSTProcessç±»"></a>ä¸€ã€RPNPOSTProcessç±»</h3><blockquote><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹RPNPostProcessorè¿™ä¸ªç±»åˆ°åº•åšäº†äº›ä»€ä¹ˆå·¥ä½œï¼š</p><ol><li>åœ¨æ‰€æœ‰anchorsä¸­ç­›é€‰å‡ºtop_kä¸ªanchorsï¼Œtop_kç”±å‚æ•°pre_nms_top_nå†³å®šã€‚</li><li>å°†ç­›é€‰ä¹‹åå¾—åˆ°çš„anchorså’Œå®ƒå¯¹åº”çš„boxå›å½’å€¼è¿›è¡Œç»“åˆï¼Œå¾—åˆ°å¯¹åº”çš„Proposalsã€‚(boxå›å½’å€¼å°±æ˜¯RPNé¢„æµ‹çš„anchorsçš„åç§»é‡)</li><li>å°†é¢ç§¯å°äºmin_sizeçš„Proposalså»é™¤æ‰ï¼Œmin_sizeç”±å‚æ•°min_sizeå†³å®šã€‚</li><li>é€šè¿‡NMSæ“ä½œï¼Œå¯¹Proposalsè¿›è¡Œç­›é€‰ï¼Œå¾—åˆ°top_nä¸ªProposalsï¼Œtop_nç”±å‚æ•°post_nms_top_nå†³å®š</li><li>æœ€åå°†top_nä¸ªProposalså’Œtargetæ ‡ç­¾ä¸€å¹¶ä½œä¸ºç»“æœè¿”å›ï¼ˆæ­¤æ—¶æ ‡ç­¾å’ŒProposalsçš„è¿˜æœªä¸€ä¸€å¯¹åº”ä¸Šï¼‰</li></ol><p>æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><p><img src="2.jpg" alt="å›¾2 æµç¨‹å›¾"></p><h4 id="1ã€init-å‡½æ•°"><a href="#1ã€init-å‡½æ•°" class="headerlink" title="1ã€init()å‡½æ•°"></a>1ã€<strong>init</strong>()å‡½æ•°</h4><blockquote><p>äº†è§£äº†ç›¸å…³æµç¨‹ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ç›¸å…³çš„ä»£ç ï¼Œé¦–å…ˆçœ‹åˆ°__init__()å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># RPNåç»­å¤„ç†ç±»</span><span class="token keyword">class</span> <span class="token class-name">RPNPostProcessor</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Performs post-processing on the outputs of the RPN boxes, before feeding the    proposals to the heads    """</span>    <span class="token comment"># åˆå§‹åŒ–å‡½æ•°ä¸­ä¸»è¦æ˜¯å®šä¹‰ç±»å˜é‡ï¼Œä¸‹é¢å¯¹å‡ ä¸ªç±»å˜é‡çš„æ„ä¹‰åšä¸€å®šè§£é‡Š</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>        self<span class="token punctuation">,</span>        pre_nms_top_n<span class="token punctuation">,</span>        post_nms_top_n<span class="token punctuation">,</span>        nms_thresh<span class="token punctuation">,</span>        min_size<span class="token punctuation">,</span>        box_coder<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>        fpn_post_nms_top_n<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>        fpn_post_nms_per_batch<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            pre_nms_top_n (int)            post_nms_top_n (int)            nms_thresh (float)            min_size (int)            box_coder (BoxCoder)            fpn_post_nms_top_n (int)        """</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>RPNPostProcessor<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># é€šè¿‡äºŒåˆ†ç±»ç½®ä¿¡åº¦æŒ‘é€‰çš„top_kä¸ª anchorsæ•°ç›®</span>        self<span class="token punctuation">.</span>pre_nms_top_n <span class="token operator">=</span> pre_nms_top_n        <span class="token comment"># é€šè¿‡NMSæŒ‘é€‰top_nä¸ªProposalsçš„æ•°ç›®</span>        self<span class="token punctuation">.</span>post_nms_top_n <span class="token operator">=</span> post_nms_top_n        <span class="token comment"># NMSæ–¹æ³•çš„é˜ˆå€¼</span>        self<span class="token punctuation">.</span>nms_thresh <span class="token operator">=</span> nms_thresh        <span class="token comment"># å»é™¤Proposalsé¢ç§¯å°äºmin_sizeçš„proposals</span>        self<span class="token punctuation">.</span>min_size <span class="token operator">=</span> min_size         <span class="token comment"># box_coderå¯ä»¥å°†RPNå¾—åˆ°çš„regressionåç§»é‡æ·»åŠ åˆ°anchorsä¸Šå»</span>        <span class="token keyword">if</span> box_coder <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            box_coder <span class="token operator">=</span> BoxCoder<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>box_coder <span class="token operator">=</span> box_coder         <span class="token keyword">if</span> fpn_post_nms_top_n <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            fpn_post_nms_top_n <span class="token operator">=</span> post_nms_top_n        self<span class="token punctuation">.</span>fpn_post_nms_top_n <span class="token operator">=</span> fpn_post_nms_top_n        self<span class="token punctuation">.</span>fpn_post_nms_per_batch <span class="token operator">=</span> fpn_post_nms_per_batch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2ã€forward-å‡½æ•°"><a href="#2ã€forward-å‡½æ•°" class="headerlink" title="2ã€forward()å‡½æ•°"></a>2ã€forward()å‡½æ•°</h4><blockquote><p>æ¥ç€æˆ‘ä»¬çœ‹forward()å‡½æ•°ï¼Œäº†è§£è¯¥ç±»çš„æ“ä½œæµç¨‹ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> box_regression<span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Arguments:        anchors: list[list[BoxList]]        objectness: list[tensor]        box_regression: list[tensor]    Returns:        boxlists (list[BoxList]): the post-processed anchors, after            applying box decoding and NMS    """</span>    sampled_boxes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    num_levels <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>objectness<span class="token punctuation">)</span>    anchors <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>anchors<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># å¯¹anchorsè¿›è¡Œé‡‡æ · å¾—åˆ°Proposalsï¼ˆåŒ…å«æœ‰å‰é¢1ã€2ã€3ã€4 å››ä¸ªæ“ä½œï¼‰</span>    <span class="token keyword">for</span> a<span class="token punctuation">,</span> o<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> box_regression<span class="token punctuation">)</span><span class="token punctuation">:</span>        sampled_boxes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>forward_for_single_feature_map<span class="token punctuation">(</span>a<span class="token punctuation">,</span> o<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span>     boxlists <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>sampled_boxes<span class="token punctuation">)</span><span class="token punctuation">)</span>    boxlists <span class="token operator">=</span> <span class="token punctuation">[</span>cat_boxlist<span class="token punctuation">(</span>boxlist<span class="token punctuation">)</span> <span class="token keyword">for</span> boxlist <span class="token keyword">in</span> boxlists<span class="token punctuation">]</span>     <span class="token comment"># åº”è¯¥æ˜¯å°†FPNæ¯ä¸€å±‚çš„Proposalséƒ½æ·»åŠ åœ¨ä¸€èµ·ï¼ˆå…·ä½“è¿˜æ²¡å¼„æ˜ç™½ï¼‰</span>    <span class="token keyword">if</span> num_levels <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>        boxlists <span class="token operator">=</span> self<span class="token punctuation">.</span>select_over_all_levels<span class="token punctuation">(</span>boxlists<span class="token punctuation">)</span>     <span class="token comment"># append ground-truth bboxes to proposals</span>    <span class="token comment"># å°†å¾—åˆ°çš„Proposalså’ŒçœŸå®çš„æ ‡ç­¾æ”¾åˆ°ä¸€èµ·ä¿å­˜</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">and</span> targets <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        boxlists <span class="token operator">=</span> self<span class="token punctuation">.</span>add_gt_proposals<span class="token punctuation">(</span>boxlists<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>     <span class="token comment"># è¿”å›Proposals</span>    <span class="token keyword">return</span> boxlists<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä»forwardï¼ˆï¼‰å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼Œå®ƒä¸»è¦æ‰§è¡Œçš„å°±æ˜¯æˆ‘ä¸Šé¢æåˆ°çš„5ä¸ªæ“ä½œï¼Œéœ€è¦é‡ç‚¹å…³æ³¨çš„å°±æ˜¯forward_for_single_feature_map()å‡½æ•°å’Œadd_gt_proposalsï¼ˆï¼‰å‡½æ•°ã€‚</p></blockquote><h4 id="3ã€forward-for-single-feature-map-å‡½æ•°"><a href="#3ã€forward-for-single-feature-map-å‡½æ•°" class="headerlink" title="3ã€forward_for_single_feature_map()å‡½æ•°"></a>3ã€forward_for_single_feature_map()å‡½æ•°</h4><blockquote><p>ä¸‹é¢é¦–å…ˆä»‹ç»forward_for_single_feature_map()å‡½æ•°: </p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward_for_single_feature_map</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> box_regression<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Arguments:        anchors: list[BoxList]        N: batch size        A: num of anchor        H: height of image        W: width of image        å…³äºRPNå¾—åˆ°çš„anchorsæ•°ç›®ï¼Œæˆ‘è¿˜æ˜¯ç®€å•çš„è®²ä¸€ä¸‹ï¼Œ        RPNæ˜¯æµç¨‹ä¸€èˆ¬æ˜¯ç»™æ¯ä¸€ä¸ªåƒç´ ç‚¹éƒ½ç”Ÿæˆ9ä¸ªanchorsï¼ˆnum of anchorï¼‰ï¼Œ        å› æ­¤æ¯ä¸€å¼ å›¾ç‰‡ä¸­ï¼Œæ€»çš„anchorsæ•°ç›®ä¸º:A * H * W        objectness: tensor of size N, A, H, W        box_regression: tensor of size N, A * 4, H, W    """</span>    device <span class="token operator">=</span> objectness<span class="token punctuation">.</span>device    N<span class="token punctuation">,</span> A<span class="token punctuation">,</span> H<span class="token punctuation">,</span> W <span class="token operator">=</span> objectness<span class="token punctuation">.</span>shape     <span class="token comment"># put in the same format as anchors</span>    <span class="token comment"># objectnessçš„ç»´åº¦ä¸º (N, A*H*W)</span>    objectness <span class="token operator">=</span> permute_and_flatten<span class="token punctuation">(</span>objectness<span class="token punctuation">,</span> N<span class="token punctuation">,</span> A<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>N<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    objectness <span class="token operator">=</span> objectness<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span>     box_regression <span class="token operator">=</span> permute_and_flatten<span class="token punctuation">(</span>box_regression<span class="token punctuation">,</span> N<span class="token punctuation">,</span> A<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> H<span class="token punctuation">,</span> W<span class="token punctuation">)</span>     num_anchors <span class="token operator">=</span> A <span class="token operator">*</span> H <span class="token operator">*</span> W    <span class="token comment"># é€šè¿‡å¯¹objectnessç½®ä¿¡åº¦æ’åºï¼ŒæŒ‘é€‰å‡ºtop_nä¸ªanchorsï¼ˆobjectness å’Œ box_regressionï¼‰</span>    pre_nms_top_n <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>pre_nms_top_n<span class="token punctuation">,</span> num_anchors<span class="token punctuation">)</span>    objectness<span class="token punctuation">,</span> topk_idx <span class="token operator">=</span> objectness<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>pre_nms_top_n<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">sorted</span><span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>    batch_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>N<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>    box_regression <span class="token operator">=</span> box_regression<span class="token punctuation">[</span>batch_idx<span class="token punctuation">,</span> topk_idx<span class="token punctuation">]</span>     image_shapes <span class="token operator">=</span> <span class="token punctuation">[</span>box<span class="token punctuation">.</span>size <span class="token keyword">for</span> box <span class="token keyword">in</span> anchors<span class="token punctuation">]</span>    concat_anchors <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>a<span class="token punctuation">.</span>bbox <span class="token keyword">for</span> a <span class="token keyword">in</span> anchors<span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>    concat_anchors <span class="token operator">=</span> concat_anchors<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>N<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">[</span>batch_idx<span class="token punctuation">,</span> topk_idx<span class="token punctuation">]</span>     <span class="token comment"># ç»™ç­›é€‰ä¹‹åå¾—åˆ°çš„anchorsæ·»åŠ regressionåç§»é‡ å¾—åˆ°Proposals</span>    proposals <span class="token operator">=</span> self<span class="token punctuation">.</span>box_coder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>        box_regression<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> concat_anchors<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>     proposals <span class="token operator">=</span> proposals<span class="token punctuation">.</span>view<span class="token punctuation">(</span>N<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>     result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> proposal<span class="token punctuation">,</span> score<span class="token punctuation">,</span> im_shape <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> image_shapes<span class="token punctuation">)</span><span class="token punctuation">:</span>        boxlist <span class="token operator">=</span> BoxList<span class="token punctuation">(</span>proposal<span class="token punctuation">,</span> im_shape<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"xyxy"</span><span class="token punctuation">)</span>        boxlist<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">"objectness"</span><span class="token punctuation">,</span> score<span class="token punctuation">)</span>        boxlist <span class="token operator">=</span> boxlist<span class="token punctuation">.</span>clip_to_image<span class="token punctuation">(</span>remove_empty<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        <span class="token comment"># å»é™¤é¢ç§¯å°äºmin_sizeçš„Proposals</span>        boxlist <span class="token operator">=</span> remove_small_boxes<span class="token punctuation">(</span>boxlist<span class="token punctuation">,</span> self<span class="token punctuation">.</span>min_size<span class="token punctuation">)</span>        <span class="token comment"># å¯¹Proposalsè¿›è¡ŒNMSæ“ä½œå¾—åˆ°æœ€åçš„Proposals</span>        boxlist <span class="token operator">=</span> boxlist_nms<span class="token punctuation">(</span>            boxlist<span class="token punctuation">,</span>            self<span class="token punctuation">.</span>nms_thresh<span class="token punctuation">,</span>            max_proposals<span class="token operator">=</span>self<span class="token punctuation">.</span>post_nms_top_n<span class="token punctuation">,</span>            score_field<span class="token operator">=</span><span class="token string">"objectness"</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span>        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span>boxlist<span class="token punctuation">)</span>    <span class="token keyword">return</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="4ã€add-gt-proposals-å‡½æ•°"><a href="#4ã€add-gt-proposals-å‡½æ•°" class="headerlink" title="4ã€add_gt_proposals()å‡½æ•°"></a>4ã€add_gt_proposals()å‡½æ•°</h4><blockquote><p>æ¥ç€è¦ä»‹ç»çš„å°±æ˜¯ç»™ç­›é€‰ä¹‹åå¾—åˆ°çš„Proposalså’ŒçœŸå®æ ‡ç­¾åˆå¹¶æ”¾åˆ°ä¸€èµ·ä¿å­˜çš„add_gt_proposalsï¼ˆï¼‰å‡½æ•°:æ³¨ï¼š<strong>è¿™ä¸ªå‡½æ•°è¿”å›ç»“æœå¹¶æ²¡æœ‰å°†Proposalså’Œtargetæ ‡ç­¾ä¸€ä¸€å¯¹åº”ä¸Š</strong>ï¼Œå³å¹¶ä¸çŸ¥é“å“ªä¸ªProposalå¯¹åº”å“ªä¸ªtargetæ ‡ç­¾ï¼Œåªæ˜¯æŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·ä¿å­˜è€Œå·²ã€‚</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">add_gt_proposals</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Arguments:        proposals: list[BoxList]        targets: list[BoxList]    """</span>    <span class="token comment"># Get the device we're operating on</span>    device <span class="token operator">=</span> proposals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bbox<span class="token punctuation">.</span>device    <span class="token comment"># æ‹·è´ä¸€ä¸ªdatasetä¸­è·å¾—çš„boxlistå¯¹è±¡ï¼ˆdatasetä¸­çš„targetï¼‰ï¼ˆfieldsä¸è¿›è¡Œæ‹·è´ï¼‰</span>    gt_boxes <span class="token operator">=</span> <span class="token punctuation">[</span>target<span class="token punctuation">.</span>copy_with_fields<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> target <span class="token keyword">in</span> targets<span class="token punctuation">]</span>     <span class="token comment"># later cat of bbox requires all fields to be present for all bbox</span>    <span class="token comment"># so we need to add a dummy for objectness that's missing</span>    <span class="token comment"># gt_boxesä¸­æ²¡æœ‰ä»»ä½•çš„field</span>    <span class="token comment"># æ·»åŠ ä¸€ä¸ªobjectnessçš„fields</span>    <span class="token comment"># BoxListæ˜¯é¡¹ç›®å†…è®¾çš„ä¸€ä¸ªç±»ï¼Œadd_fieldï¼ˆï¼‰æ–¹æ³•å°±æ˜¯æ·»åŠ å­—å…¸æ•°æ®çš„è¿‡ç¨‹</span>    <span class="token comment"># ä¸‹é¢è¿™ä¸ªå°±æ˜¯åœ¨gt_boxä¸­å†…ç½®å­—å…¸ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªkeyä¸ºobjectnessï¼Œvalueä¸º[1...1]çš„æ•°æ®</span>        <span class="token keyword">for</span> gt_box <span class="token keyword">in</span> gt_boxes<span class="token punctuation">:</span>        gt_box<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">"objectness"</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>gt_box<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>     proposals <span class="token operator">=</span> <span class="token punctuation">[</span>        cat_boxlist<span class="token punctuation">(</span><span class="token punctuation">(</span>proposal<span class="token punctuation">,</span> gt_box<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> proposal<span class="token punctuation">,</span> gt_box <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>proposals<span class="token punctuation">,</span> gt_boxes<span class="token punctuation">)</span>    <span class="token punctuation">]</span>     <span class="token keyword">return</span> proposals<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5ã€make-rpn-postprocessor-å‡½æ•°"><a href="#5ã€make-rpn-postprocessor-å‡½æ•°" class="headerlink" title="5ã€make_rpn_postprocessor()å‡½æ•°"></a>5ã€make_rpn_postprocessor()å‡½æ•°</h4><blockquote><p>æœ€åæˆ‘ä»¬çœ‹åˆ°make_rpn_postprocessor()å‡½æ•°ï¼Œçœ‹åå­—æˆ‘ä»¬å°±çŸ¥é“è¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥è·å– RPNPostProcessorç±»å¯¹è±¡çš„ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">make_rpn_postprocessor</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> rpn_box_coder<span class="token punctuation">,</span> is_train<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># è®¾ç½®nmsä¹‹åä¿ç•™çš„Proposalsæ•°ç›®ï¼ˆæœ‰FPNçš„æƒ…å†µï¼‰</span>    fpn_post_nms_top_n <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>FPN_POST_NMS_TOP_N_TRAIN    <span class="token keyword">if</span> <span class="token keyword">not</span> is_train<span class="token punctuation">:</span>        fpn_post_nms_top_n <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>FPN_POST_NMS_TOP_N_TEST     <span class="token comment"># è®¾ç½® é€šè¿‡RPNè¾“å‡ºanchorçš„äºŒåˆ†ç±»ç½®ä¿¡åº¦è¿›è¡Œç­›é€‰ æœ€åä¿ç•™çš„anchoræ•°ç›®ï¼ˆæœ‰ç‚¹æ‹—å£~ï¼‰</span>    pre_nms_top_n <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>PRE_NMS_TOP_N_TRAIN    <span class="token comment"># è®¾ç½®nmsä¹‹åä¿ç•™çš„Proposalsæ•°ç›®</span>    post_nms_top_n <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>POST_NMS_TOP_N_TRAIN    <span class="token keyword">if</span> <span class="token keyword">not</span> is_train<span class="token punctuation">:</span>        pre_nms_top_n <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>PRE_NMS_TOP_N_TEST        post_nms_top_n <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>POST_NMS_TOP_N_TEST    fpn_post_nms_per_batch <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>FPN_POST_NMS_PER_BATCH    <span class="token comment"># è®¾ç½®NMSé˜ˆå€¼</span>    nms_thresh <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>NMS_THRESH    <span class="token comment"># è®¾ç½®æœ€å°çš„Proposalsé¢ç§¯å¤§å°</span>    min_size <span class="token operator">=</span> config<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>MIN_SIZE    <span class="token comment"># åˆ›å»ºRPNPostProcessorå¯¹è±¡</span>    box_selector <span class="token operator">=</span> RPNPostProcessor<span class="token punctuation">(</span>        pre_nms_top_n<span class="token operator">=</span>pre_nms_top_n<span class="token punctuation">,</span>        post_nms_top_n<span class="token operator">=</span>post_nms_top_n<span class="token punctuation">,</span>        nms_thresh<span class="token operator">=</span>nms_thresh<span class="token punctuation">,</span>        min_size<span class="token operator">=</span>min_size<span class="token punctuation">,</span>        box_coder<span class="token operator">=</span>rpn_box_coder<span class="token punctuation">,</span>        fpn_post_nms_top_n<span class="token operator">=</span>fpn_post_nms_top_n<span class="token punctuation">,</span>        fpn_post_nms_per_batch<span class="token operator">=</span>fpn_post_nms_per_batch<span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token comment"># è¿”å›RPNPostProcessorç±»å¯¹è±¡</span>    <span class="token keyword">return</span> box_selector<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="äºŒã€BoxList"><a href="#äºŒã€BoxList" class="headerlink" title="äºŒã€BoxList"></a>äºŒã€BoxList</h3><blockquote><p>è¿™ä¸ªç±»æœ¬èº«æ˜¯ä¸åœ¨inference.pyè¿™ä¸ªæ–‡ä»¶ä¸­çš„ï¼Œä½†æ˜¯è¿™ä¸ªç±»åˆåœ¨inference.pyä¸­åå¤å‡ºç°ï¼Œå¹¶ä¸”è´¯ç©¿äº†æ•´ä¸ªæ•°æ®æµè¿‡ç¨‹ï¼Œå› æ­¤è¿˜æ˜¯å†³å®šæ”¾åœ¨è¿™é‡Œä»‹ç»ä¸€ä¸‹ã€‚</p><p>BoxListå®šä¹‰åœ¨your_project/maskrcnn_benchmark/structures/bounding_box.pyæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”åœ¨your_project/ABSTRACTIONS.mdä¸­æœ‰ç®€å•çš„æ³¨é‡Šä»‹ç»ï¼Œåœ¨æ­¤æˆ‘å°±å°†å…¶è‹±æ–‡çš„æ³¨é‡Šä»‹ç»<strong>ç¿»è¯‘ ç¿»è¯‘</strong></p></blockquote><p>ä»¥ä¸‹æ˜¯è‹±æ–‡éƒ¨åˆ†ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">### BoxList</span>The `BoxList` <span class="token keyword">class</span> <span class="token class-name">holds</span> a <span class="token builtin">set</span> of bounding boxes <span class="token punctuation">(</span>represented <span class="token keyword">as</span> a `Nx4` tensor<span class="token punctuation">)</span> <span class="token keyword">for</span>a specific image<span class="token punctuation">,</span> <span class="token keyword">as</span> well <span class="token keyword">as</span> the size of the image <span class="token keyword">as</span> a `<span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>` <span class="token builtin">tuple</span><span class="token punctuation">.</span>It also contains a <span class="token builtin">set</span> of methods that allow to perform geometrictransformations to the bounding boxes <span class="token punctuation">(</span>such <span class="token keyword">as</span> cropping<span class="token punctuation">,</span> scaling <span class="token keyword">and</span> flipping<span class="token punctuation">)</span><span class="token punctuation">.</span>The <span class="token keyword">class</span> <span class="token class-name">accepts</span> bounding boxes <span class="token keyword">from</span> two different <span class="token builtin">input</span> formats<span class="token punctuation">:</span><span class="token operator">-</span> `xyxy`<span class="token punctuation">,</span> where each box <span class="token keyword">is</span> encoded <span class="token keyword">as</span> a `x1`<span class="token punctuation">,</span> `y1`<span class="token punctuation">,</span> `x2` <span class="token keyword">and</span> `y2` coordinates<span class="token punctuation">,</span> <span class="token keyword">and</span><span class="token operator">-</span> `xywh`<span class="token punctuation">,</span> where each box <span class="token keyword">is</span> encoded <span class="token keyword">as</span> `x1`<span class="token punctuation">,</span> `y1`<span class="token punctuation">,</span> `w` <span class="token keyword">and</span> `h`<span class="token punctuation">.</span> Additionally<span class="token punctuation">,</span> each `BoxList` instance can also hold arbitrary additional information<span class="token keyword">for</span> each bounding box<span class="token punctuation">,</span> such <span class="token keyword">as</span> labels<span class="token punctuation">,</span> visibility<span class="token punctuation">,</span> probability scores etc<span class="token punctuation">.</span> Here <span class="token keyword">is</span> an example on how to create a `BoxList` <span class="token keyword">from</span> a <span class="token builtin">list</span> of coordinates<span class="token punctuation">:</span>```python<span class="token keyword">from</span> maskrcnn_benchmark<span class="token punctuation">.</span>structures<span class="token punctuation">.</span>bounding_box <span class="token keyword">import</span> BoxList<span class="token punctuation">,</span> FLIP_LEFT_RIGHT<span class="token keyword">import</span> torch width <span class="token operator">=</span> <span class="token number">100</span>height <span class="token operator">=</span> <span class="token number">200</span>boxes <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token comment"># create a BoxList with 3 boxes</span>bbox <span class="token operator">=</span> BoxList<span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> image_size<span class="token operator">=</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'xyxy'</span><span class="token punctuation">)</span> <span class="token comment"># perform some box transformations, has similar API as PIL.Image</span>bbox_scaled <span class="token operator">=</span> bbox<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> height <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>bbox_flipped <span class="token operator">=</span> bbox<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>FLIP_LEFT_RIGHT<span class="token punctuation">)</span> <span class="token comment"># add labels for each bbox</span>labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>bbox<span class="token punctuation">.</span>add_field<span class="token punctuation">(</span><span class="token string">'labels'</span><span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token comment"># bbox also support a few operations, like indexing</span><span class="token comment"># here, selects boxes 0 and 2</span>bbox_subset <span class="token operator">=</span> bbox<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>```<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è‡³æ­¤ï¼Œå…³äºRPN moduleè·å–Proposalsçš„è¿‡ç¨‹å·²ç»ä»‹ç»å®Œäº†ï¼Œè‡³äºå¦‚ä½•å°†ç›¸åº”çš„anchorså’ŒTargetæ ‡ç­¾ä¸€ä¸€å¯¹åº”è®¡ç®—ç›¸åº”çš„lossï¼Ÿ</p><p>å°†æ”¾åœ¨ä¸‹ä¸€ç¯‡ä»‹ç»ï¼š<a href="https://kingpopen.github.io/2021/08/01/maskrcnn-benchmark-master-liu-rpn-de-loss-wen-jian/">maskrcnn-benchmark-masterï¼ˆå…­ï¼‰ï¼šRPNçš„lossæ–‡ä»¶</a></p><p>ç å­—ä¸æ˜“  æœªç»è®¸å¯  è¯·å‹¿éšæ„è½¬è½½ï¼</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benchmark-masterï¼ˆå››ï¼‰ï¼šbuild_rpn()å‡½æ•°</title>
      <link href="/2021/07/27/maskrcnn-benchmark-master-si-build-rpn-han-shu/"/>
      <url>/2021/07/27/maskrcnn-benchmark-master-si-build-rpn-han-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†build_bone()å‡½æ•°ï¼Œäº†è§£åˆ°äº†backboneçš„æ„é€ è¿‡ç¨‹ï¼Œæœ¬ç¯‡æˆ‘ä»¬å¼€å§‹ä»‹ç»RPNçš„æ„é€ è¿‡ç¨‹ã€‚build_rpn()å‡½æ•°æ˜¯åœ¨your_project/maskrcnn_benchmark/modeling/rpn/rpn.pyæ–‡ä»¶ä¸­ã€‚</p><p>æˆ‘ä»¬çŸ¥é“RPNè¿‡ç¨‹æ˜¯æå–Proposalsçš„è¿‡ç¨‹ï¼Œå³åˆ¤æ–­å“ªä¸€ä¸ªåŒºåŸŸå¯èƒ½å«æœ‰éœ€è¦æ£€æµ‹çš„ç‰©ä½“ï¼ˆäºŒåˆ†ç±»ï¼Œæœ‰æˆ–æ— ï¼Œå¹¶ä¸åˆ¤æ–­å…·ä½“æ˜¯ä»€ä¹ˆç±»åˆ«çš„ç‰©ä½“ï¼‰ï¼Œä»¥åŠè¯¥ç‰©ä½“çš„bounding boxï¼Œå…·ä½“çš„å†…å®¹å¯ä»¥çœ‹ç›¸å…³Faster-RCNNè®ºæ–‡ï¼Œæœ¬ç¯‡è®ºæ–‡ä¸åšå…·ä½“é˜è¿°ï¼Œç®€å•çš„RPNç»†èŠ‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></blockquote><p><img src="1.jpg" alt="å›¾1 RPNç½‘ç»œç»“æ„å›¾"></p><blockquote><p>rpn.pyä¸­æ€»å…±åŒ…å«æœ‰ï¼š</p><p><strong>RPNHeadConvRegressorç±»ã€RPNHeadFeatureSingleConvç±»ã€RPNHeadç±»ã€RPNModuleç±»ã€build_rpnï¼ˆï¼‰å‡½æ•°</strong>è¿™äº”ä¸ªéƒ¨åˆ†ï¼Œä¸‹é¢å°±è¿™äº”ä¸ªéƒ¨åˆ†ä¸€ä¸€ä»‹ç»ï¼š</p></blockquote><h3 id="ä¸€ã€RPNHeadFeatureSingleConvç±»"><a href="#ä¸€ã€RPNHeadFeatureSingleConvç±»" class="headerlink" title="ä¸€ã€RPNHeadFeatureSingleConvç±»"></a>ä¸€ã€<strong>RPNHeadFeatureSingleConv</strong>ç±»</h3><blockquote><p>å‚ç…§æˆ‘ä¸Šé¢ç”»çš„RPNç»“æ„ç¤ºæ„å›¾ï¼ŒBackboneæå–çš„å›¾åƒç‰¹å¾è¿›å…¥RPNæ¨¡å—ä¹‹åï¼Œé¦–å…ˆé€šè¿‡ä¸€ä¸ª3x3Convæå–ç‰¹å¾ï¼Œ<strong>RPNHeadFeatureSingleConv</strong>ç±»å°±æ˜¯è¿™ä¸ªä½œç”¨ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># RPNä¸­ç”¨æ¥æå–ç‰¹å¾çš„å•ä¸ªå·ç§¯å±‚headæ¨¡å—</span><span class="token keyword">class</span> <span class="token class-name">RPNHeadFeatureSingleConv</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Adds a simple RPN Head with one conv to extract the feature    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            cfg              : config            in_channels (int): number of channels of the input feature        """</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>RPNHeadFeatureSingleConv<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 3*3å·ç§¯ç”¨äºæå–ç‰¹å¾</span>        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>            in_channels<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span>        <span class="token punctuation">)</span>        <span class="token comment"># å‚æ•°åˆå§‹åŒ–</span>        <span class="token keyword">for</span> l <span class="token keyword">in</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">]</span><span class="token punctuation">:</span>            torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>l<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>            torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>l<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment"># ä¸æ”¹å˜è¾“å…¥è¾“å‡ºçš„ç‰¹å¾ç»´åº¦</span>        self<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> in_channels     <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># å› ä¸ºbatch sizeçš„ç¼˜æ•…ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œè®¡ç®—</span>        x <span class="token operator">=</span> <span class="token punctuation">[</span>F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> z <span class="token keyword">in</span> x<span class="token punctuation">]</span>        <span class="token comment"># è¿”å›å€¼ä¸ºç»è¿‡3x3CONVæå–çš„ç‰¹å¾</span>        <span class="token keyword">return</span> x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="äºŒã€RPNHeadConvRegressorç±»"><a href="#äºŒã€RPNHeadConvRegressorç±»" class="headerlink" title="äºŒã€RPNHeadConvRegressorç±»"></a>äºŒã€RPNHeadConvRegressorç±»</h3><blockquote><p>åœ¨ç»è¿‡äº†3x3CONVæ“ä½œä¹‹åï¼Œå°±è¦è¿›è¡Œbounding boxçš„å›å½’å’Œ2åˆ†ç±»ä»»åŠ¡ï¼ˆæœ‰ç‰©ä½“è¿˜æ˜¯æ²¡æœ‰ç‰©ä½“ï¼‰,è¿™ä¾¿æ˜¯<strong>RPNHeadConvRegressor</strong>ç±»çš„ä½œç”¨ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># RPNä¸­ç”¨æ¥è¿›è¡Œå›å½’å’Œåˆ†ç±»çš„headæ¨¡å—</span><span class="token keyword">class</span> <span class="token class-name">RPNHeadConvRegressor</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    A simple RPN Head for classification and bbox regression    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_anchors<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            cfg              : config            in_channels (int): number of channels of the input feature            num_anchors (int): number of anchors to be predicted        """</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>RPNHeadConvRegressor<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment"># ä½¿ç”¨1*1çš„å·ç§¯å°†è¾“å…¥çš„featureçš„ç»´åº¦è½¬åŒ–ä¸ºé¢„æµ‹çš„anchorsçš„æ•°ç›®ï¼ˆ2åˆ†ç±»ï¼‰</span>        self<span class="token punctuation">.</span>cls_logits <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_anchors<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># ä½¿ç”¨1*1çš„å·ç§¯å°†è¾“å…¥çš„featureçš„ç»´åº¦è½¬åŒ–ä¸ºé¢„æµ‹çš„anchors*4çš„æ•°ç›®ï¼ˆå›å½’å¯¹åº”åˆ°4ä¸ªåæ ‡ç‚¹ï¼Œè™½ç„¶å››ä¸ªå€¼ä¸æ˜¯å¯¹åº”å››ä¸ªç‚¹ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å‡½æ•°è½¬æ¢è¿‡å»ï¼‰</span>        self<span class="token punctuation">.</span>bbox_pred <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>            in_channels<span class="token punctuation">,</span> num_anchors <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span>        <span class="token punctuation">)</span>        <span class="token comment"># åˆå§‹åŒ– cls__logitså’Œ bbox_pred</span>         <span class="token keyword">for</span> l <span class="token keyword">in</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>cls_logits<span class="token punctuation">,</span> self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">]</span><span class="token punctuation">:</span>            torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>l<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>            torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>l<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>     <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        logits <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>cls_logits<span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token keyword">for</span> y <span class="token keyword">in</span> x<span class="token punctuation">]</span>        bbox_reg <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token keyword">for</span> y <span class="token keyword">in</span> x<span class="token punctuation">]</span>        <span class="token comment"># è¿”å›å€¼ä¸ºProposalsï¼ˆå³æ¯ä¸€ä¸ªanchorçš„äºŒåˆ†ç±»ç»“æœä»¥åŠå®ƒçš„åæ ‡åç§»é‡ï¼‰</span>        <span class="token keyword">return</span> logits<span class="token punctuation">,</span> bbox_reg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸‰ã€RPNHeadç±»"><a href="#ä¸‰ã€RPNHeadç±»" class="headerlink" title="ä¸‰ã€RPNHeadç±»"></a>ä¸‰ã€RPNHeadç±»</h3><blockquote><p>å…¶å®å°±æ˜¯æŠŠRPNHeadConvRegressorç±»å’ŒRPNHeadConvRegressorç±»ä¸­çš„ç›¸å…³æ“ä½œï¼Œæ•´åˆåˆ°ä¸€ä¸ªç±»å½“ä¸­ï¼ˆå…ˆè¿›è¡Œ3x3CONV ç„¶åè¿›è¡Œanchorçš„bounding boxå›å½’å’ŒäºŒåˆ†ç±»ï¼‰:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å•å·ç§¯å±‚çš„RPN headï¼ˆé‡Œé¢åŒ…å«å•å·ç§¯head å’Œ åˆ†ç±»å›å½’headï¼‰</span><span class="token comment"># é€šè¿‡æ³¨å†Œå™¨åœ¨RPN_HEADSä¸­æ³¨å†Œè¯¥RPNHeadç±» æ–¹ä¾¿åé¢é€šè¿‡å­—å…¸çš„å½¢å¼è¿›è¡Œè·å–</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>RPN_HEADS<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"SingleConvRPNHead"</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">RPNHead</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Adds a simple RPN Head with classification and regression heads    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> num_anchors<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            cfg              : config            in_channels (int): number of channels of the input feature            num_anchors (int): number of anchors to be predicted        """</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>RPNHead<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># å•å±‚3*3å·ç§¯ç‰¹å¾æå–</span>        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>            in_channels<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span>        <span class="token punctuation">)</span>        <span class="token comment"># 2åˆ†ç±»</span>        self<span class="token punctuation">.</span>cls_logits <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> num_anchors<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token comment"># bboxå›å½’</span>        self<span class="token punctuation">.</span>bbox_pred <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>            in_channels<span class="token punctuation">,</span> num_anchors <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span>        <span class="token punctuation">)</span>         <span class="token keyword">for</span> l <span class="token keyword">in</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cls_logits<span class="token punctuation">,</span> self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">]</span><span class="token punctuation">:</span>            torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>l<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span>            torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>l<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>     <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>        logits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        bbox_reg <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> feature <span class="token keyword">in</span> x<span class="token punctuation">:</span>            t <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">)</span>            logits<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>cls_logits<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>            bbox_reg<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>bbox_pred<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> logits<span class="token punctuation">,</span> bbox_reg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å››ã€RPNModuleç±»"><a href="#å››ã€RPNModuleç±»" class="headerlink" title="å››ã€RPNModuleç±»"></a>å››ã€RPNModuleç±»</h3><blockquote><p>æ€»çš„æ¥è¯´ä¸Šé¢éƒ½æ˜¯ä»‹ç»äº†RPNï¼ˆRegion Proposal Networkï¼‰çš„ç½‘ç»œç»“æ„ç›¸å…³å†…å®¹ï¼Œç»è¿‡RPNHeadç±»å¾—åˆ°ä¹Ÿæ˜¯anchorsçš„åˆ†ç±»ç»“æœå’Œanchorsåæ ‡çš„å›å½’ç»“æœï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ¶‰åŠåº”è¯¥ä½¿ç”¨å“ªäº›anchorsï¼ˆæˆ‘ä»¬å°†RPNåˆ†ç±»ç»“æœä¸ºï¼šâ€œæœ‰ç‰©ä½“â€ çš„anchorsï¼Œç§°ä¹‹ä¸ºProposalsï¼‰ç”¨äºè®­ç»ƒï¼Ÿåœ¨è®­ç»ƒè¿‡ç¨‹å¦‚ä½•è¿›è¡Œlossçš„è®¡ç®—ï¼Ÿ</p><p>è€ŒRPNModuleç±»å°±æ˜¯å°†ä¸Šè¿°æåˆ°é—®é¢˜éƒ½è¿›è¡Œè§£å†³ï¼Œç„¶åæ•´åˆçš„ä¸€ä¸ªæ¨¡å—ã€‚ä¸‹é¢æ˜¯RPNModuleä¸­é‡ç‚¹çš„å‡ ä¸ªå‡½æ•°ï¼Œä»¥åŠå®ƒä»¬çš„ä½œç”¨ï¼š</p><p>make_anchor_generatorï¼ˆï¼‰ï¼šä¸ºæ¯ä¸€ä¸ªåƒç´ ç‚¹ç”Ÿæˆanchorï¼ˆæ¯ä¸€ä¸ªåƒç´ ç‚¹ä¸€èˆ¬éƒ½ä¼šç”Ÿæˆ9ä¸ªanchorsï¼‰</p><p>make_rpn_postprocessorï¼ˆï¼‰ï¼šæŒ‘é€‰ç”¨äºè®­ç»ƒå’Œæµ‹è¯•è¿‡ç¨‹çš„anchorsï¼Œå¹¶è¿”å›æœ€åç­›é€‰å¾—åˆ°çš„proposalså’Œç”¨äºè®­ç»ƒçš„æ ‡ç­¾ã€‚</p><p>make_rpn_loss_evaluatorï¼ˆï¼‰ï¼šç”¨äºè®¡ç®—RPNè¿™ä¸€éƒ¨åˆ†çš„lossã€‚</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RPNModule</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Module for RPN computation. Takes feature maps from the backbone and outputs     RPN proposals and losses. Works for both FPN and non-FPN.    é€šè¿‡æ³¨é‡Šæˆ‘ä»¬å°±å¯ä»¥æ˜ç™½ï¼š                            è¯¥æ¨¡å—çš„è¾“å…¥æ˜¯backboneæå–å¾—åˆ°çš„feature                            è¾“å‡ºæ˜¯RPNçš„proposalså’Œlosså€¼    """</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>RPNModule<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>         self<span class="token punctuation">.</span>cfg <span class="token operator">=</span> cfg<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment"># ç”Ÿæˆanchorsï¼ˆanchorså…·ä½“æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼‰</span>        anchor_generator <span class="token operator">=</span> make_anchor_generator<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>        <span class="token comment"># é€šè¿‡æ³¨å†Œå™¨å¾—åˆ°cfgä¸­å¯¹åº”çš„rpn_head</span>        rpn_head <span class="token operator">=</span> registry<span class="token punctuation">.</span>RPN_HEADS<span class="token punctuation">[</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN<span class="token punctuation">.</span>RPN_HEAD<span class="token punctuation">]</span>        head <span class="token operator">=</span> rpn_head<span class="token punctuation">(</span>            cfg<span class="token punctuation">,</span> in_channels<span class="token punctuation">,</span> anchor_generator<span class="token punctuation">.</span>num_anchors_per_location<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        <span class="token punctuation">)</span>         <span class="token comment"># è¾¹æ¡†ç¼–ç å™¨ï¼Œ ä¸»è¦ç”¨äºè®¡ç®—è¾¹æ¡†åå·®ä»¥åŠåˆ©ç”¨åå·®è®¡ç®—é¢„æµ‹æ¡†ï¼ˆå°±æ˜¯é¢„æµ‹çš„å››ä¸ªç‚¹å¹¶ä¸æ˜¯åæ ‡æ¡†çš„å››ä¸ªç‚¹ï¼Œéœ€è¦é€šè¿‡å‡½æ•°è½¬åŒ–ä¸€ä¸‹ï¼‰</span>        rpn_box_coder <span class="token operator">=</span> BoxCoder<span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token comment"># æŒ‡å®šè·å¾—é¢„æµ‹è¾¹æ¡†çš„å·¥å…·ç±»ï¼Œå°†RPNå¾—åˆ°çš„boxè¿›è¡Œåç»­å¤„ç†ï¼Œç”¨ä½œä¸‹ä¸€ä¸ªé˜¶æ®µheadçš„è¾“å…¥</span>        <span class="token comment"># åœ¨RPNæŸå¤±è®¡ç®—éƒ¨åˆ†çš„anchorså’Œç”¨äºåç»­é˜¶æ®µçš„Proposalså¯¹åº”çš„anchors å¹¶ä¸å®Œå…¨ä¸€æ ·</span>        box_selector_train <span class="token operator">=</span> make_rpn_postprocessor<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> rpn_box_coder<span class="token punctuation">,</span> is_train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>        box_selector_test <span class="token operator">=</span> make_rpn_postprocessor<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> rpn_box_coder<span class="token punctuation">,</span> is_train<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>         <span class="token comment"># æŒ‡å®šRPNè¯¯å·®è®¡ç®—çš„å·¥å…·ç±»</span>        loss_evaluator <span class="token operator">=</span> make_rpn_loss_evaluator<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> rpn_box_coder<span class="token punctuation">)</span>         self<span class="token punctuation">.</span>anchor_generator <span class="token operator">=</span> anchor_generator        self<span class="token punctuation">.</span>head <span class="token operator">=</span> head        self<span class="token punctuation">.</span>box_selector_train <span class="token operator">=</span> box_selector_train        self<span class="token punctuation">.</span>box_selector_test <span class="token operator">=</span> box_selector_test        self<span class="token punctuation">.</span>loss_evaluator <span class="token operator">=</span> loss_evaluator     <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">,</span> features<span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""        Arguments:            images (ImageList): images for which we want to compute the predictions            features (list[Tensor]): features computed from the images that are                used for computing the predictions. Each tensor in the list                correspond to different feature levels            targets (list[BoxList): ground-truth boxes present in the image (optional)            è¾“å…¥ï¼š            images:å›¾ç‰‡çš„å¼ é‡åˆ—è¡¨            featuresï¼šbackboneæ‰€æå–çš„ç‰¹å¾å›¾            targets: å›¾ç‰‡çš„ground truthæ ‡ç­¾        Returns:            boxes (list[BoxList]): the predicted boxes from the RPN, one BoxList per                image.            losses (dict[Tensor]): the losses for the model during training. During                testing, it is an empty dict.            è¿”å›å€¼ï¼š            boxesï¼šRPNé¢„æµ‹çš„è¾¹æ¡†ï¼Œ ä¸€å¼ å›¾å¯¹åº”ä¸€ä¸ªè¾¹æ¡†åˆ—è¡¨ï¼ˆè¾¹æ¡†åˆ—è¡¨é‡Œé¢æœ‰å¾ˆå¤šè¾¹æ¡†ï¼‰            lossesï¼šè®­ç»ƒè¿‡ç¨‹æ‰€å¯¹åº”çš„æŸå¤±ï¼ˆå¦‚æœæ˜¯æµ‹è¯•é˜¶æ®µè¿™ä¸ªåœ°æ–¹å°±ä¸ºç©ºï¼‰        """</span>        <span class="token comment"># RPN headå¾—åˆ°æ¯ä¸€ä¸ªåƒç´ ç‚¹æ‰€å¯¹åº”çš„å¤šä¸ªanchorså›å½’åé‡</span>          ä»¥åŠanchorsä¸­æ˜¯å¦å«æœ‰ç‰©ä½“çš„äºŒåˆ†ç±»ç»“æœï¼ˆanchorsï¼‰        <span class="token comment"># objectnessæ˜¯æŒ‡äºŒåˆ†ç±»çš„ç»“æœ</span>        objectness<span class="token punctuation">,</span> rpn_box_regression <span class="token operator">=</span> self<span class="token punctuation">.</span>head<span class="token punctuation">(</span>features<span class="token punctuation">)</span>        anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>anchor_generator<span class="token punctuation">(</span>images<span class="token punctuation">,</span> features<span class="token punctuation">)</span>         <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_forward_train<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> rpn_box_regression<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_forward_test<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> rpn_box_regression<span class="token punctuation">)</span>     <span class="token keyword">def</span> <span class="token function">_forward_train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> rpn_box_regression<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN_ONLY<span class="token punctuation">:</span>            <span class="token comment"># When training an RPN-only model, the loss is determined by the</span>            <span class="token comment"># predicted objectness and rpn_box_regression values and there is</span>            <span class="token comment"># no need to transform the anchors into predicted boxes; this is an</span>            <span class="token comment"># optimization that avoids the unnecessary transformation.</span>            boxes <span class="token operator">=</span> anchors        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token comment"># For end-to-end models, anchors must be transformed into boxes and</span>            <span class="token comment"># sampled into a training batch.</span>            <span class="token comment"># éœ€è¦æŒ‘é€‰å‡ºä¸€éƒ¨åˆ†boxï¼ˆProposalsï¼‰ç”¨äº ä¸‹ä¸€ä¸ªé˜¶æ®µçš„è®­ç»ƒ</span>            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>box_selector_train<span class="token punctuation">(</span>                    anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> rpn_box_regression<span class="token punctuation">,</span> targets                <span class="token punctuation">)</span>        <span class="token comment"># RPNçš„lossæ˜¯è®¡ç®—äº†æ‰€æœ‰çš„anchorsçš„lossï¼Œè€Œä¸æ˜¯ä»…ä»…æ˜¯ç”¨äºä¸‹ä¸€é˜¶æ®µboxsï¼ˆProposalsï¼‰çš„loss</span>        loss_objectness<span class="token punctuation">,</span> loss_rpn_box_reg <span class="token operator">=</span> self<span class="token punctuation">.</span>loss_evaluator<span class="token punctuation">(</span>            anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> rpn_box_regression<span class="token punctuation">,</span> targets        <span class="token punctuation">)</span>        losses <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">"loss_objectness"</span><span class="token punctuation">:</span> loss_objectness<span class="token punctuation">,</span>            <span class="token string">"loss_rpn_box_reg"</span><span class="token punctuation">:</span> loss_rpn_box_reg<span class="token punctuation">,</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> boxes<span class="token punctuation">,</span> losses     <span class="token keyword">def</span> <span class="token function">_forward_test</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> rpn_box_regression<span class="token punctuation">)</span><span class="token punctuation">:</span>        boxes <span class="token operator">=</span> self<span class="token punctuation">.</span>box_selector_test<span class="token punctuation">(</span>anchors<span class="token punctuation">,</span> objectness<span class="token punctuation">,</span> rpn_box_regression<span class="token punctuation">)</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN_ONLY<span class="token punctuation">:</span>            <span class="token comment"># For end-to-end models, the RPN proposals are an intermediate state</span>            <span class="token comment"># and don't bother to sort them in decreasing score order. For RPN-only</span>            <span class="token comment"># models, the proposals are the final output and we return them in</span>            <span class="token comment"># high-to-low confidence order.</span>            <span class="token comment"># RPN-ONLYæ¨¡å‹boxeså°±æ˜¯æœ€åçš„è¾“å‡ºï¼Œå¯¹å…¶è¿›è¡Œæ’åº</span>            inds <span class="token operator">=</span> <span class="token punctuation">[</span>                box<span class="token punctuation">.</span>get_field<span class="token punctuation">(</span><span class="token string">"objectness"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort<span class="token punctuation">(</span>descending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> box <span class="token keyword">in</span> boxes            <span class="token punctuation">]</span>            boxes <span class="token operator">=</span> <span class="token punctuation">[</span>box<span class="token punctuation">[</span>ind<span class="token punctuation">]</span> <span class="token keyword">for</span> box<span class="token punctuation">,</span> ind <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> inds<span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token keyword">return</span> boxes<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¦‚æœæƒ³è¦è¯»æ‡‚RPNModuleç±»å…·ä½“å¹²äº†ä¸€äº›å•¥ï¼Œå°±éœ€è¦å…ˆé˜…è¯»ï¼š</p><p>åœ¨your_project/maskrcnn_benchmark/modeling/rpn/inference.pyä¸­çš„make_rpn_postprocessor()å‡½æ•°</p><p>ä»¥åŠyour_project/maskrcnn_benchmark/modeling/rpn/loss.pyä¸­çš„make_rpn_loss_evaluator()å‡½æ•° (make_anchor_generatorå°±ä¸åšä»‹ç»äº†)ï¼š</p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benchmark-master-wu-rpn-de-inference-wen-jian/">maskrcnn-benchmark-masterï¼ˆäº”ï¼‰ï¼šRPNçš„inferenceæ–‡ä»¶</a></p><p><a href="https://kingpopen.github.io/2021/08/01/maskrcnn-benchmark-master-liu-rpn-de-loss-wen-jian/">maskrcnn-benchmark-masterï¼ˆå…­ï¼‰ï¼šRPNçš„lossæ–‡ä»¶</a></p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benchmark-masterï¼ˆä¸‰ï¼‰ï¼šbuild_backbone()å‡½æ•°</title>
      <link href="/2021/07/27/maskrcnn-benchmark-master-san-build-backbone-han-shu/"/>
      <url>/2021/07/27/maskrcnn-benchmark-master-san-build-backbone-han-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>é€šè¿‡ä¹‹å‰çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“build_backbone()å‡½æ•°çš„ä½œç”¨å°±æ˜¯ç”Ÿæˆä¸€ä¸ªbackboneï¼ˆbackboneçš„ä½œç”¨å°±æ˜¯æå–å›¾åƒç‰¹å¾ï¼‰ã€‚å…¶å®æœ¬èº«build_backboneï¼ˆï¼‰å‡½æ•°å½“ä¸­æ²¡æœ‰å¤šå°‘å¥½è®²çš„ï¼Œä½†é‡Œé¢ç”¨åˆ°äº†ä¸€ä¸ªregistryçš„ç±»ï¼Œå…¶ä»–çš„å¥½å¤šå‡½æ•°ä¸­éƒ½æœ‰ç”¨åˆ°è¿™ä¸ªç±»ï¼Œæ‰€ä»¥registryå°±æ”¾åˆ°æœ¬ç¯‡åšå®¢ä¸­ä¸€èµ·ä»‹ç»ã€‚</p></blockquote><h3 id="ä¸€ã€Registry"><a href="#ä¸€ã€Registry" class="headerlink" title="ä¸€ã€Registry"></a>ä¸€ã€Registry</h3><blockquote><p>build_backboneï¼ˆï¼‰å‡½æ•°æ˜¯åœ¨<strong>your_project/maskrcnn_benchmark/modeling/backbone/backbone.py</strong>æ–‡ä»¶ä¸­ï¼Œå½“æ‰“å¼€è¿™ä¸ªbackbone.pyè¿™ä¸ªæ–‡ä»¶ï¼Œå°±ä¼šå‘ç°æœ‰å¥½å¤šå¦‚ä¸‹ä»£ç ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> maskrcnn_benchmark<span class="token punctuation">.</span>modeling <span class="token keyword">import</span> registry<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"R-50-C4"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"R-50-C5"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"R-101-C4"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"R-101-C5"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘å°±è¦å¥½å¥½äº†è§£ä¸€ä¸‹ï¼Œregistryç©¶ç«Ÿæ˜¯ä¸€ä¸ªä»€ä¹ˆï¼Ÿ</p><p>Registryç±»æ˜¯åœ¨your_project/maskrcnn_benchmark/utils/registry.pyæ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰çš„ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">_register_generic</span><span class="token punctuation">(</span>module_dict<span class="token punctuation">,</span> module_name<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">assert</span> module_name <span class="token keyword">not</span> <span class="token keyword">in</span> module_dict    module_dict<span class="token punctuation">[</span>module_name<span class="token punctuation">]</span> <span class="token operator">=</span> module  <span class="token keyword">class</span> <span class="token class-name">Registry</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''    A helper class for managing registering modules, it extends a dictionary    and provides a register functions.    Eg. creeting a registry:        some_registry = Registry({"default": default_module})    There're two ways of registering new modules:    1): normal way is just calling register function:        def foo():            ...        some_registry.register("foo_module", foo)    2): used as decorator when declaring the module:        @some_registry.register("foo_module")        @some_registry.register("foo_module_nickname")        def foo():            ...    Access of module is just like using a dictionary, eg:        f = some_registry["foo_module"]    '''</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>Registry<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>    <span class="token comment"># å°±æ˜¯ä¸€ä¸ªè£…é¥°å™¨</span>    <span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> module_name<span class="token punctuation">,</span> module<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># used as function call</span>        <span class="token keyword">if</span> module <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>            <span class="token comment"># è¯¥å‡½æ•°æ˜¯å°†module_name å’Œ moudle ä»¥key å’Œ value çš„å½¢å¼åŠ åˆ°å­—å…¸å½“ä¸­å»</span>            _register_generic<span class="token punctuation">(</span>self<span class="token punctuation">,</span> module_name<span class="token punctuation">,</span> module<span class="token punctuation">)</span>            <span class="token keyword">return</span>         <span class="token comment"># used as decorator</span>        <span class="token keyword">def</span> <span class="token function">register_fn</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">:</span>            _register_generic<span class="token punctuation">(</span>self<span class="token punctuation">,</span> module_name<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>            <span class="token keyword">return</span> fn         <span class="token keyword">return</span> register_fn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æˆ‘æ¥ç»™å¤§å®¶ <strong>ç¿»è¯‘ ç¿»è¯‘</strong> ä¸Šé¢ä¸€å¤§æ®µçš„å‡½æ•°ç›¸å…³ä»‹ç»æ³¨é‡Š éƒ½è¯´äº†å†™å•¥ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"> Registryæ˜¯ä¸€ä¸ªç”¨æ¥ç®¡ç†æ³¨å†Œæ¨¡å—çš„helperç±»ï¼Œå®ƒç»§æ‰¿äº†ä¸€ä¸ªå­—å…¸ç±»ï¼Œå¹¶ä¸”æ·»åŠ äº†registeræ–¹æ³•ã€‚ä¸¾ä¸€ä¸ªå¦‚ä½•ä½¿ç”¨çš„ä¾‹å­ï¼š<span class="token number">1</span>ã€åˆ›å»ºä¸€ä¸ªregistryå¯¹è±¡    some_registry <span class="token operator">=</span> Registry<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">(</span>æœ‰æ²¡æœ‰å‚æ•°éƒ½å¯ä»¥<span class="token punctuation">)</span><span class="token number">2</span>ã€æ³¨å†Œæ–°çš„æ¨¡å— ï¼ˆæœ‰ä¸¤ç§æ–¹å¼ï¼‰   æ–¹å¼ä¸€ï¼šæ­£å¸¸çš„æ–¹å¼æ˜¯è°ƒç”¨registerå‡½æ•°è¿›è¡Œæ³¨å†Œï¼š         <span class="token comment"># é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ¨¡å— foo</span>         <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token comment"># ç„¶ååœ¨registryå¯¹è±¡ä¸Šæ³¨å†Œå®ƒ  </span>         <span class="token comment"># foo_moduleç›¸å½“äºå­—å…¸çš„keyï¼Œfooç›¸å½“äºå­—å…¸çš„value(ç®€å•å§ hhh)</span>         some_registry<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">"foo_module"</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span>   æ–¹å¼äºŒï¼šåœ¨å£°æ˜æŸä¸ªæ¨¡å—æ—¶ï¼Œä½œä¸ºä¸€ä¸ªè£…é¥°å™¨ä½¿ç”¨ï¼š         <span class="token decorator annotation punctuation">@some_registry<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"foo_module"</span><span class="token punctuation">)</span>         <span class="token decorator annotation punctuation">@some_registry<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"foo_module_nickname"</span><span class="token punctuation">)</span>          <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token comment"># æ•ˆæœç­‰åŒäº  ï¼šsome_registry.register("foo_module", foo)</span>         <span class="token comment">#              some_registry.register("foo_module_nickname", foo)</span> <span class="token number">3</span>ã€è·å–è¢«æ³¨å†Œçš„æ¨¡å—<span class="token punctuation">(</span>åƒä½¿ç”¨å­—å…¸ä¸€æ ·<span class="token punctuation">)</span>      f <span class="token operator">=</span> some_registry<span class="token punctuation">[</span><span class="token string">"foo_module"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="äºŒã€Backbone"><a href="#äºŒã€Backbone" class="headerlink" title="äºŒã€Backbone"></a>äºŒã€Backbone</h3><blockquote><p>å¥½ï¼æœ‰äº†ä¸Šé¢Registryçš„ä»‹ç»ï¼Œæˆ‘å†æ¥çœ‹çœ‹backbone.pyæ–‡ä»¶å°±ä¼šè½»æ¾å¾ˆå¤šã€‚åœ¨backbone.pyä¸­registryå¤§éƒ½æ˜¯é€šè¿‡æ–¹å¼äºŒï¼šä½œä¸ºä¸€ç§è£…é¥°å™¨ä½¿ç”¨çš„ï¼Œå¦‚ä¸‹ä¾‹ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># ç›¸å½“äºåœ¨BACKBONESçš„å­—å…¸ä¸­æ³¨å†Œäº†"R-50-C4"ã€"R-50-C5"ã€"R-101-C4"ã€"R-101-C5"è¿™å‡ ä¸ªkey </span><span class="token comment"># å®ƒä»¬å¯¹åº”çš„valueéƒ½æ˜¯ build_resnet_backbone()è¿™ä¸ªå‡½æ•°</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"R-50-C4"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"R-50-C5"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"R-101-C4"</span><span class="token punctuation">)</span><span class="token decorator annotation punctuation">@registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span><span class="token string">"R-101-C5"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">build_resnet_backbone</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># é€šè¿‡cfgæ¥å†³å®šresnetæ˜¯50è¿˜æ˜¯101</span>    body <span class="token operator">=</span> resnet<span class="token punctuation">.</span>ResNet<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>    model <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>OrderedDict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># é€šè¿‡cfgæ¥å†³å®šè¾“å‡ºæ˜¯C4è¿˜æ˜¯C5</span>    model<span class="token punctuation">.</span>out_channels <span class="token operator">=</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RESNETS<span class="token punctuation">.</span>BACKBONE_OUT_CHANNELS    <span class="token keyword">return</span> model<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment"># åé¢çš„å‡ ä¸ªéƒ½æ˜¯ç±»ä¼¼çš„æƒ…å†µï¼Œå°±ä¸ä¸€ä¸€å±•å¼€äº†~</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æˆ‘ä»¬æ¥ç€çœ‹åˆ°build_backbone(cfg)å‡½æ•°ï¼Œå®ƒå°±æ˜¯è¿”å›backboneçš„å‡½æ•°ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_backbone</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">assert</span> cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>BACKBONE<span class="token punctuation">.</span>CONV_BODY <span class="token keyword">in</span> registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">,</span> \        <span class="token string">"cfg.MODEL.BACKBONE.CONV_BODY: {} are not registered in registry"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>            cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>BACKBONE<span class="token punctuation">.</span>CONV_BODY        <span class="token punctuation">)</span>    <span class="token comment"># backboneçš„ç±»å‹é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„CONV_BODYæ¥å†³å®š</span>    <span class="token comment"># registry.BACKBONES[***]æ˜¯è·å–å¯¹åº”çš„æ³¨å†Œå™¨å­—å…¸ä¸­çš„value (å½“å‰åœºæ™¯ä¸­valueæ˜¯ä¸€ä¸ªå‡½æ•°)</span>    <span class="token comment"># ç„¶åå¯¹è·å–çš„å‡½æ•°è¾“å…¥å½¢å‚cfg  è¿”å›ä¸€ä¸ªbackboneæ¨¡å‹å¯¹è±¡ã€‚</span>    Â·Â·Â·      <span class="token comment"># ç­‰ä»·äºå¦‚ä¸‹</span>      foo <span class="token operator">=</span> registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">[</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>BACKBONE<span class="token punctuation">.</span>CONV_BODY<span class="token punctuation">]</span>      backbone <span class="token operator">=</span> foo<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>      <span class="token keyword">return</span> backbone     Â·Â·Â·<span class="token keyword">return</span> registry<span class="token punctuation">.</span>BACKBONES<span class="token punctuation">[</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>BACKBONE<span class="token punctuation">.</span>CONV_BODY<span class="token punctuation">]</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>è‡³æ­¤backboneçš„è·å–è¿‡ç¨‹å°±ä»‹ç»å®Œäº†ï¼Œæœ¬ç¯‡å†…å®¹å¹¶æ²¡æœ‰æ¶‰åŠåˆ°backboneä¸­ResNetç½‘ç»œï¼ŒFPNç½‘ç»œæ˜¯å¦‚ä½•æ„é€ çš„ï¼Œå¦‚æœéœ€è¦äº†è§£ç›¸å…³ç»†èŠ‚ï¼Œå¯ä»¥æŸ¥çœ‹å…¶æºä»£ç ã€‚</p><p>æœ¬ç¯‡åªæ˜¯ç®€å•ä»‹ç»äº†æ•´ä¸ªbuild_backboneï¼ˆï¼‰å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œæ—¢ç„¶å·²ç»æ„é€ å¥½äº†backboneï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯æ„é€ RPNï¼Œä¸‹é¢ä¸€ç¯‡å°†ä»‹ç»RPNçš„æ„é€ ã€‚</p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benchmark-master-si-build-rpn-han-shu/">maskrcnn-benchmark-masterï¼ˆå››ï¼‰ï¼šbuild_rpn()å‡½æ•°</a></p></blockquote><p>å‚è€ƒé“¾æ¥ï¼š<a href="https://blog.csdn.net/RadiantJeral/article/details/103433169">https://blog.csdn.net/RadiantJeral/article/details/103433169</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benckmark-master ï¼ˆäºŒï¼‰ï¼šGeneralizedRCNNç±»</title>
      <link href="/2021/07/27/maskrcnn-benckmark-master-er-generalizedrcnn-lei/"/>
      <url>/2021/07/27/maskrcnn-benckmark-master-er-generalizedrcnn-lei/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ä¸Šæ¬¡ä»‹ç»åˆ°äº†é…ç½®æ–‡ä»¶å¦‚ä½•ä½¿ç”¨ï¼Œä»¥åŠé…ç½®æ–‡ä»¶cfgå¯¹è±¡æœ€åä¼ åˆ°äº†ä¸€ä¸ªGeneralizedRCNNç±»ä¸­ã€‚æœ¬ç¯‡ï¼Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹GeneralizedRCNNç±»ç©¶ç«Ÿæ˜¯æ€ä¹ˆæ„å»ºå‡ºä¸€ä¸ªæ¨¡å‹çš„ã€‚GeneralizedRCNNç»“æ„ç®€å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><p><img src="GeneralizedRCNN%E7%BB%93%E6%9E%84%E5%9B%BE.jpg" alt="å›¾1 GeneralizedRCNNç»“æ„å›¾"></p><h3 id="ä¸€ã€GeneralizedRCNNç±»"><a href="#ä¸€ã€GeneralizedRCNNç±»" class="headerlink" title="ä¸€ã€GeneralizedRCNNç±»"></a>ä¸€ã€GeneralizedRCNNç±»</h3><blockquote><p>GeneralizedRCNNç±»åœ¨<strong>your_project/maskrcnn_benchmark/modeling/detector/generalized_rcnn.py</strong>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹æ„é€ å‡½æ•°**<em>init</em>()**:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token builtin">super</span><span class="token punctuation">(</span>GeneralizedRCNN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token triple-quoted-string string">'''        build_backbone()  build_rpn()  build_roi_heads()é‡ç‚¹éœ€è¦äº†è§£çš„å‡½æ•°        build_backbone()ä¸»è¦æ˜¯åˆ›å»ºResNet+FPNç­‰ç‰¹å¾æå–ç½‘ç»œ        build_rpn()ä¸»è¦æ˜¯åˆ›å»ºRPNç»“æ„        build_roi_heads()ä¸»è¦æ˜¯åˆ›å»ºROI box head  ROI mask headç­‰ç»“æ„                '''</span>         <span class="token comment"># åˆ›å»ºéª¨å¹²ç½‘ç»œ</span>        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> build_backbone<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>        <span class="token comment"># åˆ›å»ºrpn</span>        self<span class="token punctuation">.</span>rpn <span class="token operator">=</span> build_rpn<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>out_channels<span class="token punctuation">)</span>        <span class="token comment"># åˆ›å»ºroi_heads</span>        self<span class="token punctuation">.</span>roi_heads <span class="token operator">=</span> build_roi_heads<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>out_channels<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä»æ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ªç½‘ç»œä¸»è¦ç”±3ä¸ªéƒ¨åˆ†ç»„æˆï¼šbackboneã€rpnã€roi_headsã€‚ï¼ˆä»¥ç±»å˜é‡çš„å½¢å¼å­˜åœ¨ï¼‰</p><p>è€Œè¿™ä¸‰ä¸ªéƒ¨åˆ†ä¸»è¦æ˜¯ç”±build_backboneï¼ˆï¼‰ã€build_rpnï¼ˆï¼‰ã€build_roi_headsï¼ˆï¼‰ä¸‰ä¸ªå‡½æ•°æ‰€ç”Ÿæˆï¼Œæˆ‘åé¢ä¼šä¾æ¬¡ä»‹ç»è¿™ä¸‰ä¸ªå‡½æ•°ã€‚</p><p>æ¥ç€ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹GeneralizedRCNNç±»çš„forward()å‡½æ•°ï¼Œè§‚å¯Ÿä¸Šé¢ä¸Šé¢ä¸‰ä¸ªç±»å˜é‡æ˜¯å¦‚ä½•è¿›è¡Œå·¥ä½œçš„:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">,</span> targets<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    Arguments:        images (list[Tensor] or ImageList): images to be processed        targets (list[BoxList]): ground-truth boxes present in the image (optional)    Returns:        result (list[BoxList] or dict[Tensor]): the output from the model.            During training, it returns a dict[Tensor] which contains the losses.            è®­ç»ƒé˜¶æ®µè¿”å›losså€¼            During testing, it returns list[BoxList] contains additional fields            like `scores`, `labels` and `mask` (for Mask R-CNN models).            æµ‹è¯•é˜¶æ®µè¿”å›é¢„æµ‹çš„ç»“æœï¼ˆå¾—åˆ†ï¼Œ æ ‡ç­¾ï¼Œ maskï¼‰    """</span>     <span class="token comment"># è®­ç»ƒè¿‡ç¨‹ï¼Œè¾“å…¥çš„æ•°æ®å¿…é¡»æœ‰å¯¹åº”çš„æ ‡ç­¾ï¼Œä¸ç„¶æ²¡æ³•è®¡ç®—æŸå¤±</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">and</span> targets <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"In training mode, targets should be passed"</span><span class="token punctuation">)</span>    images <span class="token operator">=</span> to_image_list<span class="token punctuation">(</span>images<span class="token punctuation">)</span>    <span class="token comment"># å›¾åƒç»è¿‡backboneä¹‹å  è¾“å‡ºæå–çš„å›¾åƒç‰¹å¾</span>    features <span class="token operator">=</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>images<span class="token punctuation">.</span>tensors<span class="token punctuation">)</span>    <span class="token comment"># ç‰¹å¾ç»è¿‡RPNç½‘ç»œå¾—åˆ°proposalså’Œç›¸åº”çš„losså€¼ï¼ˆå› æ­¤RPNçš„ä½œç”¨å°±æ˜¯è·å–Proposalså’Œè®­ç»ƒæ—¶RPNçš„lossï¼‰</span>    <span class="token comment"># self.rpnè¿”å›å€¼çš„proposalsä¸­æ˜¯cat_Boxlistå¾—åˆ°çš„ç»“æœlist(BoxList) shape is ï¼ˆbatch sizeï¼Œï¼‰</span>    proposals<span class="token punctuation">,</span> proposal_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>rpn<span class="token punctuation">(</span>images<span class="token punctuation">,</span> features<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>roi_heads<span class="token punctuation">:</span>        <span class="token comment"># resultæ˜¯æ£€æµ‹çš„ç»“æœï¼Œdetection_lossesçš„æŸå¤±ï¼ˆå¦‚æœå­˜åœ¨maskåˆ†æ”¯ï¼Œresultå’Œdetection_losséƒ½æ˜¯åŒ…å«æœ‰maskçš„æ£€æµ‹ç»“æœå’Œmaskçš„æŸå¤±çš„ï¼‰</span>        x<span class="token punctuation">,</span> result<span class="token punctuation">,</span> detector_losses <span class="token operator">=</span> self<span class="token punctuation">.</span>roi_heads<span class="token punctuation">(</span>features<span class="token punctuation">,</span> proposals<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token comment"># å¦‚æœåªæå–Proposalsï¼ˆProposalåªæ˜¯è¡¨ç¤ºå¯èƒ½æ˜¯éœ€è¦æ£€æµ‹çš„ç‰©ä½“ï¼Œ</span>        <span class="token comment"># å…·ä½“æ˜¯ä»€ä¹ˆäº†ç±»åˆ«è¿˜ä¸æ¸…æ¥šï¼‰ï¼Œè€Œä¸å¯¹Proposalsè¿›è¡Œåˆ†ç±»</span>        <span class="token comment"># RPN-only models don't have roi_heads</span>        x <span class="token operator">=</span> features        result <span class="token operator">=</span> proposals        detector_losses <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>     <span class="token comment"># å°†losså€¼éƒ½æ”¾åˆ°ä¸€ä¸ªå­—å…¸é‡Œé¢ä¿å­˜</span>    <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>        losses <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>detector_losses<span class="token punctuation">)</span>        losses<span class="token punctuation">.</span>update<span class="token punctuation">(</span>proposal_losses<span class="token punctuation">)</span>        <span class="token keyword">return</span> losses     <span class="token keyword">return</span> result<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>ä»forward()å‡½æ•°ä¸­å¯ä»¥å¾—çŸ¥ï¼š</p><p><strong>å¦‚æœæ˜¯è®­ç»ƒè¿‡ç¨‹ï¼Œforwardè¿”å›å€¼å°±æ˜¯losså€¼ã€‚</strong></p><p><strong>(å¦‚æœä¸æ˜¯è®­ç»ƒè¿‡ç¨‹ï¼Œè¿”å›å€¼å°±æ˜¯æ£€æµ‹çš„ç»“æœï¼ˆbounding boxã€ç±»åˆ«ã€maskï¼‰ã€‚</strong></p></blockquote><h3 id="äºŒã€åç»­"><a href="#äºŒã€åç»­" class="headerlink" title="äºŒã€åç»­"></a>äºŒã€åç»­</h3><blockquote><p>ä¸‹é¢å°†ä¸»è¦ä»‹ç»build_backboneï¼ˆï¼‰ã€build_rpnï¼ˆï¼‰å’Œ build_roi_headsï¼ˆï¼‰å‡½æ•°çš„ç›¸å…³å†…å®¹ï¼š</p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benchmark-master-san-build-backbone-han-shu/">maskrcnn-benckmark-masterï¼ˆä¸‰ï¼‰ï¼šbuild_backbone()å‡½æ•°</a></p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benchmark-master-si-build-rpn-han-shu/">maskrcnn-benchmark-masterï¼ˆå››ï¼‰ï¼šbuild_rpn()å‡½æ•°</a></p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benchmark-master-wu-rpn-de-inference-wen-jian/">maskrcnn-benchmark-masterï¼ˆäº”ï¼‰ï¼šRPNçš„inferenceæ–‡ä»¶</a></p><p>build_roi_headsï¼ˆï¼‰å‡½æ•°ç›¸å…³å†…å®¹è¿˜æœªå®Œæˆï¼Œå¾…ç»­~</p><p>ç å­—ä¸æ˜“ï¼Œæœªç»è®¸å¯ï¼Œè¯·å‹¿éšæ„è½¬è½½!</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benckmark-master ï¼ˆä¸€ï¼‰ï¼šé…ç½®æ–‡ä»¶</title>
      <link href="/2021/07/27/maskrcnn-benckmark-master-yi-pei-zhi-wen-jian/"/>
      <url>/2021/07/27/maskrcnn-benckmark-master-yi-pei-zhi-wen-jian/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>â€‹        ä½œä¸ºæœ¬ç³»åˆ—çš„å¼€ç¯‡ï¼Œæˆ‘é¦–å…ˆä»‹ç»çš„æ˜¯é…ç½®æ–‡ä»¶éƒ¨åˆ†ï¼Œå› ä¸ºæ•´ä¸ªæ¨¡å‹çš„æ­å»ºéƒ½å’Œé…ç½®æ–‡ä»¶æœ‰å¾ˆå¤§çš„å…³ç³»ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹é…ç½®æ–‡ä»¶é‡Œé¢éƒ½æœ‰å•¥ç›¸å…³å‚æ•°é…ç½®ã€‚</p></blockquote><h3 id="ä¸€ã€é…ç½®æ–‡ä»¶"><a href="#ä¸€ã€é…ç½®æ–‡ä»¶" class="headerlink" title="ä¸€ã€é…ç½®æ–‡ä»¶"></a>ä¸€ã€é…ç½®æ–‡ä»¶</h3><blockquote><p>maskrcnn-benckmark-masteræ˜¯æä¾›æœ‰é»˜è®¤çš„é…ç½®çš„ï¼Œè§æ–‡ä»¶:<strong>your_project/maskrcnn_benckmark/config/defaults.py</strong></p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token comment"># é€šè¿‡yacsåŒ…æ¥ç”Ÿæˆçš„é»˜è®¤é…ç½®</span><span class="token keyword">from</span> yacs<span class="token punctuation">.</span>config <span class="token keyword">import</span> CfgNode <span class="token keyword">as</span> CN  _C <span class="token operator">=</span> CN<span class="token punctuation">(</span><span class="token punctuation">)</span> _C<span class="token punctuation">.</span>MODEL <span class="token operator">=</span> CN<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># è¡¨ç¤ºæ˜¯å¦åªæœ‰RPN</span>_C<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RPN_ONLY <span class="token operator">=</span> <span class="token boolean">False</span><span class="token comment"># è¡¨ç¤ºæ˜¯å¦å«æœ‰Maskåˆ†æ”¯</span>_C<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>MASK_ON <span class="token operator">=</span> <span class="token boolean">False</span>_C<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>RETINANET_ON <span class="token operator">=</span> <span class="token boolean">False</span>_C<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>KEYPOINT_ON <span class="token operator">=</span> <span class="token boolean">False</span><span class="token comment"># è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨GPU</span>_C<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>DEVICE <span class="token operator">=</span> <span class="token string">"cuda"</span><span class="token comment"># é»˜è®¤çš„ç½‘ç»œæ¡†æ¶</span>_C<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>META_ARCHITECTURE <span class="token operator">=</span> <span class="token string">"GeneralizedRCNN"</span>_C<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>CLS_AGNOSTIC_BBOX_REG <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>é‚£å¦‚æœæˆ‘ä»¬éœ€è¦ä¿®æ”¹ç›¸å…³é…ç½®ï¼Œéš¾é“éœ€è¦åœ¨è¿™ä¸ªdefaults.pyæ–‡ä»¶ä¸­è¿›è¡Œä¿®æ”¹å—ï¼Ÿ</p><p>NO! NO! NO!</p><p>æˆ‘ä»¬å…¶å®åªè¦æŠŠéœ€è¦ä¿®æ”¹çš„é…ç½®å†™åœ¨ä¸€ä¸ªå¸¦.yamlåç¼€çš„æ–‡ä»¶ä¸­ï¼Œä»è€Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶æ¥ä¿®æ”¹é»˜è®¤çš„é…ç½®ï¼Œè§æ–‡ä»¶your_project/configs/e2e_mask_rcnn_R_50_FPN_1x.yaml</p><p>ä¸‹é¢ä»¥e2e_mask_rcnn_R_50_FPN_1x.yamlæ–‡ä»¶ä¸ºä¾‹ å¯¹æ¨¡å‹çš„é…ç½®æ–‡ä»¶è¿›è¡Œç®€å•çš„ä»‹ç»ï¼š</p></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># ä¸‹é¢çš„è¿™äº›å˜é‡ï¼ˆkeyå°±å¯ä»¥å½“åšå˜é‡ï¼Œvalueå°±æ˜¯å˜é‡çš„å€¼ï¼‰éƒ½æ˜¯åœ¨default.pyéƒ½å®šä¹‰å¥½çš„ï¼Œ</span><span class="token comment"># ä¸‹é¢å‡ºç°çš„å˜é‡å¤§éƒ¨åˆ†éƒ½æ˜¯éœ€è¦è¿›è¡Œæ›´æ”¹çš„ï¼Œä¸éœ€è¦æ›´æ”¹çš„ç›´æ¥ä½¿ç”¨é»˜è®¤çš„å°±è¡Œäº†ï¼Œä¸éœ€è¦åœ¨æ­¤å¤„è¿›è¡Œé…ç½®ã€‚</span><span class="token key atrule">MODEL</span><span class="token punctuation">:</span><span class="token comment"># é»˜è®¤çš„RCNNç½‘ç»œæ¡†æ¶ ï¼ˆä»£ç ä¸­ä¼šæœ‰GeneralizedRCNNç±»ï¼Œå°±æ˜¯é€šè¿‡ä¼ å…¥é…ç½®æ–‡ä»¶æ¥ç”Ÿæˆæ¨¡å‹çš„ï¼‰  </span>  <span class="token key atrule">META_ARCHITECTURE</span><span class="token punctuation">:</span> <span class="token string">"GeneralizedRCNN"</span><span class="token comment"># é¢„è®­ç»ƒçš„æƒé‡æ–‡ä»¶</span>  <span class="token key atrule">WEIGHT</span><span class="token punctuation">:</span> <span class="token string">"catalog://ImageNetPretrained/MSRA/R-50"</span> <span class="token comment"># éª¨å¹²ç½‘ç»œï¼ˆCNNç‰¹å¾æå–å™¨ï¼Œå®˜æ–¹å®ç°äº†å¥½å‡ ç§ï¼Œä¸‹é¢è¿™ç§æ˜¯ResNet-50+FPNï¼‰</span>  <span class="token key atrule">BACKBONE</span><span class="token punctuation">:</span>    <span class="token key atrule">CONV_BODY</span><span class="token punctuation">:</span> <span class="token string">"R-50-FPN"</span><span class="token comment"># ResNetsä½œä¸ºç‰¹å¾æå–ç½‘ç»œçš„è¾“å‡ºçš„ç‰¹å¾ç»´åº¦</span>  <span class="token key atrule">RESNETS</span><span class="token punctuation">:</span>    <span class="token key atrule">BACKBONE_OUT_CHANNELS</span><span class="token punctuation">:</span> <span class="token number">256</span> <span class="token comment"># RPNçš„é…ç½®</span>  <span class="token key atrule">RPN</span><span class="token punctuation">:</span>    <span class="token comment"># æ˜¯å¦ä½¿ç”¨FPNï¼ˆç‰¹å¾é‡‘å­—å¡”ç½‘ç»œï¼‰</span>    <span class="token key atrule">USE_FPN</span><span class="token punctuation">:</span> <span class="token boolean important">True</span>    <span class="token comment"># anchorçš„é…ç½®</span>    <span class="token key atrule">ANCHOR_STRIDE</span><span class="token punctuation">:</span> (4<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> 64)    <span class="token comment"># ç”¨äºè®­ç»ƒè¿‡ç¨‹çš„ ç­›é€‰anchorsçš„æ•°ç›®</span>    <span class="token key atrule">PRE_NMS_TOP_N_TRAIN</span><span class="token punctuation">:</span> <span class="token number">2000</span>    <span class="token comment"># ç”¨äºæµ‹è¯•è¿‡ç¨‹çš„ ç­›é€‰anchorsçš„æ•°ç›®</span>    <span class="token key atrule">PRE_NMS_TOP_N_TEST</span><span class="token punctuation">:</span> <span class="token number">1000</span>    <span class="token comment"># ç”¨äºæµ‹è¯•è¿‡ç¨‹ NMSæ“ä½œä¹‹åç•™ä¸‹çš„Proposalsæ•°ç›®</span>    <span class="token key atrule">POST_NMS_TOP_N_TEST</span><span class="token punctuation">:</span> <span class="token number">1000</span>    <span class="token key atrule">FPN_POST_NMS_TOP_N_TEST</span><span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token comment"># ROI_HEADSé…ç½®</span>  <span class="token key atrule">ROI_HEADS</span><span class="token punctuation">:</span>    <span class="token comment"># æ˜¯å¦ä½¿ç”¨FPN</span>    <span class="token key atrule">USE_FPN</span><span class="token punctuation">:</span> <span class="token boolean important">True</span><span class="token comment"># classåˆ†ç±»å’Œbounding boxå›å½’åˆ†æ”¯</span>  <span class="token key atrule">ROI_BOX_HEAD</span><span class="token punctuation">:</span>    <span class="token comment"># ROI Alignå¤„ç†ä¹‹åæ‰€ç”Ÿæˆçš„ç»´åº¦</span>    <span class="token key atrule">POOLER_RESOLUTION</span><span class="token punctuation">:</span> <span class="token number">7</span>    <span class="token comment"># ä¸‹é¢è¿™å‡ ä¸ªå‚æ•°è¿˜æ²¡ææ˜ç™½ åç»­å†è¡¥ä¸Š~</span>    <span class="token key atrule">POOLER_SCALES</span><span class="token punctuation">:</span> (0.25<span class="token punctuation">,</span> <span class="token number">0.125</span><span class="token punctuation">,</span> <span class="token number">0.0625</span><span class="token punctuation">,</span> 0.03125)    <span class="token key atrule">POOLER_SAMPLING_RATIO</span><span class="token punctuation">:</span> <span class="token number">2</span>    <span class="token comment"># ç‰¹å¾æå–å™¨ï¼ˆå¯¹ROI Alignä¹‹åçš„ç»“æœè¿›è¡Œç‰¹å¾æå–ï¼‰</span>    <span class="token key atrule">FEATURE_EXTRACTOR</span><span class="token punctuation">:</span> <span class="token string">"FPN2MLPFeatureExtractor"</span>    <span class="token comment"># é¢„æµ‹å™¨ ï¼ˆä¸»è¦æ˜¯ä½¿ç”¨å…¨è¿æ¥å±‚è¿›è¡Œ åˆ†ç±»å’Œå›å½’ï¼‰</span>    <span class="token key atrule">PREDICTOR</span><span class="token punctuation">:</span> <span class="token string">"FPNPredictor"</span>  <span class="token comment"># maskåˆ†å‰²çš„åˆ†æ”¯</span>  <span class="token key atrule">ROI_MASK_HEAD</span><span class="token punctuation">:</span>    <span class="token comment"># ä¸‹é¢è¿™å‡ ä¸ªå‚æ•°è¿˜æ²¡ææ˜ç™½ åç»­å†è¡¥ä¸Š~</span>    <span class="token key atrule">POOLER_SCALES</span><span class="token punctuation">:</span> (0.25<span class="token punctuation">,</span> <span class="token number">0.125</span><span class="token punctuation">,</span> <span class="token number">0.0625</span><span class="token punctuation">,</span> 0.03125)    <span class="token comment"># ç‰¹å¾æå–å™¨ï¼ˆå¯¹ROI Alignä¹‹åçš„ç»“æœè¿›è¡Œç‰¹å¾æå–ï¼‰</span>    <span class="token key atrule">FEATURE_EXTRACTOR</span><span class="token punctuation">:</span> <span class="token string">"MaskRCNNFPNFeatureExtractor"</span>    <span class="token comment"># é¢„æµ‹å™¨ ï¼ˆä¸»è¦æ˜¯ç”Ÿæˆmaskï¼‰</span>    <span class="token key atrule">PREDICTOR</span><span class="token punctuation">:</span> <span class="token string">"MaskRCNNC4Predictor"</span>    <span class="token comment"># ä¸‹é¢è¿™å‡ ä¸ªå‚æ•°è¿˜æ²¡ææ˜ç™½ åç»­å†è¡¥ä¸Š~</span>    <span class="token key atrule">POOLER_RESOLUTION</span><span class="token punctuation">:</span> <span class="token number">14</span>    <span class="token key atrule">POOLER_SAMPLING_RATIO</span><span class="token punctuation">:</span> <span class="token number">2</span>    <span class="token key atrule">RESOLUTION</span><span class="token punctuation">:</span> <span class="token number">28</span>    <span class="token comment"># æ˜¯å¦ä½¿ç”¨ROI BOX HEADç‰¹å¾æå–å™¨æå–å¥½çš„ç‰¹å¾</span>    <span class="token key atrule">SHARE_BOX_FEATURE_EXTRACTOR</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>  <span class="token key atrule">MASK_ON</span><span class="token punctuation">:</span> <span class="token boolean important">True</span> <span class="token comment"># æ•°æ®é›†çš„åç§°</span><span class="token key atrule">DATASETS</span><span class="token punctuation">:</span>  <span class="token key atrule">TRAIN</span><span class="token punctuation">:</span> ("coco_2014_train"<span class="token punctuation">,</span> "coco_2014_valminusminival")  <span class="token key atrule">TEST</span><span class="token punctuation">:</span> ("coco_2014_minival"<span class="token punctuation">,</span>) <span class="token comment"># æ•°æ®é›†çš„Dataloaderé…ç½®ï¼ˆç”¨æ¥è¯»å–æ•°æ®é›†ï¼‰</span><span class="token key atrule">DATALOADER</span><span class="token punctuation">:</span>  <span class="token key atrule">SIZE_DIVISIBILITY</span><span class="token punctuation">:</span> <span class="token number">32</span> <span class="token comment"># ç›¸å…³è®­ç»ƒå‚æ•°é…ç½®</span><span class="token key atrule">SOLVER</span><span class="token punctuation">:</span>  <span class="token key atrule">BASE_LR</span><span class="token punctuation">:</span> <span class="token number">0.02</span>  <span class="token key atrule">WEIGHT_DECAY</span><span class="token punctuation">:</span> <span class="token number">0.0001</span>  <span class="token key atrule">STEPS</span><span class="token punctuation">:</span> (60000<span class="token punctuation">,</span> 80000)  <span class="token key atrule">MAX_ITER</span><span class="token punctuation">:</span> <span class="token number">90000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ•´ä½“çš„GeneralizedRCNN ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆç»˜ç”»æ°´å¹³æœ‰é™orzï¼‰ï¼Œå¯ä»¥ä¾ç…§ä¸‹å›¾çš„æ¨¡å—å»çœ‹ç›¸åº”çš„é…ç½®ï¼Œéœ€è¦é…ç½®çš„æ¨¡å—ä¸»è¦æ˜¯ï¼š<strong>Backboneã€RPNã€ROI Heads(åŒ…æ‹¬ROI Box head å’Œ ROI Mask head)</strong> ã€‚</p></blockquote><p><img src="GeneralizedRCNN%E7%BB%93%E6%9E%84%E5%9B%BE.jpg" alt="å›¾1 GeneralizedRCNNç»“æ„å›¾"></p><h3 id="äºŒã€é…ç½®æ–‡ä»¶çš„ä½¿ç”¨"><a href="#äºŒã€é…ç½®æ–‡ä»¶çš„ä½¿ç”¨" class="headerlink" title="äºŒã€é…ç½®æ–‡ä»¶çš„ä½¿ç”¨"></a>äºŒã€é…ç½®æ–‡ä»¶çš„ä½¿ç”¨</h3><blockquote><p>â€‹        é…ç½®æ–‡ä»¶ä¸»è¦æ˜¯åœ¨your_project/tools/train_net.pyä¸­è¿›è¡Œè°ƒç”¨,é¦–å…ˆçœ‹åˆ°train_net.pyä¸­çš„mainå‡½æ•°:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"PyTorch Object Detection Training"</span><span class="token punctuation">)</span>        <span class="token comment"># é…ç½®æ–‡ä»¶(å¸¦æœ‰.yamlåç¼€çš„é…ç½®æ–‡ä»¶ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°è¾“å…¥)</span>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span>        <span class="token string">"--config-file"</span><span class="token punctuation">,</span>        default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>        metavar<span class="token operator">=</span><span class="token string">"FILE"</span><span class="token punctuation">,</span>        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"path to config file"</span><span class="token punctuation">,</span>        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># å°†é…ç½®æ–‡ä»¶è¿›è¡Œè¯»å–</span>    cfg<span class="token punctuation">.</span>merge_from_file<span class="token punctuation">(</span>args<span class="token punctuation">.</span>config_file<span class="token punctuation">)</span>    cfg<span class="token punctuation">.</span>merge_from_list<span class="token punctuation">(</span>args<span class="token punctuation">.</span>opts<span class="token punctuation">)</span>    cfg<span class="token punctuation">.</span>freeze<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token comment"># å°†é…ç½®å¯¹è±¡ cfg ä½œä¸ºå‚æ•°ä¼ å…¥train()å‡½æ•°</span>    model <span class="token operator">=</span> train<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> args<span class="token punctuation">.</span>local_rank<span class="token punctuation">,</span> args<span class="token punctuation">.</span>distributed<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æ¥ç€æˆ‘ä»¬åœ¨train_net.pyä¸­æ‰¾åˆ°train()å‡½æ•°:</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> local_rank<span class="token punctuation">,</span> distributed<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># æ ¹æ®é…ç½®æ–‡ä»¶æ¥åˆ›å»ºæ¨¡å‹ (å‘ç°cfgè¢«ä¼ åˆ°äº†build_detection_model()å‡½æ•°ä¸­)</span>    model <span class="token operator">=</span> build_detection_model<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>DEVICE<span class="token punctuation">)</span>    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>â€‹        cfgå¯¹è±¡ä¼ å…¥åˆ°äº†build_detection_model()å‡½æ•°ä¸­ï¼Œè¿™åº”è¯¥æ˜¯ä¸€ä¸ªåˆ©ç”¨é…ç½®æ¥æ„å»ºæ¨¡å‹çš„å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°é‡Œé¢éƒ½å†™äº†äº›å•¥ï¼š</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>generalized_rcnn <span class="token keyword">import</span> GeneralizedRCNN <span class="token comment"># ä¸€ä¸ªå­—å…¸</span>_DETECTION_META_ARCHITECTURES <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"GeneralizedRCNN"</span><span class="token punctuation">:</span> GeneralizedRCNN<span class="token punctuation">}</span>  <span class="token keyword">def</span> <span class="token function">build_detection_model</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># é»˜è®¤çš„cfg.MODEL.META_ARCHITECTUREéƒ½æ˜¯GeneralizedRCNN</span>    meta_arch <span class="token operator">=</span> _DETECTION_META_ARCHITECTURES<span class="token punctuation">[</span>cfg<span class="token punctuation">.</span>MODEL<span class="token punctuation">.</span>META_ARCHITECTURE<span class="token punctuation">]</span>    <span class="token comment"># ç›¸å½“äº return GeneralizedRCNN(cfg)</span>    <span class="token keyword">return</span> meta_arch<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å…¶å®å¯ä»¥çœ‹å‡ºbuild_detection_model()å‡½æ•°å°±æ˜¯å°†cfgå¯¹è±¡åˆä½œä¸ºå‚æ•°ï¼Œä¼ åˆ°äº†GeneralizedRCNNç±»çš„initå‡½æ•°ä¸­ï¼Œè¿”å›ä¸€ä¸ªGeneralizedRCNNç±»å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æˆ‘ä»¬æ‰€å®šä¹‰çš„æ¨¡å‹ã€‚</p><p>é‚£ä¹ˆGeneraliziedRCNNç±»ä¸­ç©¶ç«Ÿæ‰§è¡Œäº†å“ªäº›è¿‡ç¨‹å‘¢ï¼Ÿå®ƒå¦‚ä½•æ„å»ºæˆ‘ä»¬çš„Mask-RCNNæ¨¡å‹çš„ï¼Ÿ</p><p>è¯·é˜…è¯»ï¼š<a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benckmark-master-er-generalizedrcnn-lei/">maskrcnn-benchmark-masterï¼ˆäºŒï¼‰ï¼šGeneraliziedRCNNç±»</a></p><p>ç å­—ä¸æ˜“ï¼Œæœªç»è®¸å¯ï¼Œè¯·å‹¿éšæ„è½¬è½½ï¼</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maskrcnn-benckmark-master ï¼ˆé›¶ï¼‰ï¼šä»£ç è§£è¯»</title>
      <link href="/2021/07/27/maskrcnn-benckmark-master-ling-dai-ma-jie-du/"/>
      <url>/2021/07/27/maskrcnn-benckmark-master-ling-dai-ma-jie-du/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p>ä¹‹å‰ä¸€ç›´éƒ½æœ‰ä½¿ç”¨Mask-RCNNæ¨¡å‹ï¼Œä»ä¸€å¼€å§‹ä½¿ç”¨çš„MMDetection2æ¡†æ¶ä¸­çš„Mask-RCNNï¼Œèƒ½å¤Ÿæ¯”è¾ƒæ­£å¸¸çš„è¿è¡Œï¼Œä½†æ˜¯æƒ³è¦ä¿®æ”¹æˆæˆ‘éœ€è¦çš„å½¢å¼æ—¶ï¼Œå‘ç°MMDetection2ä¸­æœ‰ä¸€äº›åœ°æ–¹éƒ½å·²ç»æ¨¡å—åŒ–å¥½äº†ï¼Œä¸æ–¹ä¾¿ä¿®æ”¹ï¼Œäºæ˜¯ä¾¿è½¬æˆ˜åˆ°ç°åœ¨çš„maskrcnn-benckmark-masterè¿™ä¸ªç‰ˆæœ¬ã€‚</p><p>å‰æ®µæ—¶é—´æ˜¯æœ‰æŠŠmaskrcnn-benckmark-masteréƒ½é˜…è¯»ä¸€éï¼Œå¹¶æŒ‰ç…§äº†è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹äº†ç½‘ç»œç»“æ„ï¼Œä½†æ˜¯ç°åœ¨åˆè¦ä¿®æ”¹å…¶ä»–éƒ¨åˆ†ï¼Œå‘ç°å…³äºä»£ç ç»†èŠ‚ï¼Œæˆ‘ä»¥åŠè®°ä¸å¾—å¤ªæ¸…æ¥šäº†orzã€‚æƒ³åˆ°å¥½ä¹…éƒ½æ²¡æœ‰æ›´æ–°åšå®¢äº†ï¼Œäºæ˜¯ä¾¿å†³å®šè®°å½•ä¸€ä¸‹ç¬¬äºŒæ¬¡å­¦ä¹ è¿™ä¸ªä»£ç çš„è¿‡ç¨‹ï¼Œå¸Œæœ›å¯¹åŒæ ·æƒ³å­¦ä¹ ç›¸å…³ä»£ç çš„æœ‹å‹æœ‰æ‰€å¸®åŠ©ï¼Œå¦‚æœæœ‰ç†è§£æœ‰è¯¯çš„åœ°æ–¹ï¼Œè¿˜è¯·è¯„è®ºåŒºæ‹ç –~</p></blockquote><h3 id="ä¸€ã€ä»‹ç»"><a href="#ä¸€ã€ä»‹ç»" class="headerlink" title="ä¸€ã€ä»‹ç»"></a>ä¸€ã€ä»‹ç»</h3><blockquote><p>å› ä¸ºæœ¬ç³»åˆ—çš„æ–‡ç« æ˜¯ä»‹ç»maskrcnn-benchmark-masterçš„ç½‘ç»œæ„å»ºçš„ä¸€äº›ä»£ç ï¼Œæ–¹ä¾¿æ ¹æ®è¿™ä¸ªé¡¹ç›®å°†å…¶ä¿®æ”¹æˆè‡ªå·±æ‰€éœ€è¦çš„å½¢å¼ï¼Œæ‰€ä»¥åœ¨é˜…è¯»æœ¬ç³»åˆ—æ–‡ç« æ—¶ï¼Œéœ€è¦æå‰å¯¹Faster-RCNNã€Mask-RCNNæ¨¡å‹æœ¬èº«çš„ä¸€äº›ç»†èŠ‚æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œå¹¶é»˜è®¤è¯»è€…å·²ç»èƒ½è‡ªè¡Œå°†maskrnn-benchmark-masterç›¸å…³ç¯å¢ƒé…ç½®å¥½ã€‚</p></blockquote><p>æ¨èFaster-RCNNå­¦ä¹ ï¼š<a href="https://zhuanlan.zhihu.com/p/31426458">https://zhuanlan.zhihu.com/p/31426458</a></p><p>æ¨èMask-RCNNå­¦ä¹ ï¼š<a href="https://zhuanlan.zhihu.com/p/37998710">https://zhuanlan.zhihu.com/p/37998710</a></p><blockquote><p>å¦‚ä¸‹æ˜¯æˆ‘å·²ç»å†™å¥½çš„æ–‡ç« ï¼ˆæ›´æ–°äº†å†è¡¥å……ï¼‰ï¼š</p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benckmark-master-yi-pei-zhi-wen-jian/">maskrcnn-benckmark-masterï¼ˆä¸€ï¼‰ï¼šé…ç½®æ–‡ä»¶</a></p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benckmark-master-er-generalizedrcnn-lei/">maskrcnn-benckmark-masterï¼ˆäºŒï¼‰ï¼šGeneralizedRCNNç±»</a></p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benchmark-master-san-build-backbone-han-shu/">maskrcnn-benckmark-masterï¼ˆä¸‰ï¼‰ï¼šbuild_backbone()å‡½æ•°</a></p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benchmark-master-si-build-rpn-han-shu/">maskrcnn-benchmark-masterï¼ˆå››ï¼‰ï¼šbuild_rpn()å‡½æ•°</a></p><p><a href="https://kingpopen.github.io/2021/07/27/maskrcnn-benchmark-master-wu-rpn-de-inference-wen-jian/">maskrcnn-benchmark-masterï¼ˆäº”ï¼‰ï¼šRPNçš„inferenceæ–‡ä»¶</a></p><p><a href="https://kingpopen.github.io/2021/08/01/maskrcnn-benchmark-master-liu-rpn-de-loss-wen-jian/">maskrcnn-benchmark-masterï¼ˆå…­ï¼‰ï¼šRPNçš„lossæ–‡ä»¶</a></p><p><a href="https://kingpopen.github.io/2021/08/02/maskrcnn-benchmark-master-qi-build-roi-heads-han-shu/">maskrcnn-benchmark-masterï¼ˆä¸ƒï¼‰ï¼šbuild_roi_heads()å‡½æ•°</a></p><p><a href="https://kingpopen.github.io/2021/08/02/maskrcnn-benchmark-master-ba-build-roi-box-head-han-shu/">maskrcnn-benchmark-masterï¼ˆå…«ï¼‰ï¼šbuild_roi_box_head()å‡½æ•°</a></p><p><a href="https://kingpopen.github.io/2021/08/03/maskrcnn-benchmark-master-jiu-box-head-de-inference-wen-jian/">maskrcnn-benchmark-masterï¼ˆä¹ï¼‰ï¼šbox_headçš„inferenceæ–‡ä»¶</a></p><p><a href="https://kingpopen.github.io/2021/08/03/maskrcnn-benchmark-master-shi-box-head-de-loss-wen-jian/">maskrcnn-benchmark-masterï¼ˆåï¼‰ï¼šbox_headçš„lossæ–‡ä»¶</a></p></blockquote><p>å¾…ç»­~</p>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> MaskRCNN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TypeError: Object of type â€˜builtin_function_or_methodâ€˜ is not JSON serializable</title>
      <link href="/2021/02/18/typeerror-object-of-type-builtin-function-or-method-is-not-json-serializable/"/>
      <url>/2021/02/18/typeerror-object-of-type-builtin-function-or-method-is-not-json-serializable/</url>
      
        <content type="html"><![CDATA[<h3 id="ä¸€ã€é—®é¢˜æè¿°"><a href="#ä¸€ã€é—®é¢˜æè¿°" class="headerlink" title="ä¸€ã€é—®é¢˜æè¿°"></a>ä¸€ã€é—®é¢˜æè¿°</h3><blockquote><p>ä½¿ç”¨python3åœ¨å°†å­—å…¸ä¿å­˜ä¸ºjsonçš„æ—¶å€™æŠ¥é”™ï¼šTypeError: Object of type â€˜builtin_function_or_methodâ€™ is not JSON <a href="https://so.csdn.net/so/search?q=serializable&amp;spm=1001.2101.3001.7020">serializable</a>.</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python">json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>save_dir<span class="token punctuation">,</span> save_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="1.png" alt="å›¾1 bugå›¾"></p><h3 id="äºŒã€é—®é¢˜è§£å†³"><a href="#äºŒã€é—®é¢˜è§£å†³" class="headerlink" title="äºŒã€é—®é¢˜è§£å†³"></a>äºŒã€é—®é¢˜è§£å†³</h3><blockquote><p>å› ä¸ºåœ¨dataå­—å…¸ç±»å‹æ•°æ®ä¸­ï¼Œä½¿ç”¨äº†ä¸€ä¸ªå°†numpyç±»å‹æ•°æ®è½¬ä¸ºlistç±»å‹æ•°æ®çš„tolist()æ–¹æ³•ï¼Œè€Œæˆ‘çš„tolist()æ–¹æ³•æ²¡æœ‰åŠ æ‹¬å·orzï¼Œæˆ‘åŠ ä¸Šæ‹¬å·åï¼Œé—®é¢˜å°±è§£å†³å•¦ã€‚</p></blockquote><p><img src="2.png" alt="å›¾2 bugä»£ç å›¾"></p><blockquote><p>ç»™tolistæ–¹æ³•åŠ ä¸Šæ‹¬å·:</p></blockquote><p><img src="3.png" alt="å›¾3 é—®é¢˜è§£å†³å›¾"></p><blockquote><p>åœ¨ç™¾åº¦ä¸Šä¸€ç›´æ‰¾ä¸åˆ°ç›¸åº”çš„è§£å†³æ–¹æ³•ï¼Œæœ€ååœ¨stackoverflowä¸Šçœ‹åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ï¼Œå¹¶ç»™å‡ºäº†è§£å†³æ–¹æ³•ï¼Œæˆ‘åœ¨æ­¤åšä¸€ä¸ªè®°å½•ï¼Œå¸Œæœ›å¯¹é‡åˆ°åŒæ ·é—®é¢˜çš„æœ‹å‹æœ‰äº›å¸®åŠ©ï¼</p></blockquote><p>å‚è€ƒé“¾æ¥ï¼š<a href="https://stackoverflow.com/questions/59243262/typeerror-object-of-type-builtin-function-or-method-is-not-json-serializable">https://stackoverflow.com/questions/59243262/typeerror-object-of-type-builtin-function-or-method-is-not-json-serializable</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> bug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®ºæ–‡é˜…è¯»ï¼šAutomatic Car Damage Assessment System</title>
      <link href="/2021/02/13/lun-wen-yue-du-automatic-car-damage-assessment-system/"/>
      <url>/2021/02/13/lun-wen-yue-du-automatic-car-damage-assessment-system/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ã€ŠAutomatic Car Damage Assessment System: Reading and Understanding Videos as Professional Insurance Inspectorsã€‹è¿™ç¯‡è®ºæ–‡æ˜¯èš‚èšé‡‘æœå›¢é˜Ÿå‘è¡¨çš„ï¼Œè¢«AAAI 2020å½•ç”¨ï¼ŒåŒæ—¶å®šæŸå®è¿™ä¸ªåº”ç”¨ä¹Ÿæ˜¯èš‚èšé‡‘æœå›¢é˜Ÿå¼€å‘çš„ã€‚è¿™ç¯‡è®ºæ–‡æ€»å…±åªæœ‰ä¸¤é¡µï¼Œæ²¡æœ‰ä»‹ç»å…·ä½“çš„ç®—æ³•ç»†èŠ‚ã€‚æ‰€ä»¥æˆ‘å°±å¯¹å…¶ä¸­é‡è¦çš„å†…å®¹è¿›è¡Œç®€å•çš„ç¿»è¯‘ä»¥åŠæˆ‘è‡ªå·±çš„ç†è§£ã€‚<br>è®ºæ–‡ä¸­æåˆ°çš„å‡ ä¸ªå•†ä¸šçº§çš„æ±½è½¦å®šæŸé¡¹ç›®ç½‘å€ï¼š</p><p>tractable.ai/products/car-accidents</p><p>tonkabi.com/artifificial-intelligence</p><p><a href="http://www.altoros.com/car-damage-recognition">www.altoros.com/car-damage-recognition</a></p></blockquote><h3 id="ä¸€ã€è‡ªåŠ¨æŸä¼¤è¯„ä¼°æ‰€é¢ä¸´çš„é—®é¢˜"><a href="#ä¸€ã€è‡ªåŠ¨æŸä¼¤è¯„ä¼°æ‰€é¢ä¸´çš„é—®é¢˜" class="headerlink" title="ä¸€ã€è‡ªåŠ¨æŸä¼¤è¯„ä¼°æ‰€é¢ä¸´çš„é—®é¢˜"></a>ä¸€ã€è‡ªåŠ¨æŸä¼¤è¯„ä¼°æ‰€é¢ä¸´çš„é—®é¢˜</h3><blockquote><ol><li>é«˜è´¨é‡çš„è§†é¢‘å¾ˆéš¾è·å¾—ï¼Œå› ä¸ºä¸å¯é¢„æµ‹çš„ç”¨æˆ·è¡Œä¸ºå¯¼è‡´ç¦»ç„¦ã€ä»»æ„æ‹æ‘„è§’åº¦å’Œæç«¯çš„æ±½è½¦ç»„ä»¶å°ºåº¦ç­‰é—®é¢˜ã€‚ æˆ‘ä»¬çš„ç³»ç»Ÿé€šè¿‡å‰ç«¯äº¤äº’æ¨¡å—è·å–è§†é¢‘ï¼Œå¼•å¯¼ç”¨æˆ·æ‹æ‘„é«˜è´¨é‡å’Œé€‚å½“è·ç¦»çš„è§†é¢‘ã€‚</li><li>æ±½è½¦å¤–è§‚ä¸Šçš„åå°„ã€æ³¥æµ†å’Œç›–å­å¯èƒ½è¢«é”™è¯¯åœ°è¯†åˆ«ä¸ºæŸä¼¤ã€‚ é€šè¿‡ä»è§†é¢‘ä¸­æå–å¤šå¸§çš„æ¨¡å‹èåˆï¼Œé™ä½äº†å™ªå£°ï¼Œå¹¶å¾—åˆ°æ›´å¥½çš„ç»“æœã€‚</li><li>æ±½è½¦éƒ¨ä»¶å’ŒæŸåéœ€è¦åœ¨åƒç´ çº§åˆ†å‰²ï¼Œä»¥å‡†ç¡®å®šä½æŸåã€‚ åˆ†å‰²çš„æ ‡ç­¾å·¥ä½œè¦æ¯”ç›®æ ‡æ£€æµ‹æ ‡ç­¾å·¥ä½œè€—æ—¶å¾—æ›´å¤šï¼Œ æå‡ºäº†ä¸€ç§åˆ©ç”¨å¤§è§„æ¨¡çš„bounding boxæ ‡ç­¾è¿›è¡Œè®­ç»ƒï¼ˆç›®æ ‡æ£€æµ‹ä»»åŠ¡çš„æ ‡ç­¾ï¼‰æ¥æé«˜æŸä¼¤å®šä½ç²¾åº¦çš„å¼±ç›‘ç£åˆ†å‰²æ¨¡å‹ã€‚</li></ol></blockquote><p><img src="1.png" alt="å›¾1 ç½‘ç»œæ¶æ„å›¾"></p><h3 id="äºŒã€ä½œè€…çš„æ–¹æ³•"><a href="#äºŒã€ä½œè€…çš„æ–¹æ³•" class="headerlink" title="äºŒã€ä½œè€…çš„æ–¹æ³•"></a>äºŒã€ä½œè€…çš„æ–¹æ³•</h3><ul><li>æ•°æ®è·å–</li></ul><blockquote><p>å‰åç«¯äº¤äº’å­æ¨¡å—(Front End Interaction)æ—¨åœ¨è·å¾—é«˜è´¨é‡çš„è§†é¢‘ã€‚ å®ƒä½¿ç”¨ç§»åŠ¨æ¨ç†å¼•æ“è°ƒç”¨éƒ¨ç½²åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ·±åº¦å­¦ä¹ æ¨¡å‹æ¥æŒ‡å¯¼æ‹æ‘„è¿‡ç¨‹ã€‚ é¦–å…ˆï¼Œè§†é¢‘ä¸­åº”è¯¥å‡ºç°è½¦ç‰Œå’ŒVINç ï¼ˆå®ƒåŒ…å«äº†æ±½è½¦çš„åˆ¶é€ å•†ã€å‘åŠ¨æœºã€åº•ç›˜åºåˆ—å·ç­‰æ€§èƒ½ä¿¡æ¯ï¼‰ï¼Œå¹¶è‡ªåŠ¨è¯†åˆ«å†…å®¹ï¼Œä»¥éªŒè¯è½¦ä¸»çš„èº«ä»½ä»¥åŠä»¥é˜²æ¬ºè¯ˆã€‚ å…¶æ¬¡ï¼Œå¼•å¯¼ç”¨æˆ·åœ¨æ›´è¿œçš„è·ç¦»æ‹æ‘„è§†é¢‘ï¼Œç„¶åæ›´è¿‘åœ°æ•æ‰æŸåç»†èŠ‚ã€‚ è·ç¦»ç”±ç§»åŠ¨åˆ†ç±»æ¨¡å‹ç¡®å®šã€‚ æ‹æ‘„æœŸé—´ï¼Œè§†é¢‘ç­‰ä¿¡æ¯å¼‚æ­¥ä¸Šä¼ åˆ°äº‘ç«¯è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</p><p>PSï¼šè¿™ç¯‡è®ºæ–‡è·å–çš„æ˜¯è§†é¢‘æ•°æ®ï¼Œè€Œä¸æ˜¯æ™®é€šçš„å›¾ç‰‡æ•°æ®ã€‚</p></blockquote><ul><li>æŸä¼¤è¯†åˆ«ï¼ˆä¸æ¶‰åŠé›¶ä»¶ï¼‰</li></ul><blockquote><p>æ±½è½¦æŸä¼¤è¯†åˆ«å¯ä»¥è¢«å®šä¹‰ä¸ºå¤šç±»åˆ«çš„æ£€æµ‹æˆ–åˆ†å‰²ä»»åŠ¡ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦å¤§é‡çš„è¢«æ ‡æ³¨çš„æ ·æœ¬ç”¨æ¥è®­ç»ƒæ¨¡å‹ï¼Œä½†æ˜¯å¯¹äºåˆ†å‰²ä»»åŠ¡æ¥è¯´è¿™æ˜¯ä¸åˆ‡å®é™…çš„ï¼Œå› ä¸ºåˆ†å‰²æ•°æ®é›†æ ‡æ³¨è€—æ—¶åŸºæœ¬æ˜¯æ£€æµ‹ä»»åŠ¡çš„5å€ã€‚ æ­¤å¤–ï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¾ˆéš¾å®šä¹‰æŸä¼¤çº¹ç†çš„è¾¹ç•Œã€‚ æˆ‘ä»¬é‡‡ç”¨two-stageçš„æ£€æµ‹æ¨¡å‹ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå¼±ç›‘ç£çš„è¯­ä¹‰åˆ†å‰²åˆ†æ”¯ï¼Œä»Bounding boxæ ‡ç­¾ä¸­è·å¾—æ›´ç²¾ç¡®çš„åƒç´ çº§åˆ†ç±»ç»“æœ, æ£€æµ‹å’Œåˆ†å‰²åˆ†æ”¯çš„é¢„æµ‹è¿›ä¸€æ­¥èåˆã€‚ æ­¤å¤–ï¼Œè¿˜åˆ†æäº†å¤šå¸§è€Œä¸æ˜¯å•ä¸€å›¾åƒï¼Œä»¥åˆ©ç”¨è§†é¢‘çš„æ—¶é—´ä¸€è‡´æ€§å’Œå†…å®¹äº’è¡¥æ€§æ¥è¿‡æ»¤ä¸€äº›çœ‹èµ·æ¥åƒæŸä¼¤å›¾åƒä»è€Œæ¥é™ä½å™ªå£°ã€‚</p><p>PSï¼šè¿™ä¸ªåœ°æ–¹ä½œè€…æåˆ°äº†æŸä¼¤è¯†åˆ«å¯ä»¥è¢«å®šä¹‰ä¸ºdetectionæˆ–è€…segmentationä»»åŠ¡ï¼Œä½†æ˜¯ç”±äºsegmentationä»»åŠ¡ç›¸æ¯”detectionä»»åŠ¡çš„æ ‡ç­¾å·¥ä½œæ›´åŠ è€—æ—¶ï¼Œæ‰€ä»¥ä½œè€…é€‰æ‹©åœ¨ä¸€ä¸ªtwo-stageçš„detection modelï¼ˆä¾‹å¦‚Faster-RCNNï¼‰åŸºç¡€ä¸Šæ·»åŠ ä¸€ä¸ªå¼±ç›‘ç£çš„è¯­ä¹‰åˆ†å‰²åˆ†æ”¯ï¼ˆä½œè€…çš„æ„æ€åº”è¯¥æ˜¯å®ƒä»¬çš„æ ‡ç­¾æ˜¯ä½¿ç”¨çš„bounding boxæ ‡ç­¾ï¼Œè€Œä¸æ˜¯maskæ ‡ç­¾ï¼Œä¸ºäº†æ”¹å–„è¿™ä¸ªbounding boxæ ‡ç­¾ä¸å¤Ÿç²¾å‡†çš„é—®é¢˜ï¼Œä½œè€…è¿˜æ˜¯æ·»åŠ äº†ä¸€ä¸ªå¼±ç›‘ç£çš„è¯­ä¹‰åˆ†å‰²åˆ†æ”¯ã€‚ä¸ªäººæ„Ÿè§‰ä½œè€…çš„æ¨¡å‹å’ŒMask-RCNNæ¨¡å‹æ˜¯åŸºæœ¬ç±»ä¼¼çš„ï¼Œä½†æ˜¯æˆ‘ä¸å¤ªäº†è§£å¼±ç›‘ç£çš„è¯­ä¹‰åˆ†å‰²ï¼Œåç»­å†è°ƒç ”ä¸€äº›ï¼‰ï¼Œä»è€Œæ¥æå‡æ•ˆæœã€‚</p></blockquote><ul><li>æŸä¼¤é›¶ä»¶çš„å®šä½</li></ul><blockquote><p>è·ç¦»è¾ƒè¿œçš„å¸§æ›´é€‚åˆäºæ±½è½¦éƒ¨ä»¶è¯†åˆ«ï¼Œè€Œè·ç¦»è¾ƒè¿‘çš„å¸§æ›´é€‚åˆäºæŸä¼¤ç»†èŠ‚è¯†åˆ«ã€‚å› æ­¤ï¼Œè¿™ä¸¤ç§å¸§éƒ½æ˜¯é€šè¿‡å¸§é€‰æ‹©ç®—æ³•è‡ªåŠ¨ä»è§†é¢‘ä¸­æå–çš„ï¼Œè€Œä¸æ˜¯ç”±ç”¨æˆ·æ‹æ‘„å¤šå¼ ç…§ç‰‡ã€‚æˆ‘ä»¬æ”¹è¿›äº†Mask-RCNNæ¥æ£€æµ‹æŸåéƒ¨ä»¶ï¼ŒåŒæ—¶å¯¹éƒ¨ä»¶è¿›è¡Œå‡†ç¡®çš„åˆ†å‰²ã€‚å¤šå¸§çš„ç»“æœè¢«èåˆï¼Œä»¥å‡†ç¡®åœ°å®šä½æŸåçš„ç»„ä»¶ã€‚</p><p>PSï¼šè¿™ä¸ªåœ°æ–¹ä½œè€…æ²¡æœ‰è¯´å¦‚ä½•å°†è§†é¢‘é‡Œçš„å¤šä¸ªå¸§è¿›è¡Œèåˆçš„orz</p></blockquote><ul><li>å†³ç­–å’Œç»´ä¿®è®¡åˆ’çš„ç¡®å®š</li></ul><blockquote><p>ç»™å®šæŸä¼¤å’Œé›¶ä»¶çš„è¯†åˆ«ç»“æœä½œä¸ºè¾“å…¥ï¼Œå†³ç­–æ¨¡å—å­¦ä¹ å’Œé¢„æµ‹æœ€ç»ˆæŸåçš„é›¶ä»¶å’Œé›¶ä»¶æŸåä¸¥é‡ç¨‹åº¦ã€‚è¯†åˆ«å’Œå†³ç­–æ¨¡å—ä¸è¢«è®¾è®¡ä¸ºç«¯åˆ°ç«¯ï¼Œå› ä¸ºåœ¨æ¯ä¸ªå•ä¸€é˜¶æ®µï¼Œå¯ä»¥ç»„åˆå¤šä¸ªæ¨¡å‹æ¥æé«˜ç²¾åº¦ï¼Œç„¶åç³»ç»Ÿå¯ä»¥å°†ç®—æ³•ç»“æœè½¬åŒ–ä¸ºåŸºäºå®šä»·ç®—æ³•çš„ä¿®å¤æ–¹æ¡ˆã€‚</p></blockquote><h3 id="ä¸‰ã€ç³»ç»Ÿçš„ä½¿ç”¨æµç¨‹"><a href="#ä¸‰ã€ç³»ç»Ÿçš„ä½¿ç”¨æµç¨‹" class="headerlink" title="ä¸‰ã€ç³»ç»Ÿçš„ä½¿ç”¨æµç¨‹"></a>ä¸‰ã€ç³»ç»Ÿçš„ä½¿ç”¨æµç¨‹</h3><blockquote><p>å½“å‘ç”Ÿè½¦ç¥¸æ—¶ï¼Œè½¦ä¸»å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ç³»ç»Ÿè¯„ä¼°æŸå®³èµ”å¿ã€‚å…·ä½“æ¥è¯´ï¼Œç”¨æˆ·éµå¾ªæ‹æ‘„æŒ‡å¯¼ï¼Œåº”è¯¥æ‰«æè½¦ç‰Œï¼Œç„¶åVINä»£ç ï¼Œä»¥éªŒè¯æ±½è½¦èº«ä»½çš„ä¸€è‡´æ€§åŠå…¶æŸåã€‚ ç„¶åï¼Œç”¨æˆ·å°†åœ¨æ›´è¿œå’Œæ›´è¿‘çš„è·ç¦»æ‹æ‘„æŸåéƒ¨ä»¶çš„è§†é¢‘ã€‚åœ¨æ•è·è¿‡ç¨‹ä¸­ï¼Œè§†é¢‘è¢«ä¸Šä¼ åˆ°äº‘ä¸­ä»¥è¯†åˆ«æŸåã€‚æœ€åå°†æŸåçš„ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚æŸåçš„ç»“æœä¹Ÿé™„æœ‰ä¼°è®¡ä»·æ ¼ï¼Œç”¨æˆ·å¯ä»¥å†³å®šäº²è‡ªç´¢èµ”æˆ–ä¿®ç†ã€‚</p></blockquote><h3 id="å››ã€ä¸ªäººæ€»ç»“"><a href="#å››ã€ä¸ªäººæ€»ç»“" class="headerlink" title="å››ã€ä¸ªäººæ€»ç»“"></a>å››ã€ä¸ªäººæ€»ç»“</h3><blockquote><p>è¿™ç¯‡è®ºæ–‡æ€»å…±åªæœ‰ä¸¤é¡µï¼Œå…·ä½“æ¶‰åŠçš„ç®—æ³•ç»†èŠ‚ä¸å¤šï¼Œå¹¶ä¸”èš‚èšé‡‘æœå›¢é˜Ÿä½¿ç”¨çš„æ˜¯è§†é¢‘æ•°æ®è€Œä¸æ˜¯æ™®é€šçš„å›¾ç‰‡æ•°æ®ã€‚æ¯”è¾ƒå…³é”®çš„é—®é¢˜æ˜¯å¦‚ä½•å°†è§†é¢‘ä¸­è¿‘æ™¯æ•°æ®ä¿¡æ¯å’Œè¿œæ™¯çš„æ•°æ®ä¿¡æ¯è¿›è¡Œèåˆï¼Œè®ºæ–‡ä¸­ä¹Ÿæ²¡æœ‰å…·ä½“è¯´æ˜ï¼Œæœ¬ç¯‡åšå®¢å°±æ˜¯ç®€å•çš„è®°å½•ä¸€ä¸‹ï¼Œå¸Œæœ›å¯¹æœ‰éœ€è¦çš„æœ‹å‹æœ‰æ‰€å¸®åŠ©ã€‚</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> è®ºæ–‡é˜…è¯» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ‰‹æŠŠæ‰‹æ•™ä½ ï¼šWindowsç³»ç»Ÿä¸Šå®‰è£…GPUæ·±åº¦å­¦ä¹ ç¯å¢ƒ</title>
      <link href="/2020/07/07/shou-ba-shou-jiao-ni-windows-xi-tong-shang-an-zhuang-gpu-shen-du-xue-xi-huan-jing/"/>
      <url>/2020/07/07/shou-ba-shou-jiao-ni-windows-xi-tong-shang-an-zhuang-gpu-shen-du-xue-xi-huan-jing/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>åœ¨å…¥æ‰‹å­¦ä¹ æ·±åº¦å­¦ä¹ çš„è¿‡ç¨‹å½“ä¸­ï¼Œæœ‰å¥½å‡ ä¸ªæœ‹å‹éƒ½å’¨è¯¢è¿‡æˆ‘å¦‚ä½•å®‰è£…æ·±åº¦å­¦ä¹ ç¯å¢ƒï¼Œä¹‹å‰å†™è¿‡ä¸€ç¯‡åœ¨Ubuntuç¯å¢ƒä¸‹å®‰è£…æ·±åº¦å­¦ä¹ ç¯å¢ƒï¼Œä½†æ˜¯æœ‰éƒ¨åˆ†æœ‹å‹åœ¨Windowsç”µè„‘ä¸Šå®‰è£…æ·±åº¦å­¦ä¹ ç¯å¢ƒé‡åˆ°è¿‡è®¸å¤šçš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘å°±å†å†™ä¸€ç¯‡Windowsç³»ç»Ÿä¸Šå®‰è£…GPUæ·±åº¦å­¦ä¹ ç¯å¢ƒçš„æ•™ç¨‹ï¼Œå¸Œæœ›å¯¹åˆšåˆšå…¥æ‰‹æ·±åº¦å­¦ä¹ çš„æœ‹å‹æœ‰æ‰€å¸®åŠ©:)</p><p>PS:ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨å®‰è£…CUDAå’ŒcuDNNï¼ˆå®‰è£…è¿™ä¸¤æ ·ä¸œè¥¿å±å®è¦åŠé€€ä¸å°‘æœ‹å‹ï¼‰ï¼Œç½‘ä¸Šè®¸å¤šçš„åšå®¢éƒ½æ˜¯è¯´è¦å®‰è£…CUDAå’ŒcuDNNï¼Œä½†æ˜¯é€‰æ‹©Tensorflow-GPUç‰ˆæœ¬æˆ–è€…PyTorch-GPUç‰ˆæœ¬ä¸­éƒ½ä¼šè‡ªå¸¦å·²ç»ç®€åŒ–äº†çš„CUDAå’ŒcuDNNçš„åŒ…ï¼Œæ‰€ä»¥ä¸å†éœ€è¦æˆ‘ä»¬è‡ªå·±å»æ‰‹åŠ¨å®‰è£…äº†ï¼ï¼ï¼ </p></blockquote><h3 id="ä¸€ã€Condaç¯å¢ƒæ­å»º"><a href="#ä¸€ã€Condaç¯å¢ƒæ­å»º" class="headerlink" title="ä¸€ã€Condaç¯å¢ƒæ­å»º"></a>ä¸€ã€Condaç¯å¢ƒæ­å»º</h3><blockquote><p>Anacondaå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¾ˆå¥½çš„ç®¡ç†pythonç¯å¢ƒï¼ˆå¤§å®¶åº”è¯¥éƒ½æ˜¯ç”¨pythonæ¥ç©æ·±åº¦å­¦ä¹ çš„å§å›§rzï¼‰ï¼Œä¾‹å¦‚æˆ‘ç”µè„‘ä¸­æƒ³è¦æœ‰python2.7å’Œpython3.6ä¸¤ä¸ªç‰ˆæœ¬çš„pythonç¼–è¯‘å™¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨Anacondaåˆ›å»ºä¸¤ä¸ªpythonç‰ˆæœ¬çš„è™šæ‹Ÿç¯å¢ƒï¼Œè¿™ä¸¤ä¸ªè™šæ‹Ÿç¯å¢ƒä¸­éƒ½å¯ä»¥å®‰è£…å„è‡ªçš„åŒ…ï¼Œäº’ç›¸ä¸å½±å“ã€‚</p></blockquote><h4 id="1ã€Anacondaçš„ä¸‹è½½"><a href="#1ã€Anacondaçš„ä¸‹è½½" class="headerlink" title="1ã€Anacondaçš„ä¸‹è½½"></a>1ã€Anacondaçš„ä¸‹è½½</h4><blockquote><p>äººç”Ÿè‹¦çŸ­ï¼Œæˆ‘é€‰æ‹©åœ¨åœ¨<a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/">æ¸…åå›­é•œåƒ</a>ä¸­ä¸‹è½½Anacondaï¼Œå› ä¸ºæˆ‘çš„ç”µè„‘æ˜¯Window10 64ä½ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©çš„ç‰ˆæœ¬æ˜¯Windows-x86_64åç¼€çš„ï¼Œè‡³äºç‰ˆæœ¬å·ï¼Œå¯ä»¥è‡ªå·±é€‰æ‹©ï¼Œæˆ‘é€‰çš„æ˜¯Anaconda3-5.1.0ã€‚</p><p><img src="1.png" alt="å›¾1 é•œåƒæºå›¾"></p></blockquote><h4 id="2ã€Anacondaçš„å®‰è£…"><a href="#2ã€Anacondaçš„å®‰è£…" class="headerlink" title="2ã€Anacondaçš„å®‰è£…"></a>2ã€Anacondaçš„å®‰è£…</h4><blockquote><p>ä¸‹è½½é€Ÿåº¦è¿˜æ˜¯è›®å¿«çš„ï¼Œä¸‹è½½æˆåŠŸä¹‹åå°±æ˜¯å®‰è£…è¿‡ç¨‹ï¼Œå‰é¢å‡ ä¸ªéƒ½æ˜¯ä¸€è·¯nextï¼Œåˆ°Advanced Optionséƒ¨åˆ†ï¼Œæˆ‘é€‰çš„æ˜¯<strong>Add Anaconda to my PATH environment variable</strong>ï¼ˆå°†Anacondaå®‰è£…è·¯å¾„åŠ å…¥ç¯å¢ƒå˜é‡ï¼Œçœå¾—è‡ªå·±å†å»åŠ ç¯å¢ƒå˜é‡ï¼‰ã€‚</p></blockquote><p><img src="2.png" alt="å›¾2 Anacondaå®‰è£…å›¾1"></p><blockquote><p>æ¥ä¸‹æ¥å°±æ˜¯å®‰è£…è¿‡ç¨‹å¯èƒ½è¦èŠ±ä¸€äº›æ—¶é—´ï¼Œå¦‚æœåœ¨<strong>å®‰è£…é€”ä¸­å‡ºç°äº†cmdçš„é»‘çª—å£ï¼Œåƒä¸‡ä¸è¦è‡ªå·±æ‰‹æŠ–æŠŠå®ƒç»™å…³äº†</strong>ï¼Œcmdçš„é»‘çª—å£å¯èƒ½æ˜¯åœ¨ä¸‹è½½ä¸€äº›ä¸œè¥¿ï¼Œæˆ‘å°±æ˜¯ä¹‹å‰æ‰‹æŠ–æŠŠé»‘çª—å£å…³äº†ï¼Œå°±å‡ºç°äº†ä¸€äº›å®‰è£…å¤±è´¥çš„é—®é¢˜ï¼Œè¯¦æƒ…å¯ä»¥çœ‹æˆ‘çš„å¦ä¸€ç¯‡åšå®¢ã€‚å¦‚æœè‡ªå·±å®‰è£…ç»“æŸä¹‹ååº”è¯¥åŒ…å«æœ‰ä¸‹å›¾çš„å‡ ä¸ªå†…å®¹ã€‚</p></blockquote><p><img src="3.png" alt="å›¾3 Anacondaå®‰è£…å›¾2"></p><blockquote><p>åœ¨Anaconda Promptè¾“å…¥conda listæˆåŠŸæ˜¾ç¤ºå‡ºç»“æœæ—¶ï¼Œè¯´æ˜Anacondaå®‰è£…æˆåŠŸå•¦!</p></blockquote><p><img src="4.png" alt="å›¾4 Anacondaå®‰è£…å›¾3"></p><h4 id="3ã€condaåˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒ"><a href="#3ã€condaåˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒ" class="headerlink" title="3ã€condaåˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒ"></a>3ã€condaåˆ›å»ºpythonè™šæ‹Ÿç¯å¢ƒ</h4><blockquote><p>ä¸ºäº†ä½¿è‡ªå·±çš„pythonæ·±åº¦å­¦ä¹ ç¯å¢ƒä¸å’Œå…¶ä»–pythonç›¸å†²çªï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨Condaåˆ›å»ºä¸€ä¸ªpythonçš„è™šæ‹Ÿç¯å¢ƒã€‚æˆ‘åˆ›å»ºçš„æ˜¯ä¸€ä¸ªå«åšDPlearning_3.6çš„python3.6ç‰ˆæœ¬ç¯å¢ƒã€‚åœ¨è™šæ‹Ÿç¯å¢ƒå®‰è£…æˆåŠŸä¹‹åï¼Œä½¿ç”¨activate DPlearning_3.6å‘½ä»¤åˆ‡æ¢åˆ°è¿™ä¸ªè™šæ‹Ÿç¯å¢ƒä¸­ã€‚</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python">åˆ›å»ºpython3<span class="token punctuation">.</span><span class="token number">6</span>çš„è™šæ‹Ÿç¯å¢ƒ åå­—å«åšDPlearning_3<span class="token punctuation">.</span><span class="token number">6</span>conda create <span class="token operator">-</span>n DPlearning_3<span class="token punctuation">.</span><span class="token number">6</span> python<span class="token operator">=</span><span class="token number">3.6</span> <span class="token comment">#åˆ‡æ¢åˆ°DPlearning_3.6è™šæ‹Ÿç¯å¢ƒ</span>activate DPlearning_3<span class="token punctuation">.</span><span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="5.png" alt="å›¾5 condaè™šæ‹Ÿç¯å¢ƒ"></p><blockquote><p>å¯ä»¥ä»ä¸Šå›¾ä¸­çœ‹åˆ°ä¸‹è½½åŒ…çš„ç½‘é€Ÿè¿˜æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©æ·»åŠ æ¸…åæºçš„é•œåƒã€‚</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python">conda config <span class="token operator">-</span><span class="token operator">-</span>add channels https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>anaconda<span class="token operator">/</span>pkgs<span class="token operator">/</span>free<span class="token operator">/</span>conda config <span class="token operator">-</span><span class="token operator">-</span>add channels https<span class="token punctuation">:</span><span class="token operator">//</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn<span class="token operator">/</span>anaconda<span class="token operator">/</span>pkgs<span class="token operator">/</span>main<span class="token operator">/</span>conda config <span class="token operator">-</span><span class="token operator">-</span><span class="token builtin">set</span> show_channel_urls yes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="ä¸‰ã€GPUç¯å¢ƒæ­å»º"><a href="#ä¸‰ã€GPUç¯å¢ƒæ­å»º" class="headerlink" title="ä¸‰ã€GPUç¯å¢ƒæ­å»º"></a>ä¸‰ã€GPUç¯å¢ƒæ­å»º</h3><h4 id="1ã€äº†è§£è‡ªå·±ç”µè„‘æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬"><a href="#1ã€äº†è§£è‡ªå·±ç”µè„‘æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬" class="headerlink" title="1ã€äº†è§£è‡ªå·±ç”µè„‘æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬"></a>1ã€äº†è§£è‡ªå·±ç”µè„‘æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬</h4><blockquote><p>äººæœ€é‡è¦çš„æ˜¯è¦äº†è§£è‡ªå·±ã€‚</p><p>â€‹                                                 â€”â€”æˆ‘è¯´çš„</p><p>å› ä¸ºæœ‰éƒ¨åˆ†å°ä¼™ä¼´å¯¹è‡ªå·±ç”µè„‘æ˜¾å¡é©±åŠ¨çš„ç‰ˆæœ¬ä¸äº†è§£ï¼Œæ‰€ä»¥é€‰æ‹©Tensorflowæˆ–è€…PyTorchçš„ç‰ˆæœ¬çš„æ—¶å€™ä¼šå‡ºç°å®‰è£…äº†ï¼Œä½†ä¸å…¼å®¹çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦äº†è§£è‡ªå·±ç”µè„‘æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬:)</p></blockquote><ul><li><p>1.1 é¦–å…ˆåœ¨Windowsè®¾ç½®ä¸­æœç´¢æ§åˆ¶é¢æ¿(æŒ‰Winé”®ï¼Œç„¶åç‚¹å‡»å·¦ä¸‹æ–¹çš„è®¾ç½®æŒ‰é’®å°±å¯ä»¥åˆ°Windowsè®¾ç½®é¡µé¢)ã€‚</p><p><img src="6.png" alt="å›¾6 æ§åˆ¶é¢æ¿1å›¾"></p></li><li><p>1.2  åœ¨æ§åˆ¶é¢æ¿ä¸­ç‚¹å‡»NVIDIAæ§åˆ¶é¢æ¿ã€‚</p><p><img src="7.png" alt="å›¾7 æ§åˆ¶é¢æ¿2å›¾"></p></li><li><p>1.3  NVIDIAæ§åˆ¶é¢æ¿ä¸­ç‚¹å‡»â€œå¸®åŠ©â€ä¸‹é¢çš„â€œç³»ç»Ÿä¿¡æ¯â€ã€‚</p><p><img src="8.jpg" alt="å›¾8 æ§åˆ¶é¢æ¿3å›¾"></p></li><li><p>1.4  æŸ¥çœ‹é©±åŠ¨ç¨‹åºç‰ˆæœ¬ï¼Œæˆ‘çš„æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬æ˜¯388.57ã€‚</p><p><img src="9.png" alt="å›¾9 æ§åˆ¶é¢æ¿4å›¾"></p></li><li><p>1.5  æ ¹æ®æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬ç¡®å®šè‡ªå·±èƒ½ä½¿ç”¨çš„CUDA Tookitç‰ˆæœ¬ã€‚æˆ‘çš„æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬æ˜¯388.57,ä»‹äº385.54å’Œ391.29ä¹‹é—´ï¼Œç”±ä¸‹å›¾å¯çŸ¥ï¼Œæˆ‘æ‰€èƒ½é€‰ç”¨çš„CUDA Tookitç‰ˆæœ¬åªæœ‰CUDA 9.0ã€‚</p><p><img src="10.png" alt="å›¾10 CUDAç‰ˆæœ¬ä»‹ç»"></p></li></ul><h4 id="2ã€å®‰è£…æ­£ç¡®çš„TensorFlow-GPUç‰ˆæœ¬"><a href="#2ã€å®‰è£…æ­£ç¡®çš„TensorFlow-GPUç‰ˆæœ¬" class="headerlink" title="2ã€å®‰è£…æ­£ç¡®çš„TensorFlow-GPUç‰ˆæœ¬"></a>2ã€å®‰è£…æ­£ç¡®çš„TensorFlow-GPUç‰ˆæœ¬</h4><blockquote><p>æˆ‘å·²ç»çŸ¥é“æˆ‘çš„ç”µè„‘åªèƒ½ç”¨CUDA 9.0ç‰ˆæœ¬çš„åŒ…ï¼Œç°åœ¨è¦é€‰æ‹©æ­£ç¡®çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ç‰ˆæœ¬ï¼Œç°åœ¨ä¸»æµçš„æ·±åº¦å­¦ä¹ æ¡†æ¶æ˜¯TensorFlowå’ŒPyTorchï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹åˆ°TensorFlowæ¡†æ¶(ä¸å®‰è£…Tensorflowæ¡†æ¶çš„å¯ä»¥ç›´æ¥å»çœ‹å®‰è£…PyTorchæ¡†æ¶çš„éƒ¨åˆ†)ã€‚</p><p>ç”±ä¸‹é¢çš„TensorFlowç‰ˆæœ¬å’ŒCUDAç‰ˆæœ¬å¯¹åº”å›¾å¯ä»¥çœ‹å‡ºï¼Œé€‚ç”¨äºCUDAç‰ˆæœ¬ä¸º9çš„TensorFlow-gpuç‰ˆæœ¬ä¸º1.5-1.12ä¹‹é—´ï¼Œæˆ‘é€‰æ‹©1.8è¿›è¡Œå®‰è£…ã€‚</p><p>PSï¼šåŒæ—¶å¯ä»¥çœ‹åˆ°Pythonç‰ˆæœ¬çš„å¯¹åº”å…³ç³»ï¼ŒCUDA 9æ”¯æŒçš„pythonæœ€é«˜ç‰ˆæœ¬æ˜¯python3.6ï¼Œåªæœ‰CUDA 10åŠä»¥ä¸Šæ‰æ”¯æŒpython3.7ï¼Œæ‰€ä»¥åˆ›å»ºçš„pythonè™šæ‹Ÿç¯å¢ƒæœ€å¥½ä¸ºpyhon3.6ç‰ˆæœ¬çš„ã€‚</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#(é¦–å…ˆè¦ç¡®ä¿è‡ªå·±åœ¨ä¹‹å‰åˆ›å»ºçš„DPlearning_3.6ç¯å¢ƒä¸‹)</span>activate DPlearning_3<span class="token punctuation">.</span><span class="token number">6</span> <span class="token comment">#å®‰è£…Tensorflow-gpu 1.8.0ç‰ˆæœ¬</span>conda install tensorflow<span class="token operator">-</span>gpu<span class="token operator">=</span><span class="token number">1.8</span><span class="token number">.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å¯ä»¥çœ‹åˆ°TensorFlowçš„å®‰è£…åŒ…æ˜¯åŒ…å«æœ‰cudatoolkitå’Œcudnnçš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å†å»å®‰è£…CUDAå’ŒcuDNNï¼ˆçªç„¶æ¯”å¿ƒ.jpgï¼‰,å› ä¸ºåŠ äº†æ¸…åæºé•œåƒï¼Œæ‰€ä»¥ä¸‹è½½é€Ÿåº¦è¿˜æ˜¯è›®å¿«çš„ã€‚</p><p>PSï¼šæ³¨æ„çœ‹ä¸‹å›¾çš„éƒ¨åˆ†åŒ…çš„åå­—é‡Œé¢å¸¦æœ‰py36çš„å­—æ ·ï¼Œå¦‚æœä½ çš„pythonç¯å¢ƒæ˜¯3.7ï¼Œä½¿ç”¨è¿™ç§åŒ…å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚ï¼ˆä¹‹å‰æœ‰å¸ˆå¼Ÿå°±æ˜¯ç”¨çš„pyhon3.7ç‰ˆæœ¬ï¼ŒTensorFlowç‰ˆæœ¬ä¹Ÿæ˜¯é€‰çš„æ”¯æŒpython3.7çš„ç‰ˆæœ¬ï¼Œä½†æ€»æ˜¯å®‰è£…ä¸æˆåŠŸï¼Œæ¢æˆpython3.6ç‰ˆæœ¬å°±æˆåŠŸäº†ï¼‰</p></blockquote><p><img src="11.png" alt="å›¾11 TensorFlowå®‰è£…å›¾"></p><blockquote><p>TensorFlowä¸‹è½½å®‰è£…ç»“æŸä¹‹åï¼Œä½¿ç”¨import tensorflow as tfå‘½ä»¤æ¥çœ‹æ˜¯å¦æˆåŠŸå®‰è£…ï¼ˆç°å®æ€»æ˜¯å¾ˆéª¨æ„Ÿï¼ŒæŠ¥é”™äº†orzï¼‰ï¼Œå¯ä»¥çœ‹åˆ°æŠ¥é”™çš„å†…å®¹ä¸»è¦æ˜¯å…³äºnumpyï¼Œä½†æˆ‘ç›¸ä¿¡â€œæ–¹æ³•æ€»æ¯”å›°éš¾å¤šâ€ï¼Œé€šè¿‡ç½‘ä¸ŠæŸ¥æ‰¾è§£å†³æ–¹æ³•ï¼Œäº†è§£åˆ°æ˜¯å› ä¸ºnumpyç‰ˆæœ¬å¤ªé«˜äº†ï¼Œæˆ‘é‡æ–°å®‰è£…numpy=1.16.0ç‰ˆæœ¬çš„å°±è§£å†³äº†ã€‚ï¼ˆä¸åŒçš„Tensorflowç‰ˆæœ¬å¯èƒ½å¯¹åº”çš„numpyç‰ˆæœ¬ä¸åŒï¼Œå°ä¼™ä¼´ä»¬å¯ä»¥å¤šè¯•å‡ ä¸ªnumpyç‰ˆæœ¬ï¼‰ã€‚</p></blockquote><p><img src="12.png" alt="å›¾12 TensorFlowå®‰è£…bugå›¾"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#ä»¥ä¸‹æ“ä½œéƒ½æ˜¯åœ¨DPlearning_3.6çš„è™šæ‹Ÿç¯å¢ƒä¸‹è¿›è¡Œçš„</span><span class="token comment">#å®‰è£…numpy1.16.0çš„åŒ…</span>conda install numpy<span class="token operator">=</span><span class="token number">1.16</span><span class="token number">.0</span> <span class="token comment">#æŸ¥çœ‹tensorflowæ˜¯å¦å®‰è£…æˆåŠŸ</span>python<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tfboy<span class="token keyword">print</span><span class="token punctuation">(</span>tfboy<span class="token punctuation">.</span>test<span class="token punctuation">.</span>is_gpu_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">#æ˜¾ç¤ºTrueè¯´æ˜å®‰è£…æˆåŠŸäº†</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="13.png" alt="å›¾12 TensorFlowå®‰è£…æˆåŠŸå›¾"></p><blockquote><p><strong>è‡³æ­¤ä½ å·²ç»æˆåŠŸæˆä¸ºä¸€åtfboy or tfgirlï¼Ÿï¼Ÿï¼Ÿ Congratulationsï¼ï¼ï¼</strong></p></blockquote><h4 id="3ã€å®‰è£…æ­£ç¡®çš„PyTorch-GPUç‰ˆæœ¬"><a href="#3ã€å®‰è£…æ­£ç¡®çš„PyTorch-GPUç‰ˆæœ¬" class="headerlink" title="3ã€å®‰è£…æ­£ç¡®çš„PyTorch-GPUç‰ˆæœ¬"></a>3ã€å®‰è£…æ­£ç¡®çš„PyTorch-GPUç‰ˆæœ¬</h4><blockquote><p>æ¥ç€PyTorchç‰ˆæœ¬çš„å®‰è£…ï¼ˆå¦‚æœè‡ªå·±å–œæ¬¢ä½¿ç”¨TensorFlowæ¡†æ¶ï¼Œå°±æ²¡å¿…è¦å®‰è£…PyTorchæ¡†æ¶äº†ï¼‰,åˆ°<a href="https://pytorch.org/">PyTorchçš„å®˜ç½‘</a>å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ‰¾åˆ°è‡ªå·±éœ€è¦çš„PyTorchç‰ˆæœ¬ï¼Œæˆ‘ç”¨çš„æ˜¯CUDA 9.0ç‰ˆæœ¬ã€‚</p><p>PS:ç§ä»¥ä¸ºPyTorchå®‰è£…è¦æ¯”TensorFlowç®€å•äº›ï¼Ÿï¼Ÿï¼Ÿ</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#cudatoolkit=9.0è¡¨ç¤ºç”¨çš„æ˜¯cuda 9.0çš„åŒ…ï¼ˆä¸åƒtensorflowè¿˜éœ€è¦å¯¹åº”å„ç§ç‰ˆæœ¬ï¼Œç›´æ¥åœ¨å®˜ç½‘æ‰¾åˆ°cuda 9.0å¯¹åº”çš„å®‰è£…ä»£ç å°±è¡Œäº†ï¼‰</span>conda install pytorch<span class="token operator">==</span><span class="token number">1.1</span><span class="token number">.0</span> torchvision<span class="token operator">==</span><span class="token number">0.3</span><span class="token number">.0</span> cudatoolkit<span class="token operator">=</span><span class="token number">9.0</span> <span class="token operator">-</span>c pytorch  <span class="token comment">#å®‰è£…æˆåŠŸåè¿›å…¥pythonç¯å¢ƒä¸­éªŒè¯ä¸€ä¸‹</span>python<span class="token keyword">import</span> torch<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#ç»“æœä¸ºTrueå°±è¯´æ˜æˆåŠŸäº†</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="14.png" alt="å›¾14 pytorchå®‰è£…æˆåŠŸå›¾"></p><h3 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h3><blockquote><p>æˆ‘æ„Ÿè§‰æ€»çš„æµç¨‹è¿˜æ˜¯ç®—æ¯”è¾ƒç®€å•çš„ï¼ŒAnacondaè´Ÿè´£åŒ…çš„ç®¡ç†ï¼ŒCUDAè´Ÿè´£GPUçš„åŠ é€Ÿå¤„ç†ï¼Œä½†TensorFlowå’ŒPyTorchçš„å®‰è£…åŒ…é‡Œé¢éƒ½æ˜¯è‡ªå¸¦äº†ç®€åŒ–çš„CUDA toolkitï¼Œæ‰€ä»¥åªéœ€è¦æ ¹æ®è‡ªå·±ç”µè„‘çš„æ˜¾å¡é©±åŠ¨ç‰ˆæœ¬ï¼Œç¡®å®šè‡ªå·±ç”µè„‘èƒ½ä½¿ç”¨çš„Tensoflowæˆ–è€…PyTorchåŒ…è¿›è¡Œå®‰è£…å°±è¡Œäº†ï¼Œä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨å®‰è£…CUDAå’ŒcuDNNï¼</p><p>å› ä¸ºç”Ÿæ´»ä¸­ç»å¸¸æœ‰å°ä¼™ä¼´é—®æˆ‘è¿™äº›é—®é¢˜ï¼ŒåŠ ä¸Šä¹‹å‰åœ¨å®‰è£…æ·±åº¦å­¦ä¹ GPUç¯å¢ƒä¸Šä¹Ÿè¸©è¿‡å¾ˆå¤šçš„å‘ï¼Œæ‰€ä»¥æˆ‘å°±è®°å½•æˆä¸€ç¯‡åšå®¢å¸Œæœ›å¯¹æœ‰åŒæ ·éœ€æ±‚çš„å°ä¼™ä¼´æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿è¯„è®ºåŒºæ‹ç –ï¼ï¼ï¼ï¼Œå¦‚æœå¯¹Ubuntuä¸Šå®‰è£…æ·±åº¦å­¦ä¹ ç¯å¢ƒæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒæˆ‘å¦ä¸€ç¯‡åšå®¢ã€‚</p><p>ç å­—ä¸æ˜“ï¼Œå¦‚æœå¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œéº»çƒ¦ç‚¹ä¸ªèµå†èµ°å§:)</p><p>æœªç»è®¸å¯ï¼Œè¯·å‹¿éšæ„è½¬è½½ï¼</p></blockquote><p>å‚è€ƒï¼š</p><p><a href="https://www.jianshu.com/p/d3b9419a0f89">https://www.jianshu.com/p/d3b9419a0f89</a></p><p><a href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html">https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html</a></p><p><a href="https://www.tensorflow.org/install/source#common_installation_problems">https://www.tensorflow.org/install/source#common_installation_problems</a></p><p><a href="https://www.cnblogs.com/tianlang25/p/12433025.html">https://www.cnblogs.com/tianlang25/p/12433025.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> æ·±åº¦å­¦ä¹  </tag>
            
            <tag> ç¯å¢ƒæ­å»º </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‰ç«¯Ajaxä¼ é€æ•°æ®ï¼ŒSpring bootæ­çš„åå°èƒ½æ¥å—ï¼Œä½†æ•°æ®ä¸èƒ½æˆåŠŸè¿”å›å‰ç«¯</title>
      <link href="/2020/06/28/qian-duan-ajax-chuan-song-shu-ju-spring-boot-da-de-hou-tai-neng-jie-shou-dan-shu-ju-bu-neng-cheng-gong-fan-hui-qian-duan/"/>
      <url>/2020/06/28/qian-duan-ajax-chuan-song-shu-ju-spring-boot-da-de-hou-tai-neng-jie-shou-dan-shu-ju-bu-neng-cheng-gong-fan-hui-qian-duan/</url>
      
        <content type="html"><![CDATA[<h3 id="ä¸€ã€é—®é¢˜æè¿°"><a href="#ä¸€ã€é—®é¢˜æè¿°" class="headerlink" title="ä¸€ã€é—®é¢˜æè¿°"></a>ä¸€ã€é—®é¢˜æè¿°</h3><blockquote><p>æˆ‘ä½¿ç”¨çš„æ˜¯<a href="https://so.csdn.net/so/search?q=Ajax&amp;spm=1001.2101.3001.7020">Ajax</a>å‰ç«¯ä¼ æ•°æ®ç»™ç”¨Spring bootæ¡†æ¶æ­çš„åå°ï¼Œåå°å¯ä»¥æ¥å—åˆ°æ•°æ®ï¼Œä½†æ˜¯è¿”å›åˆ°å‰ç«¯æ—¶ä¸èƒ½è¿›å…¥Ajaxçš„successçš„å‡½æ•°é‡Œé¢ï¼Œè€Œæ˜¯æ‰§è¡Œçš„errorå‡½æ•°é‡Œçš„å†…å®¹ã€‚</p></blockquote><p>å‰ç«¯Ajaxä»£ç </p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//ç‚¹å‡»äº‹ä»¶ï¼Œå½“å‰ç«¯çš„æ ‡ç­¾è¢«ç‚¹å‡»æ—¶è¿›è¡Œajaxä¸åç«¯äº¤äº’</span><span class="token keyword">function</span> <span class="token function">navbarClick</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>        <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"post"</span><span class="token punctuation">,</span>        <span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">"http://localhost:8080/operator"</span><span class="token punctuation">,</span>        <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span>            <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token comment">//äº¤äº’çš„è¿”å›æ•°æ®ç±»å‹ä¸ºjson</span>        <span class="token literal-property property">dataType</span><span class="token operator">:</span><span class="token string">"json"</span><span class="token punctuation">,</span>        <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token function">alert</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token function-variable function">error</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"å‡ºé”™å•¦orz!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//å¦‚æœåç«¯æˆåŠŸè¿”å›æ•°æ®ï¼Œé‚£ä¹ˆå‰ç«¯æˆåŠŸæ¥æ”¶ä¹‹ååº”è¯¥æ‰§è¡Œalert()å¼¹æ¡†æ˜¾ç¤ºè¿”å›çš„å†…å®¹ã€‚</span><span class="token comment">//å¦‚æœå‰ç«¯æœªèƒ½æˆåŠŸæ¥æ”¶ï¼Œé‚£ä¹ˆå‰ç«¯åº”è¯¥alert()å¼¹çª—æ˜¾ç¤º"å‡ºé”™å•¦orz!!!"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åç«¯çš„controllerä¸­çš„éƒ¨åˆ†ä»£ç </p><pre class="line-numbers language-java" data-language="java"><code class="language-java">     <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/operator"</span><span class="token punctuation">)</span>    <span class="token annotation punctuation">@ResponseBody</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">Operator</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> type<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å·²ç»åˆ°äº†åå°,æ¥æ”¶çš„æ•°æ®ä¸º:"</span><span class="token operator">+</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">"çš®çš®è™¾ï¼Œæˆ‘ä»¬èµ°!!!"</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> str<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">//åç«¯æˆåŠŸæ¥å—æ•°æ®ï¼Œå°†ä¼šåœ¨åå°æ‰“å°"å·²ç»åˆ°äº†åå°,æ¥æ”¶çš„æ•°æ®ä¸º:"å“ˆå“ˆå“ˆå“ˆå“ˆ"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>å½“æˆ‘å‰ç«¯æ‰§è¡Œç‚¹å‡»äº‹ä»¶åï¼Œåå°èƒ½å¤ŸæˆåŠŸæ¥æ”¶å‰ç«¯æ•°æ®ï¼Œå‰ç«¯æ˜¾ç¤ºå¾—åˆ°çš„ç»“æœå¼¹çª—æ˜¾ç¤ºæ˜¯â€å‡ºé”™å•¦orz!!!â€</p></blockquote><p><img src="1.png" alt="å›¾1 åå°è¾“å‡ºå›¾"></p><p><img src="2.png" alt="å›¾2 å‰å°bugæ˜¾ç¤ºå›¾"></p><blockquote><p>WTF???  æˆ‘åå°Controlleréƒ¨åˆ†åŠ ä¸Šäº†@ResponseBodyæ³¨è§£ï¼Œæˆ‘çœ‹å¥½å¤šåšå®¢è¯´Spring boot<a href="https://so.csdn.net/so/search?q=%E6%A1%86%E6%9E%B6&amp;spm=1001.2101.3001.7020">æ¡†æ¶</a>ä¸­åŠ äº†@ResponseBodyæ³¨è§£ä¹‹åä¼šå°†å‡½æ•°è¿”å›çš„å†…å®¹è½¬åŒ–ä¸ºjsonæ ¼å¼ï¼Œè€Œä¸”æˆ‘å‰ç«¯Ajaxä¸­è®¾ç½®çš„dataTypeæ¥å—ç±»å‹ä¹Ÿæ˜¯â€jsonâ€ã€‚</p></blockquote><h3 id="äºŒã€è§£å†³æ–¹æ³•"><a href="#äºŒã€è§£å†³æ–¹æ³•" class="headerlink" title="äºŒã€è§£å†³æ–¹æ³•"></a>äºŒã€è§£å†³æ–¹æ³•</h3><blockquote><p>æœ€åæˆ‘çš„è§£å†³æ–¹æ³•æ˜¯ï¼Œå°†å‰ç«¯Ajaxä»£ç ä¸­çš„dataTypeç±»å‹è®¾ç½®ä¸ºâ€htmlâ€æˆ–è€…â€textâ€,å‰ç«¯å°±èƒ½å¤ŸæˆåŠŸæ¥æ”¶äº†å›§rzã€‚</p></blockquote><p><img src="3.png" alt="å›¾3 åå°ä¿®æ”¹å›¾"></p><p><img src="4.png" alt="å›¾4 å‰å°æˆåŠŸæ˜¾ç¤ºå›¾"></p><h3 id="ä¸‰ã€æ€»ç»“"><a href="#ä¸‰ã€æ€»ç»“" class="headerlink" title="ä¸‰ã€æ€»ç»“"></a>ä¸‰ã€æ€»ç»“</h3><blockquote><p>å‰ç«¯ä¸èƒ½æˆåŠŸæ¥æ”¶æ•°æ®åº”è¯¥æ˜¯å› ä¸ºæˆ‘åç«¯è¿”å›çš„æ•°æ®ç±»å‹ï¼ˆå‡½æ•°çš„è¿”å›å€¼ç±»å‹æ˜¯Stringï¼‰å’Œå‰ç«¯æ¥æ”¶çš„æ•°æ®ç±»å‹(dataTypeè®¾ç½®çš„ä¸ºjson)ä¸ä¸€è‡´å§ï¼Œä½†æ˜¯ç½‘ä¸Šå¾ˆå¤šåšå®¢è¯´åç«¯åŠ ä¸Š@ResponseBodyæ³¨è§£æ˜¯èƒ½è‡ªåŠ¨å°†è¿”å›ç±»å‹è½¬åŒ–ä¸ºjsonç±»å‹ï¼Œé‚£æˆ‘å‰ç«¯è®¾ç½®çš„dataTypeä¸ºjsonåº”è¯¥ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„å§å›§rzã€‚</p><p>æ€»ä¹‹å°±æ˜¯è¿·æƒ‘è¡Œä¸ºï¼Œå¦‚æœä½ çš„åç«¯è¿”å›å€¼ç±»å‹ä¸ºStringï¼Œå‰ç«¯Ajaxéƒ¨åˆ†å°†dataTypeæ”¹æˆäº†htmlæˆ–è€…textè¿˜æ˜¯ä¸è¡Œï¼Œå¯ä»¥å°è¯•å°†IDEé‡å¯ï¼Œæˆ–è€…å°†ç”µè„‘é‡å¯ï¼Œå†è¯•ä¸€ä¸‹ï¼Œåæ­£æˆ‘ç”¨çš„IDEAç»å¸¸ä¿®æ”¹äº†htmlé¡µé¢ï¼Œé‡å¯æœåŠ¡ä¹‹åé¡µé¢æ˜¾ç¤ºçš„å†…å®¹è¿˜æ˜¯æ²¡æœ‰ä¿®æ”¹ä¹‹å‰çš„ï¼Œå¾—é‡å¯ç¨‹åºæ‰è¡Œï¼Œç„å­¦æ•‘æˆ‘ï¼ï¼ï¼</p><p>PSï¼šè¡¥å……ï¼Œåé¢å‘ç°æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ä¹‹åï¼Œå°±ä¸å­˜åœ¨é‡å¯åç«¯æœåŠ¡åä¹‹å‰æ›´æ”¹çš„htmlé¡µé¢ä¸ç”Ÿæ•ˆçš„é—®é¢˜äº†ï¼ŒChromeçš„æ¸…é™¤ç¼“å­˜å¿«æ·é”®æ˜¯ctrl+shift+deleteã€‚</p><p>å› ä¸ºæˆ‘ä¹Ÿæ˜¯åˆšåˆšæ¥è§¦Spring bootè¿™ä¸€å—ï¼Œè‡ªå·±ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šä¸€äº›ç»†èŠ‚ï¼Œæ‰€ä»¥å°†è¿™ä¸ªé—®é¢˜è®°å½•ä¸‹æ¥ï¼Œå¸Œæœ›å¯¹æœ‰åŒæ ·é—®é¢˜çš„äººæœ‰æ‰€å¸®åŠ©ï¼</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> bug </tag>
            
            <tag> java </tag>
            
            <tag> SpringBoot </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
